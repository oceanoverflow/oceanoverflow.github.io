<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Whyyy</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://oceanoverflow.github.io/"/>
  <updated>2018-06-17T08:27:47.804Z</updated>
  <id>https://oceanoverflow.github.io/</id>
  
  <author>
    <name>Yangyi, Yi</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>World Cup</title>
    <link href="https://oceanoverflow.github.io/2018/06/17/WorldCup/"/>
    <id>https://oceanoverflow.github.io/2018/06/17/WorldCup/</id>
    <published>2018-06-17T07:18:49.000Z</published>
    <updated>2018-06-17T08:27:47.804Z</updated>
    
    <content type="html"><![CDATA[<h1 id="World-Cup"><a href="#World-Cup" class="headerlink" title="World Cup"></a>World Cup</h1><p>å››å¹´ä¸€åº¦çš„ä¸–ç•Œæ¯æœ€è¿‘æ­£åœ¨ä¿„ç½—æ–¯å¦‚ç«å¦‚è¼çš„è¿›è¡Œï¼Œæ˜¨å¤©çœ‹äº†è¥¿ç­ç‰™ğŸ‡ªğŸ‡¸å¯¹è‘¡è„ç‰™ğŸ‡µğŸ‡¹çš„æ¯”èµ›ï¼ŒCç½—çœŸçš„æ˜¯å¤ªå¸…äº†ï¼Œå¸½å­æˆæ³•ï¼Œä¸è¿‡ä½œä¸ºä¸€ä¸ªä¼ªçƒè¿·-çœŸç¨‹åºå‘˜ï¼Œå‡†å¤‡å†™ä¸€ç‚¹å’Œä¸–ç•Œæ¯æœ‰å…³çš„ä¸œè¥¿ï¼Œæƒ³æƒ³ç”¨æœºå™¨å­¦ä¹ é¢„æµ‹æ¯”èµ›ç»“æœå¥½åƒå¹¶æ²¡æœ‰ä»€ä¹ˆåµç”¨ï¼Œäºæ˜¯å°±å†™ä¸€ä¸ªæœ€ç®€å•çš„æ¬ç –ç¨‹åºæ¥æé†’è‡ªå·±æ¯”èµ›æ—¶é—´å§ã€‚æœ€ç»ˆæ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼Œå…¸å‹çš„ <code>MVC</code> ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Costa Rica                       <span class="number">0</span> - <span class="number">0</span>                           Serbia</span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line">âš½  Will be played <span class="number">4</span> hours from now</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Germany                          <span class="number">0</span> - <span class="number">0</span>                           Mexico</span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line">âš½  Will be played <span class="number">7</span> hours from now</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Brazil                           <span class="number">0</span> - <span class="number">0</span>                      Switzerland</span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line">âš½  Will be played <span class="number">10</span> hours from now</span><br></pre></td></tr></table></figure><h2 id="Model"><a href="#Model" class="headerlink" title="Model"></a>Model</h2><p>æ¯”èµ›ç›¸å…³çš„æ•°æ®å¯ä»¥ä» <code>http://worldcup.sfg.io/</code> è·å–ï¼Œæˆ‘ä»¬ä½¿ç”¨ç»“æ„ä½“å®šä¹‰æ•°æ®æ¨¡å‹ï¼Œæ³¨æ„ç»“æ„ä½“ä¸­çš„æ•°æ®å­—æ®µå¿…é¡»ä¸ºå¤§å†™ï¼Œå¦åˆ™æ— æ³•æ­£ç¡® <code>Unmarshal</code>ï¼Œå¦‚æœæƒ³è¦ä½¿ç»“æ„ä½“ä¸­çš„å­—æ®µä¸ <code>json</code> ä¸­çš„å­—æ®µä¸åŒï¼Œå¯ä»¥é¢å¤–å¢åŠ  <code>tag</code> æ¥è¯´æ˜ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> match <span class="keyword">struct</span> &#123;</span><br><span class="line">    Time     <span class="keyword">string</span> <span class="string">`json:"time,omitempty"`</span></span><br><span class="line">    DateTime <span class="keyword">string</span> <span class="string">`json:"datetime,omitempty"`</span></span><br><span class="line">    HomeTeam team   <span class="string">`json:"home_team,ommitempty"`</span></span><br><span class="line">    AwayTeam team   <span class="string">`json:"away_team,omitempty"`</span></span><br><span class="line">    Winner   <span class="keyword">string</span> <span class="string">`json:"winner,omitempty"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> team <span class="keyword">struct</span> &#123;</span><br><span class="line">    Country <span class="keyword">string</span> <span class="string">`json:"country,omitempty"`</span></span><br><span class="line">    Code    <span class="keyword">string</span> <span class="string">`json:"code,omitempty"`</span></span><br><span class="line">    Goals   <span class="keyword">int</span>    <span class="string">`json:"goals,omitempty"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fetch</span><span class="params">(endpoint)</span> <span class="params">([]match, error)</span></span> &#123;</span><br><span class="line">    url := fmt.Sprintf(<span class="string">"http://worldcup.sfg.io/%s"</span>, endpoint)</span><br><span class="line">    res, err := http.Get(url)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> res.Body.Close()</span><br><span class="line">    b, err := ioutil.ReadAll(res.Body)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> matches []match</span><br><span class="line">    err = json.Unmarshal(b, &amp;matches)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> matches, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="View"><a href="#View" class="headerlink" title="View"></a>View</h2><p>å› ä¸ºæˆ‘ä»¬çš„ <code>layout</code> ç›¸å¯¹æ¯”è¾ƒå¤æ‚ï¼Œæ‰€ä»¥ <code>View</code> éƒ¨åˆ†ä»£ç ä¹Ÿæœ€å¤šï¼Œä½†éš¾åº¦ä¸å¤§ï¼Œå°±æ˜¯ç¹çï¼Œä¸»è¦æ³¨æ„å‡ ç‚¹ï¼Œå½©è‰²å­—ä½“è¾“å‡ºï¼Œä¸åŒæƒ…å†µä¸‹è¿›åº¦æ¡çš„å±•ç¤ºæ•ˆæœå’Œå„ä¸ªå­—æ®µæ‰€åœ¨çš„ä½ç½®ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> status <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    PAST status = <span class="literal">iota</span></span><br><span class="line">    NOW</span><br><span class="line">    FUTURE</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ScreenWidth = <span class="number">72</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    START = <span class="string">"\x1b[32m"</span></span><br><span class="line">    END   = <span class="string">"\x1b[0m"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">colorize</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> START + s + END</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">multiply</span><span class="params">(c <span class="keyword">rune</span>, n <span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> cs []<span class="keyword">rune</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</span><br><span class="line">        cs = <span class="built_in">append</span>(cs, c)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">string</span>(cs)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">prettify</span><span class="params">(m match)</span> <span class="title">string</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    t, _ := time.Parse(time.RFC3339, m.DateTime)</span><br><span class="line">    diff := <span class="keyword">int</span>(time.Now().Sub(t).Seconds())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> status status</span><br><span class="line">    <span class="keyword">switch</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> diff &gt; <span class="number">60</span>*<span class="number">90</span>:</span><br><span class="line">        status = PAST</span><br><span class="line">    <span class="keyword">case</span> diff &lt; <span class="number">0</span>:</span><br><span class="line">        status = FUTURE</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        status = NOW</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    percentage := <span class="number">0</span></span><br><span class="line">    matchStatus := <span class="string">""</span></span><br><span class="line">    on := <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> status &#123; </span><br><span class="line">    <span class="keyword">case</span> PAST:</span><br><span class="line">        percentage = <span class="number">100</span></span><br><span class="line">        <span class="keyword">var</span> result <span class="keyword">string</span></span><br><span class="line">        <span class="keyword">if</span> m.Winner == <span class="string">"Draw"</span> &#123;</span><br><span class="line">            result = <span class="string">"Draw"</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result = fmt.Sprintf(<span class="string">"%s won"</span>, m.Winner)</span><br><span class="line">        &#125;</span><br><span class="line">        matchStatus = fmt.Sprintf(<span class="string">"Played %s. %s"</span>, humanize.Time(t), result)</span><br><span class="line">        on = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">case</span> NOW:</span><br><span class="line">        percentage = <span class="keyword">int</span>(diff / <span class="number">60</span> / <span class="number">90</span> * <span class="number">100</span>)</span><br><span class="line">        matchStatus = fmt.Sprintf(<span class="string">"Being played now: %s minutes gone"</span>, humanize.Time(t))</span><br><span class="line">        on = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">case</span> FUTURE:</span><br><span class="line">        percentage = <span class="number">0</span></span><br><span class="line">        matchStatus = fmt.Sprintf(<span class="string">"Will be played %s"</span>, humanize.Time(t))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    home := m.HomeTeam</span><br><span class="line">    away := m.AwayTeam</span><br><span class="line"></span><br><span class="line">    s, e := <span class="string">""</span>, <span class="string">""</span></span><br><span class="line">    <span class="keyword">if</span> on &#123;</span><br><span class="line">        s = start</span><br><span class="line">        e = end</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">"    %s%-32s %d - %d %32s%s\n    %s\n    \u26BD  %s\n"</span>,</span><br><span class="line">        s,home.Country,home.Goals,away.Goals,away.Country,e,</span><br><span class="line">        progressBar(percentage),</span><br><span class="line">        matchStatus,</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">progressBar</span><span class="params">(percentage <span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> bar <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> percentage &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        bar = multiply(<span class="string">'-'</span>, ScreenWidth)</span><br><span class="line">    <span class="keyword">case</span> <span class="number">100</span>:</span><br><span class="line">        bar = colorize(multiply(<span class="string">'-'</span>, ScreenWidth))</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        completed := <span class="keyword">int</span>(<span class="keyword">float64</span>(ScreenWidth) / <span class="number">100.0</span> * <span class="keyword">float64</span>(percentage))</span><br><span class="line">        bar = colorize(multiply(<span class="string">'-'</span>, completed<span class="number">-1</span>)+<span class="string">"o"</span>) + multiply(<span class="string">'-'</span>, ScreenWidth-completed)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bar</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h2><p><code>Controller</code> éƒ¨åˆ†å°±æ˜¯å°† <code>Model</code> éƒ¨åˆ†å’Œ <code>view</code> éƒ¨åˆ†ä»£ç æ•´åˆåœ¨ä¸€èµ·ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    matches, err := fetch(<span class="string">"matches/today"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> i, match := <span class="keyword">range</span> matches &#123;</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">0</span> &#123;</span><br><span class="line">            fmt.Println()</span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Println(prettify(match))</span><br><span class="line">        <span class="keyword">if</span> i != <span class="built_in">len</span>(matches)<span class="number">-1</span> &#123;</span><br><span class="line">            fmt.Println()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;World-Cup&quot;&gt;&lt;a href=&quot;#World-Cup&quot; class=&quot;headerlink&quot; title=&quot;World Cup&quot;&gt;&lt;/a&gt;World Cup&lt;/h1&gt;&lt;p&gt;å››å¹´ä¸€åº¦çš„ä¸–ç•Œæ¯æœ€è¿‘æ­£åœ¨ä¿„ç½—æ–¯å¦‚ç«å¦‚è¼çš„è¿›è¡Œï¼Œæ˜¨å¤©çœ‹äº†è¥¿ç­ç‰™ğŸ‡ªğŸ‡¸å¯¹è‘¡è„ç‰™ğŸ‡µğŸ‡¹
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Snappy</title>
    <link href="https://oceanoverflow.github.io/2018/06/15/Snappy/"/>
    <id>https://oceanoverflow.github.io/2018/06/15/Snappy/</id>
    <published>2018-06-15T09:00:01.000Z</published>
    <updated>2018-06-15T09:03:56.608Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Snappy"><a href="#Snappy" class="headerlink" title="Snappy"></a>Snappy</h1><p><code>Snappy</code> æ˜¯ <code>Google</code> å¼€å‘çš„å‹ç¼©å’Œè§£å‹ç¼©çš„åº“ï¼Œæœ€åˆä½¿ç”¨ <code>C++</code> ç¼–å†™ï¼Œåæ¥åˆé€ äº†ä¸€ä¸ª <code>golang</code> ç‰ˆæœ¬çš„è½®å­ã€‚ç”±äºç›®å‰è¯¥å‹ç¼©ç®—æ³•è¿˜æ²¡æœ‰æ”¾åˆ° <code>go</code> çš„æ ‡å‡†åº“ä¸­å»ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡ <code>go get -u github.com/golang/snappy</code> å®‰è£…ã€‚</p><p>ä¸å…¶ä»–å¸¸è§çš„å‹ç¼©ç®—æ³•ç›¸æ¯”ï¼Œ<code>Snappy</code> å­˜åœ¨çš„ç›®çš„å¹¶ä¸æ˜¯ä¸ºäº†è·å¾—æœ€å¤§ç¨‹åº¦çš„å‹ç¼©æ¯”ï¼Œæ­£å¦‚å…¶åå­—æ‰€è¨€ï¼Œå®ƒæ—¨åœ¨ä¿æŒåˆç†çš„å‹ç¼©æ¯”çš„åŒæ—¶æœ€å¤§é™åº¦åœ°æé«˜å‹ç¼©å’Œè§£å‹ç¼©çš„é€Ÿåº¦ã€‚</p><p><code>Snappy</code> å¯¹æ•°æ®å¤„ç†é€Ÿåº¦ä¸Šåšäº†å¾ˆå¤§çš„ä¼˜åŒ–ï¼Œä½†å®ƒå¹¶ä¸æ˜¯æ²¡æœ‰ç¼ºç‚¹ï¼Œç›¸å¯¹äºå…¶ä»–ç®—æ³•æ¥è¯´ï¼Œ<code>Snappy</code> å‹ç¼©å¾—åˆ°çš„æ–‡ä»¶ä½“ç§¯ä¼šæ›´å¤§ä¸€ç‚¹ã€‚å¦‚æœä½ æ›´åœ¨æ„å‹ç¼©é€Ÿåº¦è€Œä¸æ˜¯å‹ç¼©æ¯”çš„è¯ï¼Œ<code>Snappy</code> å¯èƒ½ä¼šæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚</p><h2 id="compression"><a href="#compression" class="headerlink" title="compression"></a>compression</h2><p>ä¸‹é¢ï¼Œæˆ‘ä»¬å¯¹æ¯”ä¸€ä¸‹ <code>Snappy</code> å‹ç¼©ç®—æ³•å’Œå…¶ä»–ä¸¤ç§å¸¸è§çš„å‹ç¼©ç®—æ³•ï¼ˆ <code>zlib</code> å’Œ <code>gzip</code> ï¼‰çš„æ€§èƒ½ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¸€ä¸ª <code>Compressor</code> æ¥å£ï¼Œå¹¶ä½¿ <code>Zlib</code> ï¼Œ<code>Gzip</code> å’Œ <code>Snappy</code> è¿™ä¸‰ä¸ªç»“æ„ä½“å‡å®ç°å®ƒã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Zlib <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"><span class="keyword">type</span> Gzip <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"><span class="keyword">type</span> Snappy <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Compressor <span class="keyword">interface</span> &#123;</span><br><span class="line">    Compress(io.Writer, io.Reader) error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="zlib"><a href="#zlib" class="headerlink" title="zlib"></a>zlib</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(_ *Zlib)</span> <span class="title">Compress</span><span class="params">(w io.Writer, r io.Reader)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    zw, err := zlib.NewWriterLevel(w, zlib.BestSpeed)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> zw.Close()</span><br><span class="line"></span><br><span class="line">    _, err = io.Copy(zw, r)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="gzip"><a href="#gzip" class="headerlink" title="gzip"></a>gzip</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(_ *Gzip)</span> <span class="title">Compress</span><span class="params">(w io.Writer, r io.Reader)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    gw, err := gzip.NewWriterLevel(w, gzip.BestSpeed)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> gw.Close()</span><br><span class="line"></span><br><span class="line">    _, err = io.Copy(gw, r)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="snappy"><a href="#snappy" class="headerlink" title="snappy"></a>snappy</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(_ *Snappy)</span> <span class="title">compress</span><span class="params">(w io.Writer, r io.Reader)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    sw := snappy.NewBufferedWriter(w)</span><br><span class="line">    <span class="keyword">defer</span> sw.Close()</span><br><span class="line"></span><br><span class="line">    _, err := io.Copy(sw, r)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="performance"><a href="#performance" class="headerlink" title="performance"></a>performance</h2><p>å¯¹äºå‹ç¼©çš„æ€§èƒ½ï¼Œå¯ä»¥ä»å‹ç¼©æ¯”å’Œå‹ç¼©æ—¶é—´è¿™ä¸¤ç‚¹è¿›è¡Œè¡¡é‡ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    f, err := os.Open(<span class="string">"somebigfile"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fGzip, _ := os.Create(<span class="string">"gzip"</span>)</span><br><span class="line">    fZlib, _ := os.Create(<span class="string">"zlib"</span>)</span><br><span class="line">    fSnappy, _ := os.Create(<span class="string">"snappy"</span>)</span><br><span class="line"></span><br><span class="line">    cs := <span class="keyword">map</span>[compressor]io.Writer&#123;</span><br><span class="line">        &amp;Gzip&#123;&#125;:   fGzip,</span><br><span class="line">        &amp;Zlib&#123;&#125;:   fZlib,</span><br><span class="line">        &amp;Snappy&#123;&#125;: fSnappy,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> c, v := <span class="keyword">range</span> cs &#123;</span><br><span class="line">        t := time.Now()</span><br><span class="line">        err := c.compress(v, f)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Println(err)</span><br><span class="line">        &#125;</span><br><span class="line">        d := time.Since(t)</span><br><span class="line">        fmt.Printf(<span class="string">"method: %s, time spend: %.02f, ratio: %.05f%%\n"</span>, </span><br><span class="line">        v.Name(), </span><br><span class="line">        d.Seconds(), </span><br><span class="line">        compressionRatio(f, v))</span><br><span class="line">        f.Seek(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">compressionRatio</span><span class="params">(f1, f2 *os.File)</span> <span class="title">float64</span></span> &#123;</span><br><span class="line">    f1s, _ := f1.Stat()</span><br><span class="line">    f1size := f1s.Size()</span><br><span class="line">    f2s, _ := f2.Stat()</span><br><span class="line">    f2size := f2s.Size()</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">float64</span>(f2size) / <span class="keyword">float64</span>(f1size) * <span class="number">100</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Snappy</code> åœ¨é€Ÿåº¦ä¸Šæ¥è¯´æ¯” <code>zlib</code> å’Œ <code>gzip</code> å¿«å¾—å¤šï¼Œä½†æ–‡ä»¶ç›¸å¯¹è¦å¤§ <code>20%</code> åˆ° <code>100%</code>ã€‚åœ¨ <code>64</code> ä½æ¨¡å¼çš„ <code>Core i7</code> å¤„ç†å™¨ä¸Šï¼Œ<code>Snappy</code> å¯ä»¥è¾¾åˆ° <code>250~500</code> å…†æ¯ç§’çš„å‹ç¼©é€Ÿåº¦ï¼Œå¯ä»¥è¯´æ˜¯éå¸¸æƒŠäººäº†ã€‚ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line">method:   gzip, time spend: 8.38s, ratio:  7.576%</span><br><span class="line">method:   zlib, time spend: 9.13s, ratio:  7.576%</span><br><span class="line">method: snappy, time spend: 1.96s, ratio: 18.813%</span><br></pre></td></tr></table></figure><p>ç›¸æ¯”å…¶ä»–çš„å‹ç¼©åº“ï¼Œ<code>Snappy</code> èƒ½åœ¨ä¿æŒç‰¹å®šçš„å‹ç¼©ç‡ä¸‹æ‹¥æœ‰æƒŠäººçš„å‹ç¼©é€Ÿåº¦ï¼Œå‹ç¼©æ™®é€šæ–‡æœ¬æ–‡ä»¶çš„é€Ÿåº¦æ˜¯å…¶ä»–åº“çš„ <code>1.5-1.7</code> å€ï¼ŒHTMLèƒ½è¾¾åˆ° <code>2-4</code> å€ï¼Œä½†æ˜¯å¯¹äº <code>JPEG</code>ã€<code>PNG</code> ä»¥åŠå…¶ä»–çš„å·²å‹ç¼©çš„æ•°æ®ï¼Œå‹ç¼©é€Ÿåº¦ä¸ä¼šæœ‰æ˜æ˜¾æ”¹å–„ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Snappy&quot;&gt;&lt;a href=&quot;#Snappy&quot; class=&quot;headerlink&quot; title=&quot;Snappy&quot;&gt;&lt;/a&gt;Snappy&lt;/h1&gt;&lt;p&gt;&lt;code&gt;Snappy&lt;/code&gt; æ˜¯ &lt;code&gt;Google&lt;/code&gt; å¼€å‘çš„å‹ç¼©å’Œè§£å‹ç¼©çš„åº“ï¼Œ
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Timing Wheel</title>
    <link href="https://oceanoverflow.github.io/2018/06/14/TimingWheel/"/>
    <id>https://oceanoverflow.github.io/2018/06/14/TimingWheel/</id>
    <published>2018-06-14T01:20:25.000Z</published>
    <updated>2018-06-14T01:47:52.623Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Timing-Wheel"><a href="#Timing-Wheel" class="headerlink" title="Timing Wheel"></a>Timing Wheel</h1><p><img src="https://www.confluent.io/wp-content/uploads/2016/08/TimingWheels1.png" alt="timingwheel"></p><p>å½“æˆ‘ä»¬è‡ªå·±ç¼–å†™æœåŠ¡ç«¯ç¨‹åºæ—¶å€™ï¼Œå¯èƒ½éœ€è¦æ–°å»ºå¤§é‡çš„å®šæ—¶å™¨ï¼Œå¯¹æ¯ä¸ª <code>TCP</code> è¿æ¥è®¾ç½®è¿æ¥è¶…æ—¶ï¼Œé¢å¯¹æˆåƒä¸Šä¸‡çš„å®¢æˆ·ç«¯è¿æ¥ï¼Œå¦‚æœå‚»å‚»åœ°ä¸ºæ¯ä¸€ä¸ªè¿æ¥åˆ†é…ä¸€ä¸ªè®¡æ—¶å™¨çš„è¯ï¼Œé‚£ä¹ˆ <code>10k</code> ä¸ªè¿æ¥å°±å¯¹åº” <code>10k</code> çš„è®¡æ—¶å™¨ï¼Œ<code>10w</code> ä¸ªè¿æ¥å°±å¯¹åº” <code>10w</code> ä¸ªè®¡æ—¶å™¨ï¼Œè¿™ç§æ–¹æ³•æ˜¾ç„¶æ˜¯æ¯”è¾ƒæ¶ˆè€—å†…å­˜çš„ã€‚</p><p>å¯¹äºéœ€è¦å¤§é‡å®šæ—¶å™¨çš„æƒ…å†µï¼Œç”±äºè®¸å¤šå®šæ—¶å™¨æ˜¯åœ¨ç›¸è¿‘çš„æ—¶é—´è¶…æ—¶çš„ï¼Œæˆ–è€…è¯´åœ¨ä¸€ä¸ªæ—¶é—´èŒƒå›´å†…åˆ°æ—¶çš„ï¼Œå¦‚æœå¯¹æ—¶é—´ç²¾åº¦æ²¡æœ‰é‚£ä¹ˆè¿‘ä¹è‹›åˆ»çš„è¦æ±‚çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªç‰¹æ€§å°†å¤šä¸ªåŒä¸€æ—¶é—´æ®µçš„è®¡æ—¶å™¨æ•´åˆæˆä¸€ä¸ªæ¥ä½¿ç”¨ï¼Œè¿™æ ·çš„è¯å°±å¯ä»¥æå¤§ç¨‹åº¦ä¸Šé™ä½å†…å­˜çš„æ¶ˆè€—ï¼Œä¾‹å¦‚ç°åœ¨æœ‰ <code>3ï¼Œ4ï¼Œ5ï¼Œ6</code> å››ä¸ªè¿æ¥ï¼Œå®ƒä»¬å‡ä¼šåœ¨åé¢çš„3åˆ°4ç§’å†…è¶…æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä¸€ç§æ–¹æ³•ä½¿å®ƒä»¬å…±ç”¨ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå¹¶å½“æ—¶é—´ç‚¹åˆ°æ¥æ—¶ï¼Œå®ƒä»¬å‡å¯ä»¥è¢«é€šçŸ¥åˆ°ã€‚</p><h2 id="closed-channel"><a href="#closed-channel" class="headerlink" title="closed channel"></a>closed channel</h2><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæœºåˆ¶æ¥é‡å¤åˆ©ç”¨æŸä¸€ä¸ªè®¡æ—¶å™¨ï¼Œæ¢å¥è¯è¯´ï¼Œå½“æ—¶é—´ç‚¹åˆ°æ¥æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§å¹¿æ’­çš„æœºåˆ¶è®©ç­‰å¾…è¯¥è®¡æ—¶å™¨çš„éƒ½èƒ½è¢«é€šçŸ¥åˆ°ã€‚</p><p>ä¸ºæ­¤éœ€è¦åˆ©ç”¨ <code>golang</code> ä¸­é€šé“çš„å‡ ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥ç†è§£ä¸€ä¸‹ï¼Œåœ¨ä¸‹é¢çš„å‡½æ•°ä¸­ <code>make</code> äº†ä¸€ä¸ª <code>unbuffered channel</code> chï¼Œè¿˜æ–°èµ·äº†3ä¸ª <code>goroutine</code> ï¼Œæ¯ä¸ª<code>goroutine</code> ä¼šæ‰§è¡Œ <code>fmt.Println(&quot;start &quot;, i)</code> ï¼Œä½†ç­‰å®ƒä»¬éƒ½æ‰§è¡Œåˆ° <code>&lt;-ch</code> è¯­å¥æ—¶ï¼Œç”±äºæ²¡æœ‰å…¶ä»– <code>goroutine</code> æ‰§è¡Œ <code>ch &lt;- struct{}{}</code> æ“ä½œï¼Œæ‰€ä»¥3ä¸ª <code>goroutine</code> éƒ½ä¼šé˜»å¡ï¼Œå½“ <code>time.Sleep(1 * time.Second)</code> ç»“æŸæ—¶ï¼Œæˆ‘ä»¬åˆ©ç”¨ <code>close(ch)</code> ï¼Œæ­¤æ“ä½œç›¸å½“äºå‘æ¯ä¸ª <code>goroutine</code> è¿›è¡Œ <code>ch &lt;- struct{}{}</code> ï¼Œæ­¤æ—¶é˜»å¡è§£é™¤ï¼Œæ¯ä¸ª <code>goroutine</code> éƒ½å¯ä»¥ç»§ç»­æ‰§è¡Œ <code>fmt.Println(&quot;end &quot;, i)</code> ã€‚ä¹Ÿå°±æ˜¯è¯´ <code>close(ch)</code> ç›¸å½“äºä¸€ä¸ªå¹¿æ’­æ“ä½œã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ &#123;</span><br><span class="line">        i := i</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            fmt.Println(<span class="string">"start "</span>, i)</span><br><span class="line">            &lt;-ch</span><br><span class="line">            fmt.Println(<span class="string">"end "</span>, i)</span><br><span class="line">        &#125;()</span><br><span class="line">    &#125;</span><br><span class="line">    time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line">    <span class="built_in">close</span>(ch)</span><br><span class="line">    <span class="keyword">select</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä¾‹å­åˆ©ç”¨åˆ°äº†é€šé“çš„çš„ç¬¬ä¸€ä¸ªç‰¹æ€§å’Œç¬¬ä¸‰ä¸ªç‰¹æ€§ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. The expression blocks until a value is available. </span><br><span class="line">2. Receiving from a nil channel blocks forever. </span><br><span class="line">3. A receive operation on a closed channel can always proceed immediately, yielding the element typeâ€™s zero value after any previously sent values have been received.</span><br></pre></td></tr></table></figure><h2 id="timing-wheel"><a href="#timing-wheel" class="headerlink" title="timing wheel"></a>timing wheel</h2><p>é‚£ä¹ˆä¸Šé¢çš„ä¾‹å­å’Œæˆ‘ä»¬è¦å®ç°çš„ä¸œè¥¿æœ‰ä»€ä¹ˆè”ç³»å‘¢ï¼Œå…¶å®è”ç³»éå¸¸å¤§ï¼Œæˆ‘ä»¬å¯ä»¥ç»™æ¯ä¸€ä¸ªéœ€è¦è¿›è¡Œå®šæ—¶æ“ä½œçš„ <code>goroutine</code> ä¸€ä¸ª <code>unbuffered channel</code><br>ï¼Œå¹¶ä¸”ç»™äºˆåœ¨ç›¸åŒæ—¶é—´ç‚¹è¶…æ—¶çš„ <code>goroutine</code> ä»¥åŒæ ·çš„é€šé“ã€‚ç„¶åæˆ‘ä»¬è‡ªå·±ç»´æŠ¤ä¸€ä¸ª <code>ticker</code> ï¼Œè¿™ä¸ª <code>ticker</code> æ¯éš”å›ºå®šçš„æ—¶é—´ï¼Œå°†ç›¸åº”çš„é€šé“å…³é—­ï¼Œè¿™ç›¸å½“äºä¸€ä¸ªå¹¿æ’­æ“ä½œï¼Œè¿™æ ·æ¯ä¸ªç­‰å¾…æ­¤å¹¿æ’­çš„ <code>goroutine</code> éƒ½ä¼šæ”¶åˆ°æ¶ˆæ¯ï¼Œä¹Ÿå°±å¯ä»¥ç»§ç»­æ‰§è¡Œä¸‹å»äº†ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> TimingWheel <span class="keyword">struct</span> &#123;</span><br><span class="line">    sync.Mutex</span><br><span class="line"></span><br><span class="line">    interval   time.Duration</span><br><span class="line">    maxTimeout time.Duration </span><br><span class="line">    </span><br><span class="line">    ticker     *time.Ticker</span><br><span class="line">    cs         []<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">    pos        <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line">    stop       <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(interval time.Duration, buckets <span class="keyword">int</span>)</span> *<span class="title">TimingWheel</span></span> &#123;</span><br><span class="line">    w := &amp;TimingWheel&#123;</span><br><span class="line">        interval:   interval,</span><br><span class="line">        maxTimeout: interval * time.Duration(buckets),</span><br><span class="line">        ticker:     time.NewTicker(interval),</span><br><span class="line">        cs :        <span class="built_in">make</span>([]<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, buckets),</span><br><span class="line">        pos:        <span class="number">0</span>,</span><br><span class="line">        stop:       <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> w.cs &#123;</span><br><span class="line">        w.cs[i] = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">go</span> w.run()</span><br><span class="line">    <span class="keyword">return</span> w</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…‰è¯´å¯èƒ½æœ‰ä¸€ç‚¹æŠ½è±¡ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…·ä½“çš„å®ç°ï¼Œ<code>TimingWheel</code> ç»“æ„ä½“ç›¸å½“äºæ¨¡æ‹Ÿä¸€ä¸ªç§’è¡¨ï¼Œå…¶ä¸­çš„ <code>ticker</code> å°±ç›¸å½“äºä¸€ä¸ªç§’é’ˆï¼ŒåŒæ—¶æˆ‘ä»¬è¿˜ç»´æŠ¤äº†ä¸€ä¸ªé€šé“æ•°ç»„ <code>cs</code> ï¼ˆå…¶å­˜å‚¨ç»“æ„ä¸ºé¡ºåºå­˜å‚¨ï¼Œè€Œå…¶é€»è¾‘ç»“æ„åˆ™æ˜¯ä¸€ä¸ªåœ†ç¯ï¼‰ï¼Œä½œä¸ºå®šæ—¶å™¨ä½¿ç”¨ï¼Œ<code>ticker</code> æ¯éš”å›ºå®šçš„ <code>interval</code> ï¼Œä¼šè®©æŒ‡é’ˆå‘å‰ç§»åŠ¨ä¸€ä¸ªå•ä½ï¼ˆ <code>pos++</code> ï¼‰ï¼Œå¹¶å°†è¯¥ä½ç½®å­˜å‚¨çš„é€šé“å…³é—­ï¼Œä¹Ÿå°±ç›¸åŒäºå®šæ—¶å™¨è¿”å›ï¼Œè¿™ç§æ–¹æ³•å®ç°çš„å®šæ—¶å™¨ç›¸å¯¹æ¥è¯´å¢åŠ äº†å®šæ—¶å™¨çš„åˆ©ç”¨ç‡ï¼Œé™ä½äº†å†…å­˜çš„æ¶ˆè€—ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *TimingWheel)</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-w.ticker.C:</span><br><span class="line">            w.tick()</span><br><span class="line">        <span class="keyword">case</span> &lt;-w.stop:</span><br><span class="line">            w.ticker.Stop()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *TimingWheel)</span> <span class="title">tick</span><span class="params">()</span></span> &#123;</span><br><span class="line">    w.Lock()</span><br><span class="line">    last := w.cs[w.pos]</span><br><span class="line">    w.cs[w.pos] = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">     </span><br><span class="line">    w.pos = (w.pos + <span class="number">1</span>) % <span class="built_in">len</span>(w.cs)</span><br><span class="line">    w.Unlock()    </span><br><span class="line">    <span class="built_in">close</span>(last)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>After</code> æ–¹æ³•ä¸ºæˆ‘ä»¬æä¾›ä¸€ä¸ªå®šæ—¶å™¨ï¼Œå¦‚æœ <code>timeout</code> æ•°å€¼å¤ªå¤§æ— æ³•è½åœ¨ <code>timing wheel</code> çš„ä¸€ä¸ªå‘¨æœŸçš„æ—¶é—´èŒƒå›´å†…ï¼Œåˆ™æŠ¥é”™ï¼Œå¦‚æœ <code>timeout</code> åœ¨æ­£å¸¸èŒƒå›´å†…ï¼Œåˆ™è¿”å›å¯¹åº”ä½ç½®çš„é€šé“ï¼Œå½“è¯¥é€šé“è¶…æ—¶æ—¶ï¼Œä¸Šé¢çš„ <code>tick</code> æ–¹æ³•å°±ä¼šå°†è¯¥é€šé“å…³é—­ï¼Œç›¸åº”çš„ <code>goroutine</code> å°±å¯ä»¥æ”¶åˆ°é€šçŸ¥äº†ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *TimingWheel)</span> <span class="title">After</span><span class="params">(timeout time.Duration)</span> &lt;-<span class="title">chan</span> <span class="title">struct</span></span> &#123;&#125; &#123;</span><br><span class="line">    <span class="keyword">if</span> timeout &gt;= w.maxTimeout &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">"timeout too long"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    idx := <span class="keyword">int</span>(timeout / w.interval)</span><br><span class="line">    <span class="keyword">if</span> idx &gt; <span class="number">0</span> &#123;</span><br><span class="line">        idx--</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    w.Lock()</span><br><span class="line">    idx = (w.pos + idx) % <span class="built_in">len</span>(w.cs)</span><br><span class="line">    b := w.cs[idx]</span><br><span class="line">    w.Unlock()</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *TimingWheel)</span> <span class="title">Stop</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="built_in">close</span>(w.exit)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Timing-Wheel&quot;&gt;&lt;a href=&quot;#Timing-Wheel&quot; class=&quot;headerlink&quot; title=&quot;Timing Wheel&quot;&gt;&lt;/a&gt;Timing Wheel&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://www.confluen
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Ligatures</title>
    <link href="https://oceanoverflow.github.io/2018/06/13/Ligatures/"/>
    <id>https://oceanoverflow.github.io/2018/06/13/Ligatures/</id>
    <published>2018-06-13T05:20:38.000Z</published>
    <updated>2018-06-13T05:24:39.876Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Ligatures"><a href="#Ligatures" class="headerlink" title="Ligatures"></a>Ligatures</h1><p>!!! From: <code>https://github.com/tonsky/FiraCode</code> !!!</p><h2 id="problem"><a href="#problem" class="headerlink" title="problem"></a>problem</h2><p>Programmers use a lot of symbols, often encoded with several characters. For the human brain, sequences like -&gt;, &lt;= or := are single logical tokens, even if they take two or three characters on the screen. Your eye spends a non-zero amount of energy to scan, parse and join multiple characters into a single logical one. Ideally, all programming languages should be designed with full-fledged Unicode symbols for operators, but thatâ€™s not the case yet.</p><p><img src="https://github.com/tonsky/FiraCode/raw/master/showcases/all_ligatures.png" alt="all_ligatures"></p><h2 id="installation"><a href="#installation" class="headerlink" title="installation"></a>installation</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> brew tap caskroom/fonts</span><br><span class="line"><span class="meta">$</span> brew cask install font-fira-code</span><br></pre></td></tr></table></figure><h2 id="visual-studio-code"><a href="#visual-studio-code" class="headerlink" title="visual studio code"></a>visual studio code</h2><p>Add <code>&quot;editor.fontLigatures&quot;: true</code> to <code>settings.json</code> :</p><p>To open <code>settings.json</code> , from the File menu choose Preferences, Settings or use keyboard shortcut  <code>Cmd</code> + <code>,</code> . Then paste the following lines and save the file.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"editor.fontFamily"</span>: <span class="string">"Fira Code"</span>,</span><br><span class="line"><span class="string">"editor.fontLigatures"</span>: <span class="literal">true</span></span><br></pre></td></tr></table></figure><h2 id="what-it-looks-like"><a href="#what-it-looks-like" class="headerlink" title="what it looks like"></a>what it looks like</h2><h3 id="Go"><a href="#Go" class="headerlink" title="Go"></a>Go</h3><p><img src="https://github.com/tonsky/FiraCode/raw/master/showcases/go.png" alt="go"></p><h3 id="Swift"><a href="#Swift" class="headerlink" title="Swift"></a>Swift</h3><p><img src="https://github.com/tonsky/FiraCode/raw/master/showcases/swift.png" alt="swift"></p><h3 id="Ruby"><a href="#Ruby" class="headerlink" title="Ruby"></a>Ruby</h3><p><img src="https://github.com/tonsky/FiraCode/raw/master/showcases/ruby.png" alt="ruby"></p><h3 id="JavaScript"><a href="#JavaScript" class="headerlink" title="JavaScript"></a>JavaScript</h3><p><img src="https://github.com/tonsky/FiraCode/raw/master/showcases/javascript.png" alt="js"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Ligatures&quot;&gt;&lt;a href=&quot;#Ligatures&quot; class=&quot;headerlink&quot; title=&quot;Ligatures&quot;&gt;&lt;/a&gt;Ligatures&lt;/h1&gt;&lt;p&gt;!!! From: &lt;code&gt;https://github.com/tonsky/
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Calculate 24</title>
    <link href="https://oceanoverflow.github.io/2018/06/12/Calculate24/"/>
    <id>https://oceanoverflow.github.io/2018/06/12/Calculate24/</id>
    <published>2018-06-12T06:53:49.000Z</published>
    <updated>2018-06-12T07:01:19.287Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Calculate-24"><a href="#Calculate-24" class="headerlink" title="Calculate 24"></a>Calculate 24</h1><p>ç®—24ç‚¹è¿˜æ˜¯æŒºè€ƒéªŒä¸€ä¸ªäººçš„å¿ƒç®—èƒ½åŠ›çš„ï¼Œä½œä¸ºä¸€ä¸ªæ•°å­¦æ¯”è¾ƒå·®åŠ²çš„äººï¼Œæ¯æ¬¡å’Œåˆ«äººç©24ç‚¹æ€»æ˜¯ä¼šæ…¢ä¸€ä¸ªèŠ‚æ‹ï¼Œå¯ä»¥è¯´æ˜¯éå¸¸ä¼¤è‡ªå°Šäº†ã€‚ä¸è¿‡è™½ç„¶å¿ƒç®—ç®—ä¸è¿‡åˆ«äººï¼Œæˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªè‡ªåŠ¨è®¡ç®—24ç‚¹çš„ç¨‹åºå’Œåˆ«äººæ¯”å˜›ï¼Œå˜»å˜»ã€‚</p><h2 id="expression-tree"><a href="#expression-tree" class="headerlink" title="expression tree"></a>expression tree</h2><p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/98/Exp-tree-ex-11.svg/500px-Exp-tree-ex-11.svg.png" alt="ExpressionTree"></p><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¡¨è¾¾å¼æ ‘æ¥ç¡®å®šè¿ç®—çš„ä¼˜å…ˆçº§ï¼Œè¿›è€Œç¡®å®šè¿ç®—çš„é¡ºåºï¼Œè¡¨è¾¾å¼æ ‘å±äºäºŒå‰æ ‘ï¼Œå…¶å¶ç»“ç‚¹å­˜å‚¨è¿ç®—æ•°ï¼ˆ <code>val</code> ï¼‰ï¼Œéå¶å­ç»“ç‚¹å­˜å‚¨è¿ç®—ç¬¦ <code>op</code> ï¼ˆ <code>+ï¼Œ-ï¼Œ*ï¼Œ/</code> ï¼‰åŠè¿ç®—ç»“æœï¼ˆ <code>val = l.val op r.val</code> ï¼‰ã€‚æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰æŒ‡å‘å…¶å·¦å­èŠ‚ç‚¹ï¼ˆ <code>l</code> ï¼‰å’Œå³å­èŠ‚ç‚¹ï¼ˆ <code>r</code> ï¼‰çš„æŒ‡é’ˆï¼Œå¶èŠ‚ç‚¹ä¸­è¿™ä¸¤ä¸ªæŒ‡é’ˆå‡ä¸ºç©ºã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> node <span class="keyword">struct</span> &#123;</span><br><span class="line">    l    *node</span><br><span class="line">    r    *node</span><br><span class="line">    op   <span class="keyword">rune</span></span><br><span class="line">    val  <span class="keyword">float64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *node)</span> <span class="title">set</span><span class="params">(l, r *node, op <span class="keyword">rune</span>)</span></span> &#123;</span><br><span class="line">    n.l  = l</span><br><span class="line">    n.r  = r</span><br><span class="line">    n.op = op</span><br><span class="line">    <span class="keyword">switch</span> op &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'+'</span>:</span><br><span class="line">        n.val = <span class="keyword">float64</span>(n.l.val + n.r.val)</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'-'</span>:</span><br><span class="line">        n.val = <span class="keyword">float64</span>(n.l.val - n.r.val)</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'*'</span>:</span><br><span class="line">        n.val = <span class="keyword">float64</span>(n.l.val * n.r.val)</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'/'</span>:</span><br><span class="line">        n.val = <span class="keyword">float64</span>(n.l.val / n.r.val)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *node)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> n.op != <span class="keyword">rune</span>(<span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Sprintf(<span class="string">" %c "</span>, n.op)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">"%d"</span>, <span class="keyword">int</span>(n.val))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="build-tree"><a href="#build-tree" class="headerlink" title="build tree"></a>build tree</h2><p>ç”±äºå­˜åœ¨è¿ç®—ä¼˜å…ˆçº§çš„åŸå› ï¼Œæ‰€ä»¥åœ¨è¿ç®—æ•°å’Œè¿ç®—ç¬¦éƒ½ç›¸åŒçš„æƒ…å†µä¸‹å½“å…¶è¿ç®—é¡ºåºä¸åŒæ—¶å¾—å‡ºçš„è¡¨è¾¾å¼æ ‘çš„å½¢æ€ä¹Ÿä¸åŒï¼Œä¾‹å¦‚ <code>(1 + 8) * (7 - 13)</code>  ä¸ <code>1 + 8 * 7 - 13</code> çš„è¿ç®—é¡ºåºæ˜¯ä¸åŒçš„ï¼Œ<code>(1 + 8) * (7 - 13)</code>  å¯¹åº”çš„æ˜¯ä¸‹é¢ç¬¬ä¸€æ£µæ ‘çš„å½¢æ€ï¼Œ <code>1 + 8 * 7 - 13</code> å¯¹åº”çš„æ˜¯ä¸‹é¢ç¬¬å››æ£µæ ‘çš„å½¢æ€ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    x               x               x                x               x</span><br><span class="line">   / \             / \             / \              / \             / \</span><br><span class="line">  x   x           x   x           x   x            x   x           x   x</span><br><span class="line"> / \ / \             / \             / \          / \             / \</span><br><span class="line">x  x x  x           x   x           x   x        x   x           x   x</span><br><span class="line">                   / \                 / \          / \         / \</span><br><span class="line">                  x   x               x   x        x   x       x   x</span><br></pre></td></tr></table></figure><p>ä¸ºäº†å¾—å‡ºæ‰€æœ‰çš„å¯èƒ½ç»“æœï¼Œæˆ‘ä»¬éœ€è¦æ„å»ºæ‰€æœ‰ä¸åŒå½¢æ€çš„è¡¨è¾¾å¼æ ‘ï¼Œ<code>buildAllTrees</code> åˆ©ç”¨é€’å½’æ–¹æ³•æ¥å»ºæ ‘ï¼Œä¾‹å¦‚ç»™å®š <code>3ï¼Œ4ï¼Œ5ï¼Œ6</code> è¿™å››ä¸ªæ•°ï¼Œå¯ä»¥æ„å»ºå‡ºä¸Šé¢5ç§å½¢æ€çš„æ ‘ã€‚ <code>3ï¼Œ4ï¼Œ5ï¼Œ6</code> ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œç„¶åå°†æ•°ç»„åˆ†å‰²ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¾‹å¦‚ä¸Šé¢çš„ <code>3ï¼Œ4ï¼Œ5ï¼Œ6</code> å¯ä»¥åˆ†å‰²ä¸º <code>3</code> å’Œ <code>4ï¼Œ5ï¼Œ6</code> æˆ–è€… <code>3ï¼Œ4</code> å’Œ <code>5ï¼Œ6</code> æˆ–è€… <code>3ï¼Œ4ï¼Œ5</code> å’Œ <code>6</code> ï¼Œç„¶åå¯¹è¿™ä¸¤ä¸ªéƒ¨åˆ†åˆ†åˆ«å†è¿›è¡Œé€’å½’å»ºæ ‘æ“ä½œï¼Œå½“æ•°ç»„é•¿åº¦ä¸º1æ—¶ä¹Ÿå°±æ˜¯å½“ <code>len(s) == 1</code> ä½œä¸ºé€’å½’å‡½æ•°é€€å‡ºçš„æ¡ä»¶ï¼Œæ­¤æ—¶è¿”å›ä¸€ä¸ªå¶èŠ‚ç‚¹ï¼ŒæŒ‰ç…§è¿™æ ·çš„æ–¹å¼æœ€ç»ˆå¯ä»¥å¾—åˆ°æ‰€æœ‰å¯èƒ½å½¢æ€çš„æ ‘çš„æ ¹èŠ‚ç‚¹ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">buildAllTrees</span><span class="params">(s []<span class="keyword">int</span>)</span> []*<span class="title">node</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(s) == <span class="number">1</span> &#123;</span><br><span class="line">       tree := &amp;node&#123;result: <span class="keyword">float64</span>(s[<span class="number">0</span>])&#125;</span><br><span class="line">       <span class="keyword">return</span> []*node&#123;tree&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    treelist := []*node&#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt; <span class="built_in">len</span>(s); i++ &#123;</span><br><span class="line">        left := s[:i]</span><br><span class="line">        right := s[i:]</span><br><span class="line">        leftTrees := buildAllTrees(left)</span><br><span class="line">        rightTrees := buildAllTrees(right)</span><br><span class="line">        <span class="keyword">for</span> _, l := <span class="keyword">range</span> leftTrees &#123;</span><br><span class="line">            <span class="keyword">for</span> _, r := <span class="keyword">range</span> rightTrees &#123;</span><br><span class="line">                combinedTree := build(l, r)</span><br><span class="line">                treelist = <span class="built_in">append</span>(treelist, combinedTree...)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> treelist</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºå­˜åœ¨å››ç§è¿ç®—ç¬¦ï¼Œä¾‹å¦‚åˆ©ç”¨ <code>a</code> å’Œ <code>b</code> è¿™ä¸¤ä¸ªèŠ‚ç‚¹æ„å»ºæ ‘çš„æ—¶å€™ï¼Œå¯ä»¥æœ‰ <code>a+b</code> ï¼Œ <code>a-b</code> ï¼Œ <code>a*b</code> ï¼Œ <code>a/b</code> è¿™å››ç§å¯èƒ½ï¼Œæ‰€ä»¥è¦åˆ†åˆ«åˆ—ä¸¾ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">build</span><span class="params">(l, r *node)</span> []*<span class="title">node</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> list []*node</span><br><span class="line">    tree1 := &amp;node&#123;&#125;</span><br><span class="line">    tree1.set(l, r, <span class="string">'+'</span>)</span><br><span class="line">    list = <span class="built_in">append</span>(list, tree1)</span><br><span class="line">    tree2 := &amp;node&#123;&#125;</span><br><span class="line">    tree2.set(l, r, <span class="string">'-'</span>)</span><br><span class="line">    list = <span class="built_in">append</span>(list, tree2)</span><br><span class="line">    tree3 := &amp;node&#123;&#125;</span><br><span class="line">    tree3.set(l, r, <span class="string">'*'</span>)</span><br><span class="line">    list = <span class="built_in">append</span>(list, tree3)</span><br><span class="line">    <span class="keyword">if</span> r.result != <span class="number">0.0</span> &#123;</span><br><span class="line">        tree4 := &amp;node&#123;&#125;</span><br><span class="line">        tree4.set(l, r, <span class="string">'/'</span>)</span><br><span class="line">        list = <span class="built_in">append</span>(list, tree4)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸­åºéå†è¡¨è¾¾å¼æ ‘æ¥éå†è¾“å‡ºæ„å»ºçš„è¡¨è¾¾å¼ï¼Œç”±äºä¸Šé¢æˆ‘ä»¬å®šä¹‰äº†æ¯ä¸ªèŠ‚ç‚¹çš„ <code>String</code> æ–¹æ³•ï¼Œå¦‚æœèŠ‚ç‚¹ä¸ºè¿ç®—ç¬¦ï¼Œåˆ™è¾“å‡ºå…¶ <code>op</code> çš„å€¼ï¼Œå¦‚æœèŠ‚ç‚¹ä¸ºå¶ç»“ç‚¹ï¼Œåˆ™è¾“å‡ºå…¶ <code>val</code> å€¼ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">in</span><span class="params">(root *node)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> n == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> n.op != <span class="keyword">rune</span>(<span class="number">0</span>) &#123;</span><br><span class="line">        fmt.Print(<span class="string">"("</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    in(root.l)</span><br><span class="line">    fmt.Print(n.String())</span><br><span class="line">    in(root.r)</span><br><span class="line">    <span class="keyword">if</span> n.op != <span class="keyword">rune</span>(<span class="number">0</span>) &#123;</span><br><span class="line">        fmt.Print(<span class="string">")"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="permutation"><a href="#permutation" class="headerlink" title="permutation"></a>permutation</h2><p>ä¸Šé¢çš„æ–¹æ³•æ˜¯å¯¹ä¸€ä¸ªæ•°ç»„å…¶å›ºå®šçš„é¡ºåºæ„å»ºè¡¨è¾¾å¼æ ‘ï¼Œä¾‹å¦‚ <code>3ï¼Œ4ï¼Œ5ï¼Œ6</code> ã€‚ä¸ºäº†è·å¾—æ‰€æœ‰çš„è¿ç®—è¡¨è¾¾å¼ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ•°ç»„çš„æ‰€æœ‰æ’åˆ—ç»„åˆè¿›è¡Œè¡¨è¾¾å¼æ ‘çš„æ„å»ºï¼Œä¾‹å¦‚å¯¹ <code>6ï¼Œ5ï¼Œ4ï¼Œ3</code> ï¼Œ<code>5ï¼Œ6ï¼Œ4ï¼Œ3</code> è¿™æ ·çš„æ’åˆ—ç»„åˆæ„å»ºè¡¨è¾¾å¼æ ‘ã€‚ä¹Ÿå°±æ˜¯è¯´é™¤äº†æ ‘å½¢æ€ä¸åŒçš„è¿™ç‚¹åŒºåˆ«ä¹‹å¤–ï¼Œè¿˜è¦æ³¨æ„å¶ç»“ç‚¹å€¼å­˜å‚¨é¡ºåºä¸åŒçš„å¸¦æ¥çš„å¯èƒ½ï¼ˆå¯èƒ½ä¼šå¯¼è‡´é‡å¤ï¼‰ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Perm</span><span class="params">(a []<span class="keyword">int</span>, f <span class="keyword">func</span>([]<span class="keyword">int</span>)</span>)</span> &#123;</span><br><span class="line">    perm(a, f, <span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">perm</span><span class="params">(a []<span class="keyword">int</span>, f <span class="keyword">func</span>([]<span class="keyword">int</span>)</span>, <span class="title">i</span> <span class="title">int</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> i &gt; <span class="built_in">len</span>(a) &#123;</span><br><span class="line">        f(a)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    perm(a, f, i+<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> j := i + <span class="number">1</span>; j &lt; <span class="built_in">len</span>(a); j++ &#123;</span><br><span class="line">        a[i], a[j] = a[j], a[i]</span><br><span class="line">        perm(a, f, i+<span class="number">1</span>)</span><br><span class="line">        a[i], a[j] = a[j], a[i]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="main"><a href="#main" class="headerlink" title="main"></a>main</h2><p>åœ¨ä¸»å‡½æ•°ä¸­æˆ‘ä»¬æ¯éš”äº”ç§’é’Ÿè·å¾—ä¸€ä¸ªéšæœºçš„æ‰‘å…‹ç‰Œæ•°å­—ï¼Œç„¶åå¯¹äºè¯¥ç»„æ•°å­—æ‰€æœ‰çš„æ’åˆ—ç»„åˆåˆ†åˆ«æ„å»ºè¡¨è¾¾å¼æ ‘ï¼Œå¯¹æ¯æ£µæ„å»ºå¥½çš„æ ‘åˆ¤æ–­å…¶æ ¹èŠ‚ç‚¹çš„å€¼æ˜¯å¦æ¥è¿‘äº24ï¼ˆç”±äºæ¶‰åŠåˆ°é™¤æ³•æ“ä½œï¼Œæ‰€ä»¥æœ‰å°æ•°ç‚¹ï¼‰ï¼Œå¦‚æœæ¥è¿‘ï¼Œåˆ™å°†å…¶è¡¨è¾¾å¼é€šè¿‡ä¸­åºéå†è¾“å‡ºï¼Œè¿™æ ·å°±å¯ä»¥å¾—å‡ºä¸€ç»„æ•°å­—æ‰€æœ‰24ç‚¹çš„å¯èƒ½äº†ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        s := rand24()</span><br><span class="line">        fmt.Println(s)</span><br><span class="line">        Perm(s, <span class="function"><span class="keyword">func</span><span class="params">(a []<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">            treelist := buildAllTrees(a)</span><br><span class="line">            <span class="keyword">for</span> _, root := <span class="keyword">range</span> treelist &#123;</span><br><span class="line">                <span class="keyword">if</span> math.Abs(<span class="number">24</span>-tree.result) &lt; <span class="number">0.000001</span> &#123;</span><br><span class="line">                    in(root)</span><br><span class="line">                    fmt.Println()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">rand24</span><span class="params">()</span> <span class="params">(r []<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    rand.Seed(time.Now().UnixNano())</span><br><span class="line"></span><br><span class="line">    club    := []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>&#125;</span><br><span class="line">    heart   := []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>&#125;</span><br><span class="line">    spade   := []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>&#125;</span><br><span class="line">    diamond := []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> all []<span class="keyword">int</span></span><br><span class="line">    all = <span class="built_in">append</span>(all, spade...)</span><br><span class="line">    all = <span class="built_in">append</span>(all, heart...)</span><br><span class="line">    all = <span class="built_in">append</span>(all, diamond...)</span><br><span class="line">    all = <span class="built_in">append</span>(all, club...)</span><br><span class="line"></span><br><span class="line">    r = <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    exist = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">bool</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">4</span>; i++ &#123;</span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">            x := rand.Int() % <span class="built_in">len</span>(all)</span><br><span class="line">            <span class="keyword">if</span> !exist[x] &#123;</span><br><span class="line">                exist[x] = <span class="literal">true</span></span><br><span class="line">                r[i] = all[x]</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Calculate-24&quot;&gt;&lt;a href=&quot;#Calculate-24&quot; class=&quot;headerlink&quot; title=&quot;Calculate 24&quot;&gt;&lt;/a&gt;Calculate 24&lt;/h1&gt;&lt;p&gt;ç®—24ç‚¹è¿˜æ˜¯æŒºè€ƒéªŒä¸€ä¸ªäººçš„å¿ƒç®—èƒ½åŠ›çš„ï¼Œä½œä¸ºä¸€ä¸ªæ•°å­¦æ¯”è¾ƒå·®åŠ²çš„
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Chat Chat Chat</title>
    <link href="https://oceanoverflow.github.io/2018/06/11/ChatChatChat/"/>
    <id>https://oceanoverflow.github.io/2018/06/11/ChatChatChat/</id>
    <published>2018-06-11T07:09:34.000Z</published>
    <updated>2018-06-11T07:10:20.087Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Chat-Chat-Chat"><a href="#Chat-Chat-Chat" class="headerlink" title="Chat Chat Chat"></a>Chat Chat Chat</h1><p>æ‰¿è®¤å§ï¼Œä½ è‚¯å®šä¹Ÿä¼šæœ‰æ·±å¤œå¯‚å¯æ—¶ç‰¹åˆ«æƒ³æ‰¾äººèŠå¤©ä½†ç¿»éæœ‹å‹åœˆï¼Œå´è¿˜æ˜¯æ²¡æœ‰å‘ç°åˆé€‚çš„äººçš„æ—¶å€™ï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥å†™ä¸€ä¸ªéšæœºé…å¯¹èŠå¤©ç¨‹åºï¼Œè§£å†³å¹¿å¤§å•èº«ç‹—å¯‚å¯æ—¶æƒ³è¦æ‰¾äººèŠå¤©çš„éœ€æ±‚å§ã€‚</p><p>ä¸ºäº†è®©èŠå¤©ä¸é‚£ä¹ˆ <code>gay</code> ï¼Œæˆ‘ä»¬çš„èŠå¤©ç¨‹åºä¼šè®©å¼‚æ€§åŒ¹é…èŠå¤©ï¼Œç”¨æˆ·é€šè¿‡å®¢æˆ·ç«¯è¿æ¥åˆ°èŠå¤©ç¨‹åºæœåŠ¡å™¨ <code>localhost:8080</code> ï¼Œä¾‹å¦‚ä½¿ç”¨ <code>netcat</code> é€šè¿‡ <code>nc localhost 8080</code> å‘½ä»¤è¿æ¥èŠå¤©ç¨‹åºæœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨ä¼šæ ¹æ®ä½ çš„æ€§åˆ«åŒ¹é…å¼‚æ€§èŠå¤©ã€‚</p><p>åœ¨å®ç°æ–¹é¢ï¼Œä¸ºäº†è¾¾åˆ°å¼‚æ€§ç›¸äº’èŠå¤©çš„ç›®æ ‡ï¼Œæˆ‘ä»¬åˆ›å»ºä¸¤ä¸ªé€šé“ï¼Œåˆ†åˆ«æ˜¯ <code>boy</code> é€šé“å’Œ <code>girl</code> é€šé“ï¼Œå¹¶é€šè¿‡ <code>net.Listen</code> æ–¹æ³•ç›‘å¬ <code>8080</code> ç«¯å£ï¼Œå¯¹äºæ¯ä¸ªè¿æ¥æˆ‘ä»¬èµ·ä¸€ä¸ª <code>goroutine</code> è¿›è¡ŒåŒ¹é…æ“ä½œã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> boy = <span class="built_in">make</span>(<span class="keyword">chan</span> io.ReadWriteCloser)</span><br><span class="line"><span class="keyword">var</span> girl = <span class="built_in">make</span>(<span class="keyword">chan</span> io.ReadWriteCloser)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    l, err := net.Listen(<span class="string">"tcp"</span>, <span class="string">"localhost:8080"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        c, err := l.Accept()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            log.Println(err)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">go</span> match(c)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>match</code> æ–¹æ³•ä¼šé¦–å…ˆè¯¢é—®ä½ çš„æ€§åˆ«ï¼Œå¦‚æœæ˜¯ç”·ç”Ÿåˆ™åŒ¹é…å¥³ç”ŸèŠå¤©ï¼Œåä¹‹äº¦ç„¶ã€‚å¦‚æœå½“å‰åªæœ‰ä¸€ä¸ªç”·ç”Ÿè¿è¿›æ¥ï¼Œç¨‹åºä¼šæ‰§è¡Œç¬¬ä¸€ä¸ª <code>select</code> ä¸­çš„ <code>case boy &lt;- c:</code> æ¡ä»¶ï¼Œç”±äº <code>boy</code> é€šé“æ˜¯ <code>unbuffered channel</code> ï¼Œç›´åˆ°æœ‰å¥³ç”Ÿè¿›æ¥ä¹‹å‰è¯¥æ“ä½œéƒ½ä¼šé˜»å¡ã€‚å¦‚æœæ­¤æ—¶è¿›æ¥ä¸€ä¸ªå¥³ç”Ÿï¼Œç¨‹åºä¼šæ‰§è¡Œç¬¬äºŒä¸ª<code>select</code> æ“ä½œï¼Œç”±äº <code>girl</code> é€šé“ä¹Ÿæ˜¯ <code>unbuffered channel</code> ï¼Œæ‰€ä»¥<code>case girl &lt;- c:</code> è¯­å¥ä¹Ÿä¼šé˜»å¡ï¼Œä½†æ­¤æ—¶ <code>case p := &lt;-boy:</code> ä¼šè¢«æ‰§è¡Œï¼Œè¿™æ—¶å€™å°±å¯ä»¥é€šè¿‡ <code>chat</code> æ–¹æ³•è®©ä¸¤ä¸ª <code>net.Conn</code> ç›¸äº’äº¤æµäº†ã€‚<code>match</code> æ–¹æ³•å®ç°çš„é€»è¾‘å°±è¾¾åˆ°äº†å¼‚æ€§äº¤æµçš„ç›®çš„äº†ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">match</span><span class="params">(c io.ReadWriteCloser)</span></span> &#123;</span><br><span class="line">    fmt.Fprint(c, <span class="string">"Are you a boy or a girl? "</span>)</span><br><span class="line">    <span class="keyword">var</span> sex <span class="keyword">string</span></span><br><span class="line">    fmt.Fscanln(c, &amp;sex)</span><br><span class="line">    <span class="keyword">if</span> strings.HasPrefix(<span class="string">"boy"</span>, sex) &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> boy &lt;- c: </span><br><span class="line">        <span class="keyword">case</span> p := &lt;-girl:</span><br><span class="line">            chat(p, c)</span><br><span class="line">        &#125;     </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> strings.HasPrefix(<span class="string">"girl"</span>, sex) &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> girl &lt;- c:</span><br><span class="line">        <span class="keyword">case</span> p := &lt;-boy:</span><br><span class="line">            chat(p, c)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ <code>chat</code> æ–¹æ³•ä¾èµ– <code>cp</code> æ–¹æ³• ï¼Œè¯¥æ–¹æ³•å°è£…äº† <code>io.Copy</code> æ–¹æ³•ï¼Œä¸»è¦å°±æ˜¯ä¸ºäº†å½“ä»»æ„ä¸€æ–¹ç»“æŸèŠå¤©æ—¶å‘é€ä¸€ä¸ª <code>err</code> åˆ°æˆ‘ä»¬çš„ <code>errc</code> ï¼Œä»¥å…³é—­åŒæ–¹çš„è¿æ¥ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cp</span><span class="params">(w io.Writer, r io.Reader, errc <span class="keyword">chan</span>&lt;- error)</span></span> &#123;</span><br><span class="line">    _, err := io.Copy(w, r)</span><br><span class="line">    errc &lt;- err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>chat</code> æ–¹æ³•é€šè¿‡ä¸¤ä¸ª <code>goroutine</code> ï¼Œ<code>go cp(a, b, errc)</code>  å’Œ <code>go cp(b, a, errc)</code> ä½¿aå’Œbè¿™ä¸¤ä¸ª <code>net.Conn</code> ç›¸äº’å‘é€æ¶ˆæ¯ï¼Œå¦‚æœä»»æ„ä¸€æ–¹ç»“æŸèŠå¤©ï¼Œ <code>errc</code> é€šé“å°±ä¼šè¿”å›ä¸€ä¸ª <code>error</code> å€¼ï¼Œaå’Œbå°±ä¼šè¢«å…³é—­ï¼Œæ­¤æ—¶èŠå¤©ç»“æŸã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chat</span><span class="params">(a, b io.ReadWriteCloser)</span></span> &#123;</span><br><span class="line">    fmt.Fprintln(a, <span class="string">"Found one! say hi"</span>)</span><br><span class="line">    fmt.Fprintln(b, <span class="string">"Found one! say hi"</span>)</span><br><span class="line">    errc := <span class="built_in">make</span>(<span class="keyword">chan</span> error, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> cp(a, b, errc) </span><br><span class="line">    <span class="keyword">go</span> cp(b, a, errc)</span><br><span class="line">    <span class="keyword">if</span> err := &lt;- errc; err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Println(err)</span><br><span class="line">    &#125;</span><br><span class="line">    a.Close()</span><br><span class="line">    b.Close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Chat-Chat-Chat&quot;&gt;&lt;a href=&quot;#Chat-Chat-Chat&quot; class=&quot;headerlink&quot; title=&quot;Chat Chat Chat&quot;&gt;&lt;/a&gt;Chat Chat Chat&lt;/h1&gt;&lt;p&gt;æ‰¿è®¤å§ï¼Œä½ è‚¯å®šä¹Ÿä¼šæœ‰æ·±å¤œå¯‚å¯æ—¶ç‰¹åˆ«æƒ³æ‰¾äººèŠå¤©
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>bitcoin</title>
    <link href="https://oceanoverflow.github.io/2018/06/06/bitcoin/"/>
    <id>https://oceanoverflow.github.io/2018/06/06/bitcoin/</id>
    <published>2018-06-06T14:19:02.000Z</published>
    <updated>2018-06-06T14:30:06.903Z</updated>
    
    <content type="html"><![CDATA[<h1 id="bitcoin"><a href="#bitcoin" class="headerlink" title="bitcoin"></a>bitcoin</h1><p>å¦‚æœæœ‰æ—¶å…‰æœºçš„è¯ï¼Œæˆ‘è¦åšçš„ç¬¬ä¸€ä»¶äº‹æƒ…è‚¯å®šå°±æ˜¯ç©¿æ¢­å›è¿‡å»ä¹°æ¯”ç‰¹å¸ï¼šï¼‰ï¼Œç®—äº†ï¼Œä¸æ„æ·«äº†ï¼Œè¿˜æ˜¯å­¦ä¹ è¦ç´§ï¼Œè™½ç„¶å†ä¹Ÿä¸èƒ½é ä¹°æ¯”ç‰¹å¸ä¸€å¤œæš´å¯Œäº†ï¼Œä½†æ˜¯è‡ªå·±æŒ‰ç…§æ¯”ç‰¹å¸å®ç°ä¸€ä¸ªå±±å¯¨æ¯”ç‰¹å¸çš„èƒ½åŠ›è¿˜æ˜¯æœ‰çš„ï¼Œæ¯”ç‰¹å¸å¯ä»¥è¯´æ˜¯ç°åœ¨å¤§çº¢å¤§ç´«çš„åŒºå—é“¾çš„å§‹ç¥–ï¼Œè¦å…¨éƒ¨äº†è§£å®ƒçš„åŸç†å¯èƒ½è¿˜æ˜¯è¦åŸ‹å¤´å•ƒä¸ªå‡ ä¸ªæœˆçš„ï¼ˆå¹¶ä¸ç®€å•ï¼‰ã€‚</p><p>è™½ç„¶æ¯”ç‰¹å¸äº¤æ˜“ç¡®è®¤æ—¶é—´é•¿ï¼Œæ¶ˆè€—èµ„æºå¤šï¼Œä½†ä¾æ—§æ— æ³•æ©ç›–å…¶ä½œä¸ºåŒºå—é“¾å§‹ç¥–çš„å…‰ç¯ã€‚</p><p><img src="https://cdn-images-1.medium.com/max/1600/1*_RY4v9D5-BOVMzFMr8Dk4A.png" alt="bitcoin"></p><h2 id="Block-amp-BlockChain"><a href="#Block-amp-BlockChain" class="headerlink" title="Block &amp; BlockChain"></a>Block &amp; BlockChain</h2><p>æ¯”ç‰¹å¸ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„åŸºæœ¬æ¦‚å¿µï¼ŒåŒºå—å’ŒåŒºå—é“¾ï¼Œå¦‚æœå°†åŒºå—æƒ³è±¡æˆçç ï¼Œé‚£ä¹ˆåŒºå—é“¾å°±æ˜¯å°†è¿™äº›çç éƒ½ä¸²èµ·æ¥çš„çç é¡¹é“¾ï¼Œè¿™ä¸ªçç é¡¹é“¾æ²¡æœ‰å°½å¤´ï¼Œæ–°åŠ å…¥çš„çç å’Œæ¬¡æ–°çš„çç å½¼æ­¤é è¿‘ï¼Œå¹¶é€šè¿‡æŸç§å…³ç³»ç´§å¯†è”ç³»åœ¨ä¸€èµ·ï¼Œç‰¢ä¸å¯ç ´ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Block <span class="keyword">struct</span> &#123;</span><br><span class="line">    idx        <span class="keyword">int</span></span><br><span class="line">    timestamp  <span class="keyword">string</span></span><br><span class="line">    hash       <span class="keyword">string</span></span><br><span class="line">    prevHash   <span class="keyword">string</span></span><br><span class="line">    difficulty <span class="keyword">int</span></span><br><span class="line">    nonce      <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> BlockChain <span class="keyword">struct</span> &#123;</span><br><span class="line">    sync.Mutex</span><br><span class="line">    blocks []Block</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bc *BlockChain)</span> <span class="title">AddBlock</span><span class="params">(block Block)</span></span> &#123;</span><br><span class="line">    bc.Lock()</span><br><span class="line">    <span class="keyword">defer</span> bc.Unlock()</span><br><span class="line">    bc.blocks = <span class="built_in">append</span>(bc.blocks, block)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> blockchain BlockChain</span><br></pre></td></tr></table></figure><h2 id="Proof-of-Work"><a href="#Proof-of-Work" class="headerlink" title="Proof of Work"></a>Proof of Work</h2><p>ç”ŸæˆåŒºå—çš„è¿‡ç¨‹å°±ç›¸å½“äºæ‰“ç£¨çç çš„è¿‡ç¨‹ï¼Œåªæœ‰ç¬¦åˆè¦æ±‚çš„çç æ‰èƒ½æœ€ç»ˆè¢«åŠ å…¥åˆ°çç é¡¹é“¾ä¸­å»ï¼Œé‚£ä¹ˆè¯è¯´å›æ¥ç”ŸæˆåŒºå—çš„è¿‡ç¨‹æ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Œå¯¹äºä¸€ä¸ªç‰¹å®šçš„åŒºå—ï¼Œéœ€è¦ä¸æ–­æ”¹å˜å…¶ä¸­ä¸€ä¸ªå€¼ï¼ˆnonceï¼‰ï¼Œè¿™é‡Œçš„ <code>nonce</code> å€¼ä»0å¼€å§‹é€æ¸é€’å¢ï¼Œç„¶åè®¡ç®—ç‰¹å®š <code>nonce</code> å¯¹åº”çš„åŒºå—å“ˆå¸Œå€¼ï¼Œåªæœ‰å“ˆå¸Œå€¼ç¬¦åˆç›¸åº”çš„è¦æ±‚ä¹‹åï¼Œæ‰èƒ½è¯´è¿™ä¸ªåŒºå—æ˜¯æœ‰æ•ˆçš„ï¼Œæ‰èƒ½è¢«åŠ å…¥åˆ°åŒºå—é“¾ä¸­ï¼Œç”ŸæˆåŒºå—çš„è¿‡ç¨‹ä¹Ÿè¢«å«åšæŒ–çŸ¿ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateBlock</span><span class="params">(oldBlock Block, difficulty <span class="keyword">int</span>)</span> <span class="title">Block</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> newBlock Block</span><br><span class="line"></span><br><span class="line">    newBlock.idx = oldBlock.idx + <span class="number">1</span></span><br><span class="line">    newBlock.timestamp = time.Now().String()</span><br><span class="line">    newBlock.prevHash = oldBlock.hash</span><br><span class="line">  newBlock.difficulty = diff</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</span><br><span class="line">        hex := fmt.Sprintf(<span class="string">"%x"</span>, i)</span><br><span class="line">        newBlock.nonce = hex</span><br><span class="line">        <span class="keyword">if</span> !isHashValid(calculateHash(newBlock), newBlock.difficulty) &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            fmt.Println(calculateHash(newBlock), <span class="string">" work done!"</span>)</span><br><span class="line">            newBlock.Hash = calculateHash(newBlock)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newBlock</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">calculateHash</span><span class="params">(block Block)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    record := strconv.Itoa(block.idx) + block.timestamp + block.prevHash + block.difficulty + block.nonce</span><br><span class="line">    h := sha256.New()</span><br><span class="line">    h.Write([]<span class="keyword">byte</span>(record))</span><br><span class="line">    hashed := h.Sum(<span class="literal">nil</span>)</span><br><span class="line">    <span class="keyword">return</span> hex.EncodeToString(hashed)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆä»€ä¹ˆæ ·çš„åŒºå—æ‰æ˜¯æœ‰æ•ˆçš„å‘¢ï¼Œç®€å•æ¥è¯´å°±æ˜¯å¯¹äºä¸€ä¸ªå“ˆå¸Œå€¼ï¼Œå…¶å¼€å¤´éƒ¨åˆ†éƒ½æ˜¯0å°±å¯ä»¥äº†ï¼ˆ0è¶Šå¤šï¼Œéš¾åº¦è¶Šé«˜ï¼‰ã€‚åƒè¿™ç§ï¼Œæ‰¾åˆ°ç­”æ¡ˆå¾ˆå›°éš¾ä½†éªŒè¯ç­”æ¡ˆå´éå¸¸è½»æ¾çš„ç®—æ³•å°±æ˜¯ <code>Proof of Work</code> çš„ç²¾é«“ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isHashValid</span><span class="params">(hash <span class="keyword">string</span>, difficulty <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    prefix := strings.Repeat(<span class="string">"0"</span>, difficulty)</span><br><span class="line">    <span class="keyword">return</span> strings.HasPrefix(hash, prefix)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¸€ä¸ªéš¾åº¦é€æ¸é€’å¢çš„åŒºå—é“¾"><a href="#ä¸€ä¸ªéš¾åº¦é€æ¸é€’å¢çš„åŒºå—é“¾" class="headerlink" title="ä¸€ä¸ªéš¾åº¦é€æ¸é€’å¢çš„åŒºå—é“¾"></a>ä¸€ä¸ªéš¾åº¦é€æ¸é€’å¢çš„åŒºå—é“¾</h2><p>ä¸‹é¢å®ç°äº†ä¸€ä¸ªéš¾åº¦é€æ¸é€’å¢çš„åŒºå—é“¾ï¼Œè¿è¡Œæ—¶å°±ä¼šå‘ç°äº§ç”ŸåŒºå—çš„æ—¶é—´é—´éš”è¶Šæ¥è¶Šé•¿ï¼Œå› ä¸º <code>CPU</code> éœ€è¦ç»è¿‡æ›´å¤šçš„è®¡ç®—æ‰èƒ½æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å“ˆå¸Œå€¼ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    difficulty := <span class="number">1</span></span><br><span class="line">    genesisBlock := Block&#123;&#125;</span><br><span class="line">    genesisBlock = Block&#123;</span><br><span class="line">        idx:        <span class="number">0</span>, </span><br><span class="line">        timestamp:  time.Now().String(), </span><br><span class="line">        hash:       calculateHash(genesisBlock),</span><br><span class="line">        prevHash:   <span class="string">""</span>, </span><br><span class="line">        difficulty: difficulty, </span><br><span class="line">        nonce:      <span class="string">""</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    blockchain.AddBlock(genesisBlock)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> block Block</span><br><span class="line">    block = genesisBlock</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        block = generateBlock(block, diff)</span><br><span class="line">        difficulty++</span><br><span class="line">        blockchain.AddBlock(block)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;bitcoin&quot;&gt;&lt;a href=&quot;#bitcoin&quot; class=&quot;headerlink&quot; title=&quot;bitcoin&quot;&gt;&lt;/a&gt;bitcoin&lt;/h1&gt;&lt;p&gt;å¦‚æœæœ‰æ—¶å…‰æœºçš„è¯ï¼Œæˆ‘è¦åšçš„ç¬¬ä¸€ä»¶äº‹æƒ…è‚¯å®šå°±æ˜¯ç©¿æ¢­å›è¿‡å»ä¹°æ¯”ç‰¹å¸ï¼šï¼‰ï¼Œç®—äº†ï¼Œä¸æ„æ·«äº†ï¼Œè¿˜æ˜¯å­¦ä¹ è¦ç´§ï¼Œè™½
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Magic Number</title>
    <link href="https://oceanoverflow.github.io/2018/06/05/MagicNumber/"/>
    <id>https://oceanoverflow.github.io/2018/06/05/MagicNumber/</id>
    <published>2018-06-05T08:27:07.000Z</published>
    <updated>2018-06-05T09:03:33.090Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Magic-Number"><a href="#Magic-Number" class="headerlink" title="Magic Number"></a>Magic Number</h1><p>å¾®ç¬‘.jpgï¼Œè¿™é‡Œå¹´è½»äººä»¬èŠå¤©æ—¶ç»å¸¸ä½¿ç”¨çš„è¯´æ³•ï¼Œä½†æ˜¯ï¼ä½œä¸ºä¸€ä¸ªä¸¥è°¨çš„ç¨‹åºå‘˜ï¼Œæˆ‘ä»¬èƒ½ä¸èƒ½é€šè¿‡æ–‡ä»¶çš„åç¼€æ¥åˆ¤æ–­è¿™ä¸ªæ–‡ä»¶çš„ç±»å‹å‘¢ï¼Ÿä¾‹å¦‚çœ‹åˆ°ç”µè„‘ä¸Šå­˜åœ¨â€œå¾®ç¬‘.jpgâ€è¿™ä¸ªæ–‡ä»¶ï¼Œé€šè¿‡åç¼€ <code>jpg</code> æ¥åˆ¤æ–­å®ƒå°±æ˜¯ä¸€ä¸ª <code>JPEG</code> æ–‡ä»¶å‘¢ï¼Œç­”æ¡ˆè‚¯å®šæ˜¯å¦å®šçš„ï¼Œå› ä¸ºæ–‡ä»¶åå¯ä»¥è¢«è½»æ¾ç¯¡æ”¹ï¼Œä¾‹å¦‚è¿™ä¸ªæ–‡ä»¶æœ¬æ¥æ˜¯â€œå¾®ç¬‘.gifâ€ï¼Œæœ‰äººæƒ³ä¸å¼€å°±å°†å®ƒæ”¹æˆâ€œå¾®ç¬‘.jpgâ€ï¼Œè™½ç„¶æ²¡æœ‰ä»€ä¹ˆå½±å“ï¼Œä½†æ˜¯å¯ä»¥è¯´æ˜ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¸èƒ½é€šè¿‡æ–‡ä»¶åç¼€æ¥åˆ¤æ–­æ–‡ä»¶çš„ç±»å‹ã€‚</p><p>å¦‚æœä¸ä½¿ç”¨æ–‡ä»¶åç¼€ï¼Œæˆ‘ä»¬åº”è¯¥å¦‚ä½•åˆ¤æ–­æ–‡ä»¶çš„ç±»å‹å‘¢ï¼Œç­”æ¡ˆå°±æ˜¯æˆ‘ä»¬ä»Šå¤©è¦è®¨è®ºçš„<code>Magic Number</code> ï¼Œå³é­”æœ¯æ•°ï¼Œå› ä¸ºæ–‡ä»¶çš„æœ¬è´¨å°±æ˜¯å­—èŠ‚æ•°ç»„ï¼Œæ‰€ä»¥åœ¨ä¸€èˆ¬çš„æ“ä½œç³»ç»Ÿä¸­ï¼Œå¯¹äºç‰¹å®šç±»å‹çš„æ–‡ä»¶ï¼Œå…¶å¼€å¤´çš„å‡ ä¸ªå­—èŠ‚éƒ½æ˜¯ç›¸åŒçš„ï¼Œä¾‹å¦‚å¯¹äº <code>JPEG</code> æ ¼å¼çš„æ–‡ä»¶ï¼Œå¼€å¤´çš„å­—èŠ‚éƒ½æ˜¯ <code>\xff\xd8\xff</code> ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¯»å–æ–‡ä»¶å¼€å¤´çš„å­—èŠ‚æ¥ç¡®å®šæ–‡ä»¶çš„ç±»å‹ï¼Œè¿™ç§æ–¹æ³•å‡†ç¡®æ€§æ›´é«˜ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å‡†å¤‡ä¸€ä¸ªé­”æœ¯æ•°åˆ°ç±»å‹çš„å­—å…¸ï¼Œæ³¨æ„ï¼Œè¿™é‡Œåªåˆ—ä¸¾äº†å‡ ä¸ªä¾‹å­ï¼Œè¿˜å¯ä»¥æŒ‰ç…§è¿™æ ·çš„æ ¼å¼å¢åŠ å­—å…¸é¡¹ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> magicNumber = <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span> &#123;</span><br><span class="line">    <span class="string">"\xff\xd8\xff"</span>:      <span class="string">"image/jpeg"</span>,</span><br><span class="line">    <span class="string">"\x89PNG\r\n\x1a\n"</span>: <span class="string">"image/png"</span>,</span><br><span class="line">    <span class="string">"GIF87a"</span>:            <span class="string">"image/gif"</span>,</span><br><span class="line">    <span class="string">"GIF89a"</span>:            <span class="string">"image/gif"</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getFileType</span><span class="params">(incipit []<span class="keyword">byte</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    incipitStr := <span class="keyword">string</span>(incipit)</span><br><span class="line">    <span class="keyword">for</span> magic, mime := <span class="keyword">range</span> magicNumber &#123;</span><br><span class="line">        <span class="keyword">if</span> strings.HasPrefix(incipitStr, magic) &#123;</span><br><span class="line">            <span class="keyword">return</span> mime</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœŸæ­£åŒ¹é…æ ¼å¼çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œéå† <code>magicNumber</code> è¿™ä¸ª <code>map</code> ï¼Œåˆ¤æ–­æ¯ä¸ª <code>key</code> æ˜¯ä¸æ˜¯æŸä¸ªå­—ç¬¦ä¸²çš„å‰ç¼€ï¼Œå› ä¸ºé­”æœ¯æ•°ç¬¦åˆå‰ç¼€ç¼–ç çš„ç‰¹ç‚¹ï¼Œå³ä»»ä½•ä¸€ä¸ªç¼–ç éƒ½ä¸æ˜¯å¦ä¸€ä¸ªç¼–ç çš„å‰ç¼€ï¼Œæ‰€ä»¥æˆ‘ä»¬èƒ½ä¿è¯åˆ¤æ–­æ–‡ä»¶ç±»å‹æ—¶ï¼Œä¸ä¼šæœ‰äºŒä¹‰ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    filepath := os.Args[<span class="number">1</span>]</span><br><span class="line">    file, err := os.Open(filepath)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> file.Close()</span><br><span class="line"></span><br><span class="line">    buff := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">512</span>)</span><br><span class="line">    _, err = file.Read(buff)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    file.Seek(<span class="number">0</span>, os.SEEK_SET)</span><br><span class="line">    typ := getFileType(buff)</span><br><span class="line">    fmt.Println(typ)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Magic-Number&quot;&gt;&lt;a href=&quot;#Magic-Number&quot; class=&quot;headerlink&quot; title=&quot;Magic Number&quot;&gt;&lt;/a&gt;Magic Number&lt;/h1&gt;&lt;p&gt;å¾®ç¬‘.jpgï¼Œè¿™é‡Œå¹´è½»äººä»¬èŠå¤©æ—¶ç»å¸¸ä½¿ç”¨çš„è¯´æ³•ï¼Œä½†æ˜¯ï¼ä½œä¸ºä¸€
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Raft</title>
    <link href="https://oceanoverflow.github.io/2018/06/03/Raft/"/>
    <id>https://oceanoverflow.github.io/2018/06/03/Raft/</id>
    <published>2018-06-03T12:59:23.000Z</published>
    <updated>2018-06-03T13:01:25.668Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Raft"><a href="#Raft" class="headerlink" title="Raft"></a>Raft</h1><ul><li>Raft stands for Replicated and Fault Tolerant</li><li>Raft is something you can build out of a collection of logs</li><li>Raft is something you can use to get away from the island of Paxos</li></ul><h2 id="Goal-Replicated-Log"><a href="#Goal-Replicated-Log" class="headerlink" title="Goal: Replicated Log"></a>Goal: Replicated Log</h2><ul><li>Replicated log =&gt; replicated state machine<ul><li>All servers execute same commands in same order</li></ul></li><li>Consensus module ensures proper log replication</li><li>System makes progress as long as any majority of servers are up</li><li>Failure model: fail-stop(not Byzantine), delayed/lost messages    </li></ul><h2 id="Approaches-to-Consensus"><a href="#Approaches-to-Consensus" class="headerlink" title="Approaches to Consensus"></a>Approaches to Consensus</h2><p>Two possible approaches to consensus:</p><ul><li>Symmetric, leader-less:<ul><li>All servers have equal roles</li><li>Clients can contact any server </li></ul></li><li>Asymmetric, leader-based:<ul><li>At any given time, one server is in charge, others accept its decision</li><li>Clients communicate with the leader </li></ul></li><li>Raft uses a leader:<ul><li>Decomposes the problem (normal operation, leader changes)</li><li>Simplifies normal operation (no conflicts)</li><li>More efficient than leader-less approaches  </li></ul></li></ul><h2 id="Leader-Election"><a href="#Leader-Election" class="headerlink" title="Leader Election"></a>Leader Election</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">                  +------------------+</span><br><span class="line">                  | Become Candidate |</span><br><span class="line">                  +------------------+</span><br><span class="line">                           |</span><br><span class="line">                           v</span><br><span class="line">                   +---------------+    timeout</span><br><span class="line">                   | currentTerm++ |&lt;--------------+</span><br><span class="line">                   | vote for self |               |</span><br><span class="line">                   +---------------+               |</span><br><span class="line">                           |                       |</span><br><span class="line">                           v                       |</span><br><span class="line">               +-----------------------+           |</span><br><span class="line">               | Send RequestVote RPCs |-----------+</span><br><span class="line">               |    to other servers   |</span><br><span class="line">               +-----------------------+</span><br><span class="line">votes from majority |              | RPC from Leader</span><br><span class="line">                    v              v</span><br><span class="line">           +----------------+  +---------+</span><br><span class="line">           | Become Leader, |  | Become  |</span><br><span class="line">           | send heartbeats|  | Follower|</span><br><span class="line">           +----------------+  +---------+</span><br></pre></td></tr></table></figure><ul><li>Safety: allow at most one winner per term<ul><li>Each server gives only one vote per term(persist on disk)</li><li>Majority required to win election</li></ul></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">   B can&apos;t also                  Voted for</span><br><span class="line">   get majority                candidate A</span><br><span class="line">+-----------------+     +-------------------------+</span><br><span class="line">| +-----+ +-----+ |     | +-----+ +-----+ +-----+ |     </span><br><span class="line">| |     | |     | |     | |     | |     | |     | | </span><br><span class="line">| +-----+ +-----+ |     | +-----+ +-----+ +-----+ |</span><br><span class="line">+-----------------+     +-------------------------+</span><br><span class="line">                  Servers</span><br></pre></td></tr></table></figure><ul><li>Livebess: some candidate must eventually win<ul><li>Choose election timeout randomly in [T, 2T] (e.g. 150-300ms)</li><li>One server usually times out and wins election before others time out</li><li>Works well if T &gt;&gt; broadcast time</li></ul></li></ul><p>Randomized approach simpler than ranking</p><h2 id="Normal-Operation"><a href="#Normal-Operation" class="headerlink" title="Normal Operation"></a>Normal Operation</h2><ul><li>Client sends command to leader</li><li>Leader appends command to its log</li><li>Leader send AppendEntries RPCs to all followers</li><li>Once new entry committed<ul><li>Leader executes command in its state machine, returns result to client</li><li>Leader notifies followers of committed entries in subsequent AppendEntries RPCs</li><li>Followers execute committed commands in their state machines  </li></ul></li><li>Crashed/slow followers<ul><li>Leader retries AppendEntries RPCs until they succeed</li></ul></li><li>Optimal performance in common case:<ul><li>One successful RPC to any majority of servers</li></ul></li></ul><h2 id="Log-Structure"><a href="#Log-Structure" class="headerlink" title="Log Structure"></a>Log Structure</h2><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Command <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Log <span class="keyword">struct</span> &#123;</span><br><span class="line">    Term <span class="keyword">int</span></span><br><span class="line">    Command Command</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Logs []Log</span><br></pre></td></tr></table></figure><ul><li>Must survive crashes (store on disk)</li><li>Entry committed if safe to execute in state machines<ul><li>Replicated on majority of servers by leader of its term</li></ul></li></ul><h2 id="Log-Inconsistencies"><a href="#Log-Inconsistencies" class="headerlink" title="Log Inconsistencies"></a>Log Inconsistencies</h2><p>Crashes can result in log inconsistencies</p><ul><li>Raft minimizes special code for repairing inconsistencies<ul><li>Leader assumes its log is correct</li><li>Normal operation will repair all inconsistencies </li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Raft&quot;&gt;&lt;a href=&quot;#Raft&quot; class=&quot;headerlink&quot; title=&quot;Raft&quot;&gt;&lt;/a&gt;Raft&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;Raft stands for Replicated and Fault Tolerant&lt;/li&gt;
&lt;li&gt;R
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Replicated Service Client</title>
    <link href="https://oceanoverflow.github.io/2018/06/02/ReplicatedServiceClient/"/>
    <id>https://oceanoverflow.github.io/2018/06/02/ReplicatedServiceClient/</id>
    <published>2018-06-02T07:01:00.000Z</published>
    <updated>2018-06-02T07:06:46.524Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Replicated-Service-Client"><a href="#Replicated-Service-Client" class="headerlink" title="Replicated Service Client"></a>Replicated Service Client</h1><p>Self-explanatory :-)<br>Actually cause I feel lazy today.</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ReplicatedClient <span class="keyword">interface</span> &#123;</span><br><span class="line">    <span class="comment">// Init initializes the client to use the given servers.</span></span><br><span class="line">    <span class="comment">// To make a particular request later,</span></span><br><span class="line">    <span class="comment">// the client can use callOne(srv, args), where srv </span></span><br><span class="line">    <span class="comment">// is one of the servers from the list</span></span><br><span class="line">    Init(servers []<span class="keyword">string</span>, callOne(<span class="keyword">string</span>, Args) Reply)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Call makes a request to an available server.</span></span><br><span class="line">    <span class="comment">// Multiple gouroutines may call Call concurrently.</span></span><br><span class="line">    Call(args Args) Reply </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Client <span class="keyword">struct</span> &#123;</span><br><span class="line">    servers []<span class="keyword">string</span></span><br><span class="line">    callOne <span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">string</span>, Args)</span> <span class="title">Reply</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">mu</span> <span class="title">sync</span>.<span class="title">Mutex</span></span></span><br><span class="line"><span class="function">    <span class="title">prefer</span> <span class="title">int</span></span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="params">(c *Client)</span> <span class="title">Init</span><span class="params">(servers []<span class="keyword">string</span>, callOne <span class="keyword">func</span>(<span class="keyword">string</span>, Args)</span> <span class="title">Reply</span>)</span> &#123;</span><br><span class="line">    c.servers = servers</span><br><span class="line">    c.callOne = callOne</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Client)</span> <span class="title">Call</span><span class="params">(args Args)</span> <span class="title">Reply</span></span> &#123;</span><br><span class="line">    <span class="keyword">type</span> result <span class="keyword">struct</span> &#123;</span><br><span class="line">        serverID <span class="keyword">int</span></span><br><span class="line">        reply Reply</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> timeout = <span class="number">1</span> * time.Second</span><br><span class="line">    t := time.NewTimer(timeout)</span><br><span class="line">    <span class="keyword">defer</span> t.Stop()</span><br><span class="line"></span><br><span class="line">    done := <span class="built_in">make</span>(<span class="keyword">chan</span> result, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    c.mu.Lock()</span><br><span class="line">    prefer := c.prefer</span><br><span class="line">    c.mu.Unlock()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> r result</span><br><span class="line">    <span class="keyword">for</span> off := <span class="number">0</span>; off &lt; <span class="built_in">len</span>(c.servers); off++ &#123;</span><br><span class="line">        id := (prefer + off) % <span class="built_in">len</span>(c.servers)</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            done &lt;- result&#123;id, c.callOne(c.servers[id], args)&#125;</span><br><span class="line">        &#125;()</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> r = &lt;-done:</span><br><span class="line">            goro Done</span><br><span class="line">        <span class="keyword">case</span> &lt;-t.C:</span><br><span class="line">            t.Reset(timeout)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Done:</span><br><span class="line">    c.mu.Lock()</span><br><span class="line">    c.prefer = r.serverID</span><br><span class="line">    c.mu.Unlock()</span><br><span class="line">    <span class="keyword">return</span> r.reply  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Replicated-Service-Client&quot;&gt;&lt;a href=&quot;#Replicated-Service-Client&quot; class=&quot;headerlink&quot; title=&quot;Replicated Service Client&quot;&gt;&lt;/a&gt;Replicated 
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Semaphore</title>
    <link href="https://oceanoverflow.github.io/2018/06/01/Semaphore/"/>
    <id>https://oceanoverflow.github.io/2018/06/01/Semaphore/</id>
    <published>2018-06-01T13:07:44.000Z</published>
    <updated>2018-06-01T13:42:30.973Z</updated>
    
    <content type="html"><![CDATA[<p>ç°åœ¨è¦å®Œæˆä¸€ä¸ªéå¸¸ç®€å•çš„ä»»åŠ¡ï¼Œç»™å®šå¾ˆå¤šå›¾ç‰‡çš„ <code>URL</code> ï¼Œå°†å®ƒä»¬ä¸‹è½½åˆ°æœ¬åœ°ï¼Œä½ ä¼šæ€ä¹ˆåšï¼Ÿ</p><h2 id="Sequential"><a href="#Sequential" class="headerlink" title="Sequential"></a>Sequential</h2><p>å¦‚æœä½ æƒ³ä¹Ÿä¸æƒ³ï¼Œå°±å†™ä¸‹äº†ä¸‹é¢è¿™ç§ä»£ç ï¼Œè¯´æ˜ä½ æ˜¯ä¸€ä¸ªèƒ½å¹²æ´»çš„ç¨‹åºå‘˜ï¼Œä½†è¿™å¹¶ä¸æ„å‘³ç€ä½ æ˜¯ä¸€ä¸ªä¼˜ç§€çš„ç¨‹åºå‘˜ã€‚ä¸‹é¢çš„ä»£ç è™½ç„¶æ²¡æœ‰ä»€ä¹ˆè‡´å‘½çš„é”™è¯¯ï¼Œä½†æ˜¯æ•ˆç‡éå¸¸ä½ï¼Œç¨‹åºè¿è¡Œæ—¶ <code>CPU</code> å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨ç­‰å¾…ç½‘ç»œ <code>I/O</code> è€Œå¤„äºç©ºé—²çŠ¶æ€ï¼Œå¯¼è‡´ <code>CPU</code> çš„åˆ©ç”¨ç‡éå¸¸ä½ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> idx, task := <span class="keyword">range</span> tasks &#123;</span><br><span class="line">    <span class="keyword">if</span> err := Do(idx, task); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Parallel"><a href="#Parallel" class="headerlink" title="Parallel"></a>Parallel</h2><p>è¿™ç§å®Œå…¨ç”±ç›¸äº’ç‹¬ç«‹çš„å­ä»»åŠ¡ç»„æˆçš„ä»»åŠ¡ï¼Œè¢«ç§°ä¸º <em>embarrassingly parallel</em> ï¼Œè¿™ç§é—®é¢˜å¯ä»¥é€šè¿‡å¹¶è¡Œçš„æ–¹æ³•æé«˜ç¨‹åºçš„æ€§èƒ½ï¼Œè€Œä¸”å¹¶è¡Œç¨‹åº¦è¶Šé«˜ï¼Œæ€§èƒ½è¶Šå¥½ï¼Œåœ¨ç¨‹åºä¸­æˆ‘ä»¬é€šè¿‡æ·»åŠ  <code>go</code> è¿™ä¸ªå…³é”®å­—æ¥åˆ›å»ºå¤šä¸ª <code>goroutine</code> ï¼Œä½¿å¤šä¸ªå­ä»»åŠ¡å¹¶å‘æ‰§è¡Œï¼Œä»¥å‡å°‘ç½‘ç»œ <code>I/O</code> å»¶è¿Ÿï¼Œæé«˜ <code>CPU</code> çš„åˆ©ç”¨ç‡ ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"><span class="keyword">for</span> idx, task := <span class="keyword">range</span> tasks &#123;</span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>, v <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">defer</span> wg.Done()</span><br><span class="line">        <span class="keyword">if</span> err := Do(i, v); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Println(err)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;(idx, task)</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br></pre></td></tr></table></figure><h2 id="Parallel-with-Semaphore"><a href="#Parallel-with-Semaphore" class="headerlink" title="Parallel with Semaphore"></a>Parallel with Semaphore</h2><p>ä½†æ˜¯é€šè¿‡åˆ›å»ºå¤šä¸ª <code>goroutine</code> æé«˜å¹¶è¡Œåº¦ä»è€Œæé«˜æ€§èƒ½çš„æ–¹æ³•æœ‰å…¶å±€é™æ€§ï¼Œä¾‹å¦‚ä¸€æ¬¡æ€§åˆ›å»ºè¿‡å¤šçš„ç½‘ç»œè¿æ¥ï¼Œè¶…å‡ºäº†è¿›ç¨‹æ‰“å¼€æ–‡ä»¶çš„æ•°é‡é™åˆ¶æ—¶ï¼Œç¨‹åºå°±ä¼šæŠ¥é”™ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦é™åˆ¶å•ä½æ—¶é—´å†…å¹¶è¡Œç¨‹åºçš„ä¸ªæ•°ï¼Œé€šè¿‡ä¿¡å·é‡ï¼ˆ <code>semaphore</code> ï¼‰æ¥é™åˆ¶å¹¶è¡Œåº¦ã€‚åœ¨ <code>golang</code> ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®¹é‡ä¸º n çš„ <code>buffered channel</code> æ¥æ¨¡æ‹Ÿ <code>counting semaphore</code> ï¼Œè¿™æ ·ä»¥æ¥åœ¨æ¯ä¸ªå­ä»»åŠ¡æ‰§è¡Œå‰éœ€è¦é€šè¿‡ <code>sem &lt;- struct{}{}</code> æ¥è·å–æ‰§è¡Œè®¸å¯ï¼Œå¦‚æœ <code>sem</code> é€šé“å·²æ»¡ï¼Œè¯´æ˜å½“å‰å·²ç»æœ‰nä¸ªå­ä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œè¯¥æ“ä½œå°±ä¼šé˜»å¡ç­‰å¾…ï¼Œç›´åˆ°é€šé“ç©ºé—²ã€‚å½“ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œä½¿ç”¨ <code>&lt;-sem</code> é‡Šæ”¾æ‰§è¡Œè®¸å¯ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sem := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">8</span>) <span class="comment">// 8 jobs at once</span></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"><span class="keyword">for</span> idx, task := <span class="keyword">range</span> tasks &#123;</span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>, v <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">defer</span> wg.Done()</span><br><span class="line">        sem &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">        <span class="keyword">if</span> err := Do(i, v); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Println(err)</span><br><span class="line">        &#125;</span><br><span class="line">        &lt;-sem</span><br><span class="line">    &#125;(idx, task)</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line"><span class="built_in">close</span>(sem)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ç°åœ¨è¦å®Œæˆä¸€ä¸ªéå¸¸ç®€å•çš„ä»»åŠ¡ï¼Œç»™å®šå¾ˆå¤šå›¾ç‰‡çš„ &lt;code&gt;URL&lt;/code&gt; ï¼Œå°†å®ƒä»¬ä¸‹è½½åˆ°æœ¬åœ°ï¼Œä½ ä¼šæ€ä¹ˆåšï¼Ÿ&lt;/p&gt;
&lt;h2 id=&quot;Sequential&quot;&gt;&lt;a href=&quot;#Sequential&quot; class=&quot;headerlink&quot; title=&quot;Sequenti
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Memory Mapped File</title>
    <link href="https://oceanoverflow.github.io/2018/05/31/MemoryMappedFile/"/>
    <id>https://oceanoverflow.github.io/2018/05/31/MemoryMappedFile/</id>
    <published>2018-05-31T11:05:38.000Z</published>
    <updated>2018-05-31T12:01:30.567Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Memory-Mapped-File"><a href="#Memory-Mapped-File" class="headerlink" title="Memory Mapped File"></a>Memory Mapped File</h1><p>å†…å­˜æ˜ å°„æ–‡ä»¶( <code>memory mapped file</code> )ä¸ç£ç›˜ä¸Šçš„æ–‡ä»¶å­˜åœ¨ç›´æ¥çš„å¯¹åº”å…³ç³»ã€‚å†…å­˜æ˜ å°„ <code>I/O</code> å°†ç£ç›˜ä¸Šçš„æ–‡ä»¶æ˜ å°„åˆ°ç”¨æˆ·è¿›ç¨‹åœ°å€ç©ºé—´ä¸­ï¼Œè¿™æ ·ï¼Œå½“æˆ‘ä»¬ä»æ˜ å°„å†…å­˜ä¸­è·å–å­—èŠ‚æ—¶ï¼Œä¼šè¯»å–æ–‡ä»¶çš„ç›¸åº”å­—èŠ‚ã€‚åŒæ ·çš„ï¼Œå½“æˆ‘ä»¬å°†æ•°æ®å­˜å‚¨åœ¨æ˜ å°„å†…å­˜ä¸­æ—¶ï¼Œç›¸åº”çš„å­—èŠ‚ä¼šè‡ªåŠ¨å†™å…¥æ–‡ä»¶ä¸­ã€‚è¿™æ ·ä»¥æ¥å°±å¯ä»¥åœ¨ä¸ä½¿ç”¨ <code>read()</code> æˆ– <code>write()</code> ç³»ç»Ÿè°ƒç”¨çš„æƒ…å†µä¸‹æ‰§è¡Œ <code>I/O</code> æ“ä½œ ã€‚</p><p><img src="http://www.tutorialsdaddy.com/wp-content/uploads/2016/11/linux-mmap.png" alt="mmap"></p><h2 id="mmap-amp-munmap"><a href="#mmap-amp-munmap" class="headerlink" title="mmap &amp; munmap"></a>mmap &amp; munmap</h2><p><code>mmap</code> ç³»ç»Ÿè°ƒç”¨å°†æ–‡ä»¶æˆ–è®¾å¤‡æ˜ å°„åˆ°å†…å­˜ä¸­ï¼Œå½“è°ƒç”¨æˆåŠŸæ—¶ï¼Œå®ƒä¼šè¿”å›æ˜ å°„å†…å­˜çš„èµ·å§‹åœ°å€ã€‚ç¬¬ä¸€ä¸ªå‚æ•° <code>addr</code> è¡¨ç¤ºæ–‡ä»¶è¦æ˜ å°„åˆ°å†…å­˜ä¸­çš„è™šæ‹Ÿåœ°å€ï¼Œä¸€èˆ¬éƒ½ä¸º <code>NULL</code> ï¼Œè¡¨ç¤ºç”±å†…æ ¸å†³å®šåˆé€‚çš„æ˜ å°„åœ°å€ã€‚ç¬¬äºŒä¸ªå‚æ•° <code>len</code> æŒ‡å®šæ˜ å°„çš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œå†…æ ¸åˆ›å»ºçš„æ˜ å°„å†…å­˜çš„å¤§å°æ˜¯å†…å­˜é¡µé¢å¤§å°çš„æ•´æ•°å€ã€‚ç¬¬ä¸‰ä¸ªå‚æ•° <code>prot</code> æŒ‡å®šè®¿é—®æƒé™ï¼Œå¯ä»¥æ˜¯ <code>PROT_READ</code>ï¼Œ<code>PROT_WRITE</code> ï¼Œ<code>PROT_EXEC</code> ã€‚ç¬¬å››ä¸ªå‚æ•° <code>flags</code> å¯ä»¥æ˜¯ <code>MAP_PRIVATE</code>ï¼Œ<code>MAP_SHARED</code> ã€‚ç¬¬äº”ä¸ªå‚æ•° <code>fd</code> æ ‡è¯†æ˜ å°„æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ã€‚ç¬¬å…­ä¸ªå‚æ•° <code>offset</code> æŒ‡å®šäº†æ–‡ä»¶æ˜ å°„çš„èµ·ç‚¹ã€‚ä¸ºäº†æ˜ å°„æ•´ä¸ªæ–‡ä»¶ï¼Œæˆ‘ä»¬å°† <code>offset</code> æŒ‡å®šä¸º0ï¼Œå°† <code>len</code> æŒ‡å®šä¸ºæ•´ä¸ªæ–‡ä»¶çš„å¤§å°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> *</span><br><span class="line">mmap(<span class="keyword">void</span> *addr, <span class="keyword">size_t</span> len, <span class="keyword">int</span> prot, <span class="keyword">int</span> flags, <span class="keyword">int</span> fd, <span class="keyword">off_t</span> offset);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> </span><br><span class="line">munmap(<span class="keyword">void</span> *addr, <span class="keyword">size_t</span> len);</span><br></pre></td></tr></table></figure><p>Golangä¸­ç³»ç»Ÿè°ƒç”¨å‚æ•°æœ‰äº›è®¸ä¸åŒï¼Œä½†æœ¬è´¨æ˜¯ä¸€æ ·çš„ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> syscall</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Mmap</span><span class="params">(fd <span class="keyword">int</span>, offset <span class="keyword">int64</span>, length <span class="keyword">int</span>, prot <span class="keyword">int</span>, flags <span class="keyword">int</span>)</span> <span class="params">(data []<span class="keyword">byte</span>, err error)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">Munmap</span><span class="params">(b []<span class="keyword">byte</span>)</span> <span class="params">(err error)</span></span></span><br></pre></td></tr></table></figure><h2 id="GPIO"><a href="#GPIO" class="headerlink" title="GPIO"></a>GPIO</h2><p>å½“ç„¶äº†ï¼Œå¦‚æœå…‰ä»‹ç» <code>mmap</code> è¿™ä¸ªç³»ç»Ÿè°ƒç”¨å°±å¤ªæ— èŠäº†ï¼Œæˆ‘ä»¬ä¸‹é¢æ¥çœ‹ä¸€ä¸‹ <code>mmap</code> èƒ½å¸®åŠ©æˆ‘ä»¬å¹²ä»€ä¹ˆäº‹æƒ…ï¼Œå¦‚æœä½ ç©æ ‘è“æ´¾çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ <code>mmap</code> æ¥å†™ä¸€ä¸ª <code>GPIO</code> é©±åŠ¨ã€‚</p><p><img src="https://cdn.shopify.com/s/files/1/2187/3161/products/450ba4cc5f96d682fde154a5e569ebf4_1024x.png?v=1520446011" alt="RasberryPi"></p><p>åœ¨æ ‘è“æ´¾çš„ <code>/dev</code> ç›®å½•ä¸‹å­˜åœ¨ <code>mem</code> å’Œ <code>gpiomem</code> è¿™ä¸¤ä¸ªæ–‡ä»¶ã€‚é€šè¿‡ <code>mmap</code> <code>/dev/gpiomem</code> æ–‡ä»¶æˆ‘ä»¬å¯ä»¥åœ¨æ²¡æœ‰ <code>root</code> æƒé™çš„æƒ…å†µä¸‹è®¿é—® <code>GPIO</code> å¯„å­˜å™¨ã€‚æ‰“å¼€ <code>/dev/gpiomem</code> è®¾å¤‡æ–‡ä»¶å¹¶ä½¿ç”¨ <code>mmap()</code> å‡½æ•°å¯å°† <code>GPIO</code> å¯„å­˜å™¨æ˜ å°„åˆ°è¿›ç¨‹å†…å­˜ç©ºé—´ä¸­å»ã€‚<code>/dev/mem</code> ä»£è¡¨æ•´ä¸ªç³»ç»Ÿçš„å†…å­˜ç©ºé—´ã€‚<code>/dev/gpiomem</code> ä»…å…è®¸è®¿é—® <code>GPIO</code> å¤–è®¾å¯„å­˜å™¨ï¼Œ <code>/dev/mem</code> å…è®¸è®¿é—®æ‰€æœ‰å¤–è®¾å¯„å­˜å™¨ä»¥åŠæ‰€æœ‰å†…å­˜ï¼Œç›¸å¯¹æ¥è¯´æ›´åŠ å±é™©ã€‚ä¸ºäº†ä¿æŠ¤å†…å­˜ç©ºé—´ï¼Œæœ€å¥½ä½¿ç”¨ <code>/dev/gpiomem</code> è€Œé <code>/dev/mem</code> æ¥æ§åˆ¶ <code>GPIO</code> å¯„å­˜å™¨ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">          Rev 2 and 3 Raspberry Pi </span><br><span class="line">+-----+---------+----------+---------+-----+</span><br><span class="line">| BCM |   Name  | Physical | Name    | BCM |</span><br><span class="line">+-----+---------+----++----+---------+-----+ </span><br><span class="line">|     |    3.3v |  1 || 2  | 5v      |     |</span><br><span class="line">|   2 |   SDA 1 |  3 || 4  | 5v      |     | </span><br><span class="line">|   3 |   SCL 1 |  5 || 6  | 0v      |     |</span><br><span class="line">|   4 | GPIO  7 |  7 || 8  | TxD     | 14  |</span><br><span class="line">|     |      0v |  9 || 10 | RxD     | 15  | </span><br><span class="line">|  17 | GPIO  0 | 11 || 12 | GPIO  1 | 18  | </span><br><span class="line">|  27 | GPIO  2 | 13 || 14 | 0v      |     |</span><br><span class="line">|  22 | GPIO  3 | 15 || 16 | GPIO  4 | 23  |</span><br><span class="line">|     |    3.3v | 17 || 18 | GPIO  5 | 24  |  </span><br><span class="line">|  10 |    MOSI | 19 || 20 | 0v      |     |  </span><br><span class="line">|   9 |    MISO | 21 || 22 | GPIO  6 | 25  | </span><br><span class="line">|  11 |    SCLK | 23 || 24 | CE0     | 8   |</span><br><span class="line">|     |      0v | 25 || 26 | CE1     | 7   | </span><br><span class="line">|   0 |   SDA 0 | 27 || 28 | SCL 0   | 1   | </span><br><span class="line">|   5 | GPIO 21 | 29 || 30 | 0v      |     |</span><br><span class="line">|   6 | GPIO 22 | 31 || 32 | GPIO 26 | 12  |</span><br><span class="line">|  13 | GPIO 23 | 33 || 34 | 0v      |     |</span><br><span class="line">|  19 | GPIO 24 | 35 || 36 | GPIO 27 | 16  |</span><br><span class="line">|  26 | GPIO 25 | 37 || 38 | GPIO 28 | 20  |</span><br><span class="line">|     |      0v | 39 || 40 | GPIO 29 | 21  |</span><br><span class="line">+-----+---------+----++----+---------+-----+</span><br></pre></td></tr></table></figure><p>å¦‚æœé€šè¿‡ <code>/dev/mem</code> è®¿é—® <code>GPIO</code> å¤–è®¾å¯„å­˜å™¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦ç¡®å®šå…¶å†…å­˜ä¸­çš„åŸºåœ°å€ï¼Œæˆ‘ä»¬é€šè¿‡è¯»å– <code>/proc/device-tree/soc/ranges</code> æ¥ç¡®å®šåŸºåœ°å€ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    bcm2835Base = <span class="number">0x20000000</span></span><br><span class="line">    gpioOffset  = <span class="number">0x200000</span></span><br><span class="line">    memLength = <span class="number">4096</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> gpioBase <span class="keyword">int64</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    memLock sync.Mutex</span><br><span class="line">    gpioMem  []<span class="keyword">byte</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    base := getBase()</span><br><span class="line">    gpioBase = base + gpioOffset </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getBase</span><span class="params">()</span> <span class="params">(base <span class="keyword">int64</span>)</span></span> &#123;</span><br><span class="line">    base = bcm2835Base</span><br><span class="line">    ranges, err := os.Open(<span class="string">"/proc/device-tree/soc/ranges"</span>)</span><br><span class="line">    <span class="keyword">defer</span> ranges.Close()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    b := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">4</span>)</span><br><span class="line">    n, err := ranges.ReadAt(b, <span class="number">4</span>)</span><br><span class="line">    <span class="keyword">if</span> n != <span class="number">4</span> || err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    buf := bytes.NewReader(b)</span><br><span class="line">    <span class="keyword">var</span> out <span class="keyword">uint32</span></span><br><span class="line">    err = binary.Read(buf, binary.BigEndian, &amp;out)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">int64</span>(out)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> <code>Open</code> å‡½æ•°é€šè¿‡æ˜ å°„ <code>/dev/mem</code> æ–‡ä»¶æ¥å°† <code>GPIO</code> å¯„å­˜å™¨æ˜ å°„åˆ°å†…å­˜ä¸­ï¼Œè¿™æ ·ä»¥æ¥æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ç›´æ¥æ”¹å˜ <code>gpioMem</code> çš„å€¼æ¥æ“æ§ <code>GPIO</code> å¯„å­˜å™¨äº†ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Open</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="comment">// Open fd for rw mem access; try dev/mem first (need root)</span></span><br><span class="line">    file, err := os.OpenFile(<span class="string">"/dev/mem"</span>, os.O_RDWR|os.O_SYNC, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> os.IsPermission(err) &#123;</span><br><span class="line">        <span class="comment">// try gpiomem otherwise (some extra functions like clock and pwm setting wont work)</span></span><br><span class="line">        file, err = os.OpenFile(<span class="string">"/dev/gpiomem"</span>, os.O_RDWR|os.O_SYNC, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// FD can be closed after memory mapping</span></span><br><span class="line">    <span class="keyword">defer</span> file.Close()</span><br><span class="line"></span><br><span class="line">    memLock.Lock()</span><br><span class="line">    <span class="keyword">defer</span> memLock.Unlock()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Memory map GPIO registers to slice</span></span><br><span class="line">    gpioMem, err = syscall.Mmap(</span><br><span class="line">        <span class="keyword">int</span>(file.Fd()),</span><br><span class="line">        gpioBase,</span><br><span class="line">        memLength,</span><br><span class="line">        syscall.PROT_READ|syscall.PROT_WRITE,</span><br><span class="line">        syscall.MAP_SHARED,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Close</code> å‡½æ•°ä½¿ç”¨ <code>syscall.Munmap</code> ç³»ç»Ÿè°ƒç”¨æ¥è§£é™¤å†…å­˜æ˜ å°„ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Close</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    memLock.Lock()</span><br><span class="line">    <span class="keyword">defer</span> memLock.Unlock()</span><br><span class="line">    <span class="keyword">if</span> err := syscall.Munmap(mem); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Memory-Mapped-File&quot;&gt;&lt;a href=&quot;#Memory-Mapped-File&quot; class=&quot;headerlink&quot; title=&quot;Memory Mapped File&quot;&gt;&lt;/a&gt;Memory Mapped File&lt;/h1&gt;&lt;p&gt;å†…å­˜æ˜ å°„æ–‡ä»¶
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Protocol Multiplexer</title>
    <link href="https://oceanoverflow.github.io/2018/05/29/ProtocolMultiplexer/"/>
    <id>https://oceanoverflow.github.io/2018/05/29/ProtocolMultiplexer/</id>
    <published>2018-05-29T11:50:23.000Z</published>
    <updated>2018-05-29T13:22:16.080Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Protocol-Multiplexer"><a href="#Protocol-Multiplexer" class="headerlink" title="Protocol Multiplexer"></a>Protocol Multiplexer</h1><p>å‡è®¾æˆ‘ä»¬è¦å®ç°ä¸€ä¸ª <code>RPC</code> æ¡†æ¶å¹¶ä¸”æ¯ä¸ªå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨åªç»´æŠ¤ä¸€æ ¹ <code>TCP</code> è¿æ¥ï¼Œä½†å®¢æˆ·ç«¯å¯èƒ½ä¼šåŒæ—¶å‘å‡ºå¾ˆå¤š <code>RPC</code> è¯·æ±‚ï¼ŒæœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚å¤„ç†åå°†ç»“æœè¿”è¿˜ç»™å®¢æˆ·ç«¯ï¼Œç°åœ¨é—®é¢˜æ¥äº†ï¼Œç”±äºåªæœ‰ä¸€æ ¹ <code>TCP</code> è¿æ¥ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°çš„ç»“æœå¯èƒ½æ˜¯ä¹±åºçš„ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•å°†è¯·æ±‚å’Œç­”å¤å¯¹åº”èµ·æ¥å‘¢ï¼Œå¦‚æœé‡‡å–åŒæ­¥çš„æ–¹æ³•å€’æ˜¯ä¸ç”¨æ‹…å¿ƒä¹±åºçš„é—®é¢˜ï¼Œä½†æ˜¯æ•ˆç‡è‚¯å®šéå¸¸ä½ï¼ŒåŒæ­¥å¯¼è‡´ç³»ç»Ÿå¤§éƒ¨åˆ†æ—¶é—´åœ¨ç­‰å¾… <code>I/O</code> ï¼Œä¸ºäº†æé«˜ <code>CPU</code> çš„åˆ©ç”¨ç‡ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨å¤šè·¯å¤ç”¨çš„æ–¹æ³•ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ProtocolMux <span class="keyword">interface</span> &#123;</span><br><span class="line">    <span class="comment">// Init initializes the mux to manage messages to the given service.</span></span><br><span class="line">    Init(Service)</span><br><span class="line">    <span class="comment">// Call makes a request with the given message and returns the reply.</span></span><br><span class="line">    <span class="comment">// Multiple goroutines may call Call concurrently.</span></span><br><span class="line">    Call(Msg) Msg</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Service</code> æ¥å£ä»…ä»…æŒ‡æ˜äº†æœåŠ¡éœ€è¦å®ç°çš„æ¥å£ï¼Œè¿™äº›æœåŠ¡å®é™…å°±æ˜¯å¯¹ç½‘ç»œåº“çš„å°è£…ï¼Œå¯ä»¥æ˜¯ <code>TCP</code> æˆ–è€… <code>UDP</code> ï¼Œ<code>Send</code> å’Œ <code>Recv</code> æ–¹æ³•ä¸èƒ½åœ¨å¹¶å‘æ¡ä»¶ä¸‹ä½¿ç”¨ï¼Œå¹¶å‘ä½¿ç”¨å¯èƒ½ä¼šå¯¼è‡´æ•°æ®ç«äº‰ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Service <span class="keyword">interface</span> &#123;</span><br><span class="line">    <span class="comment">// ReadTag returns the muxing identifier in the request or reply message.</span></span><br><span class="line">    <span class="comment">// Multiple goroutines may call ReadTag concurrently.</span></span><br><span class="line">    ReadTag(Msg) <span class="keyword">int64</span></span><br><span class="line">    <span class="comment">// Send sends a request message to the remote service.</span></span><br><span class="line">    <span class="comment">// Send must not be called concurrently with itself.</span></span><br><span class="line">    Send(Msg)</span><br><span class="line">    <span class="comment">// Recv waits for and returns a reply mesasge from the remote service.</span></span><br><span class="line">    <span class="comment">// Recv must not be called concurrently with itself.</span></span><br><span class="line">    Recv(Msg)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°å¤šè·¯å¤ç”¨çš„æ ¸å¿ƒå°±åœ¨äºä½¿ç”¨ <code>pending</code> è¿™ä¸ª <code>map</code> æ¥å­˜å‚¨è¿˜æœªæ”¶åˆ°ç­”å¤çš„è¯·æ±‚ï¼Œæ¯ä¸€ä¸ªè¯·æ±‚éƒ½æœ‰è‡ªå·±ç‹¬ä¸€æ— äºŒçš„æ ‡ç­¾ï¼ˆä¾‹å¦‚è¯·æ±‚çš„åºåˆ—å·ï¼‰ï¼Œæ¯ä¸ªæ ‡ç­¾å¯¹åº”ä¸€ä¸ªç­”å¤ï¼Œç­”å¤ç”¨é€šé“ <code>chan Msg</code> æ¥è¡¨ç¤ºï¼Œå½“æ”¶åˆ°è¯¥æ ‡ç­¾å¯¹åº”çš„ç­”å¤æ—¶ï¼Œè¯¥é€šé“è¿”å›ç»“æœï¼ˆ <code>&lt;-done</code> ï¼‰ï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯è¯·æ±‚å’Œç­”å¤ä¸€ä¸€å¯¹åº”ï¼Œè€Œä¸ç”¨å…³å¿ƒæ¥æ”¶æ¶ˆæ¯å…ˆåé¡ºåºçš„é—®é¢˜äº†ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Mux <span class="keyword">struct</span> &#123;</span><br><span class="line">    srv     Service</span><br><span class="line">    send    <span class="keyword">chan</span> Msg</span><br><span class="line">    mu      sync.Mutex</span><br><span class="line">    pending <span class="keyword">map</span>[<span class="keyword">int64</span>]<span class="keyword">chan</span>&lt;- Msg</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mux)</span> <span class="title">Init</span><span class="params">(srv Service)</span></span> &#123;</span><br><span class="line">    m.srv = srv</span><br><span class="line">    m.pending = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int64</span>]<span class="keyword">chan</span> Msg)</span><br><span class="line">    <span class="keyword">go</span> m.sendLoop()</span><br><span class="line">    <span class="keyword">go</span> m.recvLoop()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>sendLoop</code> è´Ÿè´£æ¶ˆæ¯çš„å‘é€ï¼Œè€Œ <code>recvLoop</code> åˆ™ä¼šå¯¹æ¥å—åˆ°çš„ç­”å¤è¿›è¡Œåˆ¤æ–­æ ‡ç­¾æ“ä½œï¼Œå¹¶å°† <code>pending</code> ä¸­è¿™ä¸ªæ ‡ç­¾å¯¹åº”çš„é€šé“å–å‡ºï¼Œç„¶åå‘è¿™ä¸ªé€šé“å‘æ¶ˆæ¯ä»è€Œå‘ŠçŸ¥å¯¹åº”çš„ <code>Call</code> å‡½æ•°è¯¥è¯·æ±‚å·²ç»å¤„ç†å®Œã€‚è¿™ä¸¤ä¸ªæ–¹æ³•å°±æ˜¯å¤ç”¨æœºåˆ¶çš„ä½“ç°ï¼Œå› ä¸ºå®ƒä»¬åº•å±‚åªä½¿ç”¨ä¸€ä¸ªè¿æ¥æ¥å¤„ç†å¤šä¸ªè¯·æ±‚ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mux)</span> <span class="title">sendLoop</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> args := <span class="keyword">range</span> m.send &#123;</span><br><span class="line">        m.srv.Send(args)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mux)</span> <span class="title">recvLoop</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        reply := m.srv.Recv()</span><br><span class="line">        tag := m.srv.Tag(reply)</span><br><span class="line">   </span><br><span class="line">        m.mu.Lock()</span><br><span class="line">        done := m.pending[tag]</span><br><span class="line">        m.mu.Unlock()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> done == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="built_in">panic</span>(<span class="string">"unexpected reply"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        done &lt;- reply</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äº <code>Call</code> æ–¹æ³•ï¼Œæ•´ä¸ªè°ƒç”¨è¿‡ç¨‹æ˜¯é˜»å¡çš„ï¼Œå…ˆé€šè¿‡ <code>ReadTag</code> è·å– <code>Msg</code> çš„æ ‡ç­¾ï¼Œå¹¶æ–°å»ºä¸€ä¸ªé€šé“ <code>done := make(chan Msg, 1)</code> ï¼Œä½œä¸ºå°†æ¥äº‹ä»¶å®Œæˆæ—¶çš„é€šçŸ¥ã€‚å¹¶å°†è¯¥é€šé“å­˜å‚¨åˆ° <code>pending</code> ä¸­ï¼Œé€šè¿‡ <code>m.send &lt;- args</code> å°†æ¶ˆæ¯å‘é€åˆ° <code>send</code> ä¸­ï¼Œ<code>sendLoop</code> ä¼šæ‰§è¡ŒçœŸæ­£çš„å‘é€æ“ä½œï¼Œæœ€åé˜»å¡ï¼Œç­‰å¾…ç»“æœè¿”å›ï¼ˆ <code>&lt;-done</code> ï¼‰ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mux)</span> <span class="title">Call</span><span class="params">(args Msg)</span> <span class="params">(reply Msg)</span></span> &#123;</span><br><span class="line">    tag := m.srv.ReadTag(args)</span><br><span class="line">    done := <span class="built_in">make</span>(<span class="keyword">chan</span> Msg, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    m.mu.Lock()</span><br><span class="line">    <span class="keyword">if</span> m.pending[tag] != <span class="literal">nil</span> &#123;</span><br><span class="line">        m.mu.Unlock()</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">"mux: duplicate call tag"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    m.pending[tag] = done</span><br><span class="line">    m.mu.Unlock()</span><br><span class="line">    </span><br><span class="line">    m.send &lt;- args</span><br><span class="line">    <span class="keyword">return</span> &lt;-done</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Protocol-Multiplexer&quot;&gt;&lt;a href=&quot;#Protocol-Multiplexer&quot; class=&quot;headerlink&quot; title=&quot;Protocol Multiplexer&quot;&gt;&lt;/a&gt;Protocol Multiplexer&lt;/h1&gt;&lt;
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Shredder &amp; Gluer</title>
    <link href="https://oceanoverflow.github.io/2018/05/28/Shredder-Gluer/"/>
    <id>https://oceanoverflow.github.io/2018/05/28/Shredder-Gluer/</id>
    <published>2018-05-28T03:38:22.000Z</published>
    <updated>2018-05-28T04:01:48.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Shredder-amp-Gluer"><a href="#Shredder-amp-Gluer" class="headerlink" title="Shredder &amp; Gluer"></a>Shredder &amp; Gluer</h1><p>æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦å‘æœåŠ¡å™¨ä¸Šä¼ ä¸€ä¸ªå¾ˆå¤§çš„æ–‡ä»¶ï¼Œä½†æ˜¯æ— å¥ˆç½‘ç»œä¸ç¨³å®šï¼Œå†åŠ ä¸Šä½¿ç”¨çš„è½¯ä»¶ä¸æ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼Œç»å¸¸ä¼šå‡ºç°æ–‡ä»¶ä¸Šä¼ åˆ°ä¸€åŠå‡ºé”™ï¼Œæ— å¥ˆåªèƒ½ä»å¤´å†æ¥ï¼Œå¯ä»¥è¯´æ˜¯éå¸¸çƒ¦æ¼äº†ã€‚è¿˜æœ‰çš„æ—¶å€™æœåŠ¡å™¨æ˜ç¡®è§„å®šäº†å•æ¬¡ä¸Šä¼ æ–‡ä»¶çš„å¤§å°ï¼Œæ‰‹å¤´åˆæ²¡æœ‰å•¥å¥½çš„è½¯ä»¶å¯ä»¥å¸®åŠ©æˆ‘ä»¬è¿›è¡Œæ–‡ä»¶çš„åˆ†å‰²å’Œåˆå¹¶æ“ä½œï¼Œåªå¥½è‡ªå·±å†™ä¸€ä¸ªã€‚</p><p>è¦æ˜¯ä¸€ä¸ªäººè¢«ç äº†å¤´ï¼Œæ‰‹ï¼Œè„šï¼Œå†æŠŠè¿™å‡ ä¸ªè‚¢ä½“åˆå¹¶èµ·æ¥å¤§æ¦‚ç‡è¿™äººä¹Ÿæ˜¯åºŸäº†ï¼ˆåœ¨åŒ»å­¦æ°´å¹³æ²¡æœ‰æå¤§è¿›æ­¥çš„æƒ…å†µä¸‹ï¼‰ï¼Œä½†æ˜¯å¯¹äºä¸€ä¸ªæ–‡ä»¶æ¥è¯´åˆ™ä¸åŒï¼Œæ— è®ºä»€ä¹ˆæ ¼å¼çš„æ–‡ä»¶ï¼Œå…¶å®æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€å¤§å †å­—èŠ‚ï¼Œå¦‚æœæˆ‘ä»¬åœ¨å›ºå®šçš„åœ°æ–¹è¿›è¡Œåˆ‡å‰²ï¼Œæœ€åå†åœ¨è¢«åˆ‡å‰²çš„åœ°æ–¹åˆå¹¶çš„è¯ï¼Œè¿™ä¸ªæ–‡ä»¶è¿˜æ˜¯å¯ä»¥è¢«æ­£å¸¸ä½¿ç”¨çš„ã€‚</p><h2 id="Get-Basic-Info"><a href="#Get-Basic-Info" class="headerlink" title="Get Basic Info"></a>Get Basic Info</h2><p>åœ¨å¯¹æ–‡ä»¶åˆ‡å‰²ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦è·å¾—æ–‡ä»¶çš„åŸºæœ¬ä¿¡æ¯ï¼Œå³æ–‡ä»¶çš„å¤§å°æˆ–è€…è¯´æ˜¯å­—èŠ‚æ•°ï¼Œè¿˜éœ€è¦å†³å®šåˆ‡å‰²åæ¯ä¸ªå•ä½çš„å¤§å°ï¼ŒçŸ¥é“äº†è¿™ä¸¤ä¸ªå‚æ•°ä¹‹åï¼Œå°±å¯ä»¥ç®—å‡ºæ‰€æœ‰åˆ†å‰²å—çš„æ•°é‡äº†ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">f, err := os.Open(<span class="string">"some_very_big_file"</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br><span class="line">fileInfo, err := f.Stat()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">fileSize := fileInfo.Size()</span><br><span class="line">partSize := <span class="number">1</span> &lt;&lt; <span class="number">28</span></span><br><span class="line">concurrency := <span class="keyword">int</span>(fileSize / <span class="keyword">int64</span>(partSize))</span><br><span class="line"><span class="keyword">if</span> remainder := fileSize % <span class="keyword">int64</span>(partSize); remainder != <span class="number">0</span> &#123;</span><br><span class="line">    concurrency++</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Shredder"><a href="#Shredder" class="headerlink" title="Shredder"></a>Shredder</h2><p>åˆ©ç”¨ <code>io.NewSectionReader</code> å¯ä»¥è¯»å–æ–‡ä»¶ç‰¹å®šåç§»çš„æ•°æ®ï¼Œç„¶ååˆ©ç”¨<code>buffo.NewReader</code> æ¥ç¼“å†²è¯»æ•°æ®ï¼Œåˆ©ç”¨ <code>bufio.NewWriter</code> æ¥ç¼“å†²å†™æ•°æ®æé«˜æ•ˆç‡ï¼Œæœ€ååˆ©ç”¨ <code>io.Copy(bw, br)</code> å°†æ–‡ä»¶ç‰¹å®šéƒ¨åˆ†å¤åˆ¶åˆ°æ–°æ–‡ä»¶ä¸­ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">wg.Add(concurrency)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; concurrency; i++ &#123;</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">defer</span> wg.Done()</span><br><span class="line">        sr := io.NewSectionReader(f, <span class="keyword">int64</span>(i * partSize), <span class="keyword">int64</span>(partSize))</span><br><span class="line">        br := bufio.NewReader(sr)</span><br><span class="line">        partFile, err := os.Create(<span class="string">"partFile_"</span> + strconv.Itoa(i))</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="built_in">panic</span>(err)</span><br><span class="line">        &#125;</span><br><span class="line">        bw := bufio.NewWriter(partFile)</span><br><span class="line">        io.Copy(bw, br)</span><br><span class="line">    &#125;(i)</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br></pre></td></tr></table></figure><h2 id="Gluer"><a href="#Gluer" class="headerlink" title="Gluer"></a>Gluer</h2><p>åˆå¹¶ä¸åˆ†å‰²äº’ä¸ºé€†æ“ä½œï¼Œå› ä¸ºæˆ‘ä»¬å¯¹ä¸Šé¢åˆ†å‰²åçš„æ–‡ä»¶é‡‡å–äº†é¡ºåºå‘½åæ“ä½œï¼Œæ‰€ä»¥å¯ä»¥æ ¹æ®ç¼–å·çš„é¡ºåºï¼Œåˆ©ç”¨ <code>Seek</code> æ–¹æ³•æŒ‡å®šåˆå¹¶æ–‡ä»¶çš„å†™åç§»åœ°å€ï¼Œé€šè¿‡ <code>bufio.NewReader</code> å¯¹åˆ†å‰²æ–‡ä»¶è¿›è¡Œç¼“å†²è¯»æ“ä½œï¼ŒåŒç†åˆ©ç”¨ <code>bufio.NewWriter</code> å¯¹åˆå¹¶æ–‡ä»¶è¿›è¡Œç¼“å†²å†™æ“ä½œï¼Œé€šè¿‡ <code>io.Copy(bw, br)</code> å°†åˆ†å‰²æ–‡ä»¶æ”¾å…¥æœ€ç»ˆåˆå¹¶æ–‡ä»¶çš„æ­£ç¡®ä½ç½®ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">matches, err := filepath.Glob(<span class="string">"partFile_*"</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mergedFile, err := os.Create(<span class="string">"mergedFile"</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> matches &#123;</span><br><span class="line">    ss := strings.Split(v, <span class="string">"_"</span>)</span><br><span class="line">    i, err := strconv.Atoi(ss[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    mergedFile.Seek(<span class="keyword">int64</span>(i * partSize), os.SEEK_SET)</span><br><span class="line">    f, err := os.Open(v)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    br := bufio.NewReader(f)</span><br><span class="line">    bw := bufio.NewWriter(mergedFile)</span><br><span class="line">    io.Copy(bw, br)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Shredder-amp-Gluer&quot;&gt;&lt;a href=&quot;#Shredder-amp-Gluer&quot; class=&quot;headerlink&quot; title=&quot;Shredder &amp;amp; Gluer&quot;&gt;&lt;/a&gt;Shredder &amp;amp; Gluer&lt;/h1&gt;&lt;p&gt;æœ‰æ—¶
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>TUN/TAP</title>
    <link href="https://oceanoverflow.github.io/2018/05/27/TUNTAP/"/>
    <id>https://oceanoverflow.github.io/2018/05/27/TUNTAP/</id>
    <published>2018-05-27T06:05:03.000Z</published>
    <updated>2018-05-27T06:07:19.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="TUNTAP"><a href="#TUNTAP" class="headerlink" title="TUNTAP"></a>TUNTAP</h1><p><a href="http://tuntaposx.sourceforge.net/" target="_blank" rel="noopener">TUN/TAP</a> ä¸ºæˆ‘ä»¬åœ¨ <code>macOS</code> ä¸‹é¢æä¾›äº†è™šæ‹Ÿç½‘ç»œæ¥å£ï¼ˆ <code>TUN/TAP</code> ï¼‰ï¼Œå…¶æœ¬è´¨æ˜¯å­—ç¬¦è®¾å¤‡ï¼ˆ <code>character special file</code> ï¼‰ã€‚å› ä¸ºåœ¨ <code>Unix</code> ä¸­ä¸€åˆ‡çš†æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åƒæ“ä½œæ–‡ä»¶ä¸€æ ·æ“ä½œè¿™ä¸¤ç§è®¾å¤‡ã€‚</p><p><img src="https://1.bp.blogspot.com/-mnxh0kXQeKI/V10lx7q7H4I/AAAAAAAALYs/i427R0SfAQckApSz3piMDu7LiJnPzzu4gCLcB/s1600/tuntap.png" alt="TUNTAP"></p><p><code>TUN</code> æ¨¡æ‹Ÿç½‘ç»œå±‚è®¾å¤‡ï¼Œå®ƒå¯ä»¥æ“ä½œç¬¬3å±‚æ•°æ®åŒ…ä¾‹å¦‚ <code>IP</code> æ•°æ®åŒ…ã€‚ <code>TAP</code> æ¨¡æ‹Ÿé“¾è·¯å±‚è®¾å¤‡ï¼Œç”¨äºæ“ä½œç¬¬2å±‚æ•°æ®åŒ…ä¾‹å¦‚ä»¥å¤ªç½‘å¸§ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> maxDevices = <span class="number">16</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    ErrBusy        = errors.New(<span class="string">"device is already in use"</span>)</span><br><span class="line">  ErrNotReady    = errors.New(<span class="string">"device is not ready"</span>)</span><br><span class="line">  ErrExhausted   = errors.New(<span class="string">"no devices are available"</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Interface <span class="keyword">interface</span> &#123;</span><br><span class="line">    Name() <span class="keyword">string</span></span><br><span class="line">    String() <span class="keyword">string</span></span><br><span class="line">    io.ReadWriteCloser</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Tun</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="params">(Interface, error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> newTUN(name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Tap</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="params">(Interface, error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> newTAP(name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>TUN/TAP</code> åœ¨ <code>/dev</code>ç›®å½•ä¸‹ï¼Œä»¥ <code>/dev/tunX</code> å’Œ <code>/dev/tapX</code> çš„å½¢å¼å­˜åœ¨ï¼Œ<code>X</code> ä»0åˆ°15ã€‚æ¯ä¸ªå­—ç¬¦è®¾å¤‡éƒ½ä¸åŒåçš„ç½‘ç»œæ¥å£å…³è”ã€‚ç½‘ç»œæ¥å£åªæœ‰åœ¨ç›¸åº”çš„å­—ç¬¦è®¾å¤‡è¢«ç¨‹åºæ‰“å¼€æ—¶æ‰ä¼šåˆ›å»ºï¼Œå¹¶ä¸”åœ¨å­—ç¬¦è®¾å¤‡å…³é—­æ—¶å°†è¢«åˆ é™¤ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> device <span class="keyword">struct</span> &#123;</span><br><span class="line">    n <span class="keyword">string</span></span><br><span class="line">    f *os.File</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *device)</span> <span class="title">Name</span><span class="params">()</span> <span class="title">string</span></span> &#123; <span class="keyword">return</span> d.n &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *device)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123; <span class="keyword">return</span> d.n &#125;</span><br></pre></td></tr></table></figure><p>æ–°åˆ›å»ºè®¾å¤‡æ—¶ï¼Œæˆ‘ä»¬åƒæ­£å¸¸æ‰“å¼€æ–‡ä»¶ä¸€æ ·ä½¿ç”¨ <code>TUN</code> æˆ–è€… <code>TAP</code> è®¾å¤‡ï¼Œå¦‚æœè®¾å¤‡å·²ç»è¢«å ç”¨ï¼Œåˆ™æŠ¥ <code>ErrBusy</code> é”™è¯¯ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newDevice</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="params">(Interface, error)</span></span> &#123;</span><br><span class="line">    file, err := os.OpenFile(name, os.O_EXCL|os.O_RWWR, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> isBusy(err) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, ErrBusy</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> &amp;device&#123;n: name, f: file&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isBusy</span><span class="params">(err error)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> perr, ok := err.(*os.PathError); ok &#123;</span><br><span class="line">        <span class="keyword">if</span> code, ok := perr.Err.(syscall.Errno); ok &#123;</span><br><span class="line">            <span class="keyword">if</span> code == <span class="number">0x10</span> || code == <span class="number">0x11</span> &#123;</span><br><span class="line">                <span class="comment">// device busy || exclusive lock</span></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>tunX</code> æ˜¯ <code>IP</code> éš§é“è®¾å¤‡ï¼Œå¯ç”¨äºä¸å†…æ ¸äº¤æ¢ <code>IP</code> æ•°æ®åŒ…ã€‚ä½¿ç”¨ <code>read()</code> è·å–å•ä¸ªæ•°æ®åŒ…ï¼Œä½¿ç”¨ <code>write()</code> å¯ä»¥å°†æ•°æ®åŒ…å†™å…¥ <code>/dev/tunX</code> è®¾å¤‡ä¸­ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newTUN</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="params">(Interface, error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(name) == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> i := o; i &lt; maxDevices; i++ &#123;</span><br><span class="line">            iface, err := newDevice(<span class="string">"/dev/tun"</span> + strconv.Itoa(i))</span><br><span class="line">            <span class="keyword">if</span> err == ErrBusy &#123;</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, ErrExhausted</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newDevice(name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>tapX</code> æ˜¯ <code>ethertap</code> è®¾å¤‡ï¼Œä¸ºå†…æ ¸çš„ä»¥å¤ªç½‘å±‚æä¾›æ¥å£ã€‚æ¯æ¬¡ä» <code>/dev/tapX</code> å­—ç¬¦è®¾å¤‡ä¸­è¯»å–æˆ–å†™å…¥ä¸€ä¸ªæ•°æ®åŒ…ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newTAP</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="params">(Interface, error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(name) == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> i := o; i &lt; maxDevices; i++ &#123;</span><br><span class="line">            iface, err := newDevice(<span class="string">"/dev/tap"</span> + strconv.Itoa(i))</span><br><span class="line">            <span class="keyword">if</span> err == ErrBusy &#123;</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, ErrExhausted</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newDevice(name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºå­—ç¬¦è®¾å¤‡ï¼Œå¯ä»¥åƒæ“ä½œæ­£å¸¸æ–‡ä»¶ä¸€æ ·è¿›è¡Œè¯»/å†™æ“ä½œæ¥å‘è®¾å¤‡å†™å…¥æ•°æ®åŒ…æˆ–è€…è·å–æ•°æ®åŒ…ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *device)</span> <span class="title">Read</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</span><br><span class="line">    n, err := d.f.Read(p)</span><br><span class="line">    <span class="keyword">if</span> isNotReady(err) &#123;</span><br><span class="line">        err = ErrNotReady</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *device)</span> <span class="title">Write</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</span><br><span class="line">    n, err := d.f.Write(p)</span><br><span class="line">    <span class="keyword">if</span> isNotReady(err) &#123;</span><br><span class="line">        err = ErrNotReady </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isNotReady</span><span class="params">(err error)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> perr, ok := err.(*os.PathError); ok &#123;</span><br><span class="line">        <span class="keyword">if</span> code, ok := perr.Err.(syscall.Errno); ok &#123;</span><br><span class="line">            <span class="keyword">if</span> code == <span class="number">0x05</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *device)</span> <span class="title">Close</span><span class="params">()</span> <span class="title">error</span></span> &#123; </span><br><span class="line">    <span class="keyword">return</span> d.f.Close() </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;TUNTAP&quot;&gt;&lt;a href=&quot;#TUNTAP&quot; class=&quot;headerlink&quot; title=&quot;TUNTAP&quot;&gt;&lt;/a&gt;TUNTAP&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;http://tuntaposx.sourceforge.net/&quot; target=&quot;_b
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Try Lock</title>
    <link href="https://oceanoverflow.github.io/2018/05/26/TryLock/"/>
    <id>https://oceanoverflow.github.io/2018/05/26/TryLock/</id>
    <published>2018-05-26T14:05:27.000Z</published>
    <updated>2018-05-26T14:11:36.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Try-Lock"><a href="#Try-Lock" class="headerlink" title="Try Lock"></a>Try Lock</h1><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Mutex <span class="keyword">struct</span> &#123;...&#125;</span><br><span class="line"><span class="comment">// Lock locks m. </span></span><br><span class="line"><span class="comment">// If the lock is already in use, the calling goroutine</span></span><br><span class="line"><span class="comment">//  blocks until the mutex is available.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">Lock</span><span class="params">()</span></span></span><br><span class="line"><span class="function">// <span class="title">Unlock</span> <span class="title">unlocks</span> <span class="title">m</span>. </span></span><br><span class="line"><span class="function">// <span class="title">It</span> <span class="title">is</span> <span class="title">a</span> <span class="title">run</span>-<span class="title">time</span> <span class="title">error</span> <span class="title">if</span> <span class="title">m</span> <span class="title">is</span> <span class="title">not</span> <span class="title">locked</span> <span class="title">on</span> <span class="title">entry</span> <span class="title">to</span> <span class="title">Unlock</span>. </span></span><br><span class="line"><span class="function">// </span></span><br><span class="line"><span class="function">// <span class="title">A</span> <span class="title">locked</span> <span class="title">Mutex</span> <span class="title">is</span> <span class="title">not</span> <span class="title">associated</span> <span class="title">with</span> <span class="title">a</span> <span class="title">particular</span> <span class="title">goroutine</span>. </span></span><br><span class="line"><span class="function">// <span class="title">It</span> <span class="title">is</span> <span class="title">allowed</span> <span class="title">for</span> <span class="title">one</span> <span class="title">goroutine</span> <span class="title">to</span> <span class="title">lock</span> <span class="title">a</span> <span class="title">Mutex</span> <span class="title">and</span> <span class="title">then</span></span></span><br><span class="line"><span class="function">// <span class="title">arrange</span> <span class="title">for</span> <span class="title">another</span> <span class="title">goroutine</span> <span class="title">to</span> <span class="title">unlock</span> <span class="title">it</span>.</span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="params">(m *Mutex)</span> <span class="title">Unlock</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure><p><code>sync.Mutex</code> æä¾›äº† <code>Lock</code> å’Œ <code>Unlock</code> ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«å¯¹åº”ä¸Šé”å’Œè§£é”æ“ä½œï¼Œå¦‚æœé”å·²ç»è¢«å æ®äº†ï¼Œ<code>Lock</code> æ–¹æ³•ä¼šé˜»å¡ç›¸åº”çš„ <code>goroutine</code> ã€‚åœ¨ <code>C</code> ä¸­ä¹Ÿæœ‰äº’æ–¥é”çš„å®ç°ï¼Œä½†é™¤äº†ä¸€èˆ¬çš„ä¸Šé”æ“ä½œå’Œè§£é”æ“ä½œï¼Œå®ƒè¿˜å¤šäº†ä¸€ç§æ–¹æ³• â€”â€” <code>pthread_mutex_trylock</code> ï¼Œä¹Ÿå°±æ˜¯<code>TryLock</code> ï¼Œ <code>pthread_mutex_trylock</code> è¯­ä¹‰ä¸ <code>pthread_mutex_lock</code> ç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯åœ¨é”å·²ç»è¢«å æ®æ—¶è¿”å› <code>EBUSY</code> è€Œä¸æ˜¯æŒ‚èµ·ç­‰å¾…ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="comment">// lock a mutex, If the mutex is already locked, </span></span><br><span class="line"><span class="comment">// the calling thread will block until the mutex becomes available.</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_lock</span><span class="params">(<span class="keyword">pthread_mutex_t</span> *mutex)</span></span>;</span><br><span class="line"><span class="comment">// unlock a mutex</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_unlock</span><span class="params">(<span class="keyword">pthread_mutex_t</span> *mutex)</span></span>;</span><br><span class="line"><span class="comment">// attempt to lock a mutex without blocking</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_trylock</span><span class="params">(<span class="keyword">pthread_mutex_t</span> *mutex)</span></span>;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬è‡ªå·±æ¥å®ç°ä¸€ä¸ª <code>golang</code> ç‰ˆæœ¬çš„ <code>try lock</code> ã€‚å®ç°äº’æ–¥é”çš„å…³é”®å°±åœ¨äºåŸå­æ“ä½œï¼Œä¿è¯å³ä½¿æœ‰å¤šä¸ª <code>CPU</code> å­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œä¹Ÿä¸èƒ½åŒæ—¶æ‰§è¡ŒåŒä¸€æ¡æŒ‡ä»¤ã€‚åˆ©ç”¨ <code>sync/atomic</code> åº“ä¸‹é¢çš„æ–¹æ³•å¯ä»¥è½»æ¾å®ç°å¯¹ä¸€ä¸ªæ•°çš„åŸå­æ“ä½œã€‚</p><p>æˆ‘ä»¬å®ç°çš„äº’æ–¥é”ä¸­æœ‰ä¸¤ä¸ªä¸œè¥¿ï¼Œé¦–å…ˆæ˜¯ä¸€ä¸ª <code>v int32</code> ï¼Œå› ä¸ºæ˜¯äº’æ–¥é”ï¼Œæ‰€ä»¥åˆå§‹åŒ–ä¸º1ï¼Œè¿˜æœ‰ä¸€ä¸ª <code>ch</code> é€šé“ç”¨äºå”¤é†’é˜»å¡ç­‰å¾…çš„ <code>goroutine</code> ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Mutex <span class="keyword">struct</span> &#123;</span><br><span class="line">    v <span class="keyword">int32</span></span><br><span class="line">    ch <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">Init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    m.v = <span class="number">1</span></span><br><span class="line">    m.ch = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Lock</code> æ–¹æ³•è·å–ä¸€ä¸ªé”ï¼Œå¦‚æœé”è¢«å æ®äº†ï¼Œåˆ™ä¸€ç›´é˜»å¡ç­‰å¾…( <code>&lt;-m.ch</code> )ï¼Œç­‰å¾…å…¶ä»– <code>goroutine</code> å”¤é†’ï¼Œç›¸å½“äº <code>PV</code> æ“ä½œä¸­çš„ <code>P</code> ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">Lock</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> atomic.AddInt32(&amp;m.v, <span class="number">-1</span>) == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> v := atomic.LoadInt32(&amp;m.v); v &gt;= <span class="number">0</span> &amp;&amp; atomic.SwapInt32(&amp;m.v, <span class="number">-1</span>) == <span class="number">1</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        &lt;-m.ch</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Unlock</code> æ–¹æ³•é‡Šæ”¾ <code>Mutex</code> ï¼Œå¦‚æœå½“å‰æœ‰å› ä¸ºç­‰å¾…è¯¥é”è€Œè¢«é˜»å¡çš„<code>goroutine</code> ï¼ˆè¯´æ˜ <code>atomic.SwapInt32(&amp;m.v, 1) != 0</code> ï¼‰ï¼Œåˆ™æ‰§è¡Œ <code>m.ch &lt;- struct{}{}</code> å°†é˜»å¡çš„ <code>goroutine</code> å”¤é†’ï¼Œå¯¹åº” <code>PV</code> æ“ä½œä¸­çš„ <code>V</code> ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">Unlock</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> atomic.SwapInt32(&amp;m.v, <span class="number">1</span>) == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> m.ch &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ <code>Lock</code> æ–¹æ³•ä¼šåœ¨é”å¯ç”¨ä¹‹å‰é˜»å¡è°ƒç”¨è¯¥æ–¹æ³•çš„ <code>goroutine</code> ï¼Œ<code>TryLoad</code> æ–¹æ³•å¹¶ä¸ä¼šé˜»å¡ï¼Œé€šè¿‡ <code>atomic.LoadInt32(&amp;m.v)</code> æ¥æŸ¥çœ‹å½“å‰èµ„æºæ˜¯å¦å¯ç”¨ï¼Œå¦‚æœä¸å¯ç”¨(è¯´æ˜ <code>v &lt;= 0</code> )ï¼Œåˆ™è¿”å› <code>false</code> ï¼Œå¦‚æœ <code>atomic.CompareAndSwapInt32(&amp;m.v, 1, 0)</code> è¿”å› <code>true</code> ï¼Œè¯´æ˜èµ„æºå¯ç”¨ç›´æ¥ä¸Šé”ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">TryLock</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    v := atomic.LoadInt32(&amp;m.v)</span><br><span class="line">    <span class="keyword">if</span> v &lt;= <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> atomic.CompareAndSwapInt32(&amp;m.v, <span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Try-Lock&quot;&gt;&lt;a href=&quot;#Try-Lock&quot; class=&quot;headerlink&quot; title=&quot;Try Lock&quot;&gt;&lt;/a&gt;Try Lock&lt;/h1&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td c
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Concurrent Prime Sieve</title>
    <link href="https://oceanoverflow.github.io/2018/05/25/ConcurrentPrimeSieve/"/>
    <id>https://oceanoverflow.github.io/2018/05/25/ConcurrentPrimeSieve/</id>
    <published>2018-05-25T06:36:04.000Z</published>
    <updated>2018-05-25T10:43:27.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Concurrent-Prime-Sieve"><a href="#Concurrent-Prime-Sieve" class="headerlink" title="Concurrent Prime Sieve"></a>Concurrent Prime Sieve</h1><p>æœ¬ç§‘åˆšå­¦ç¼–ç¨‹çš„æ—¶å€™ç»å¸¸é‡åˆ°åˆ¤æ–­ä¸€ä¸ªæ•°æ˜¯ä¸æ˜¯ç´ æ•°ä¹‹ç±»çš„ç¼–ç¨‹é¢˜ï¼Œå½“æ—¶åŸºç¡€æ¯”è¾ƒå·®ï¼Œç”¨çš„æ–¹æ³•ä¹Ÿç›¸å½“ç®€å•ç²—æš´ï¼Œç›´æ¥é‡‡ç”¨æšä¸¾æ³•åˆ¤æ–­ï¼Œè™½ç„¶ç®€å•ä½†æ˜¯æ•ˆç‡å¾ˆä½ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º <code>O(n^2)</code> ï¼Œåæ¥æ…¢æ…¢äº†è§£äº†ç¥å¥‡çš„åŸƒæ°ç­›æ³•ï¼Œåªç”¨ <code>O(nlglgn)</code> çš„æ—¶é—´å¤æ‚åº¦å°±å¯ä»¥å®Œæˆï¼Œæ•ˆç‡å¤§å¹…åº¦æé«˜ï¼Œå¦‚æœå¯¹åŸƒæ°ç­›ä¸äº†è§£çš„ç«¥é‹å¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç«  <a href="http://empslocal.ex.ac.uk/people/staff/mrwatkin/sieve.htm" target="_blank" rel="noopener">sieve of Eratosthenes</a>ã€‚</p><p><img src="http://empslocal.ex.ac.uk/people/staff/mrwatkin/bridge1.jpg" alt="Sieve"></p><p>ä¸€èˆ¬çš„åŸƒæ°ç­›å®ç°éƒ½æ˜¯å•çº¿ç¨‹çš„ï¼Œå¹¶ä¸èƒ½å®Œå…¨å‘æŒ¥ç°åœ¨å¤šæ ¸ <code>CPU</code> çš„å…¨éƒ¨æ€§èƒ½ï¼Œä¸‹é¢ç»™å‡ºäº† <code>Golang</code> å¹¶å‘ç‰ˆæœ¬çš„åŸƒæ°ç­›å®ç°ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generate</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">2</span> ;; i++ &#123;</span><br><span class="line">        ch &lt;- i</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">filter</span><span class="params">(in, out <span class="keyword">chan</span> <span class="keyword">int</span>, prime <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        i := &lt;-in</span><br><span class="line">        <span class="keyword">if</span> i % prime != <span class="number">0</span> &#123;</span><br><span class="line">            out &lt;- i</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    <span class="keyword">go</span> generate(ch)</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        prime := &lt;-ch</span><br><span class="line">        fmt.Println(prime)</span><br><span class="line">        out := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">        <span class="keyword">go</span> filter(ch, out, prime)</span><br><span class="line">        ch = out</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è¯¦è§£"><a href="#è¯¦è§£" class="headerlink" title="è¯¦è§£"></a>è¯¦è§£</h2><p>å¹¶å‘ç‰ˆæœ¬çš„åŸƒæ°ç­›ä»£ç è¡Œæ•°è™½ç„¶ä¸å¤šï¼Œç„¶è€Œå®ç°è¿˜æ˜¯æ¯”è¾ƒ <code>tricky</code> çš„ï¼Œè°è¦æ˜¯ç¬¬ä¸€éå°±çœ‹æ‡‚ç®—æˆ‘è¾“ï¼ˆä½ è¦æ˜¯å¤©æ‰çš„è¯å½“æˆ‘æ²¡è¯´è¿‡ï¼‰ã€‚</p><p><img src="https://talks.golang.org/2012/concurrency/images/gophereartrumpet.jpg" alt="channel"></p><p>é¦–å…ˆè¦èµ·ä¸€ä¸ª <code>goroutine</code> ï¼Œè®°ä¸º <code>G</code> ï¼Œ ç”¨äºç”Ÿæˆ2ä»¥åçš„æ•´æ•°ï¼Œå¹¶æ”¾åˆ°é€šé“ä¸­ï¼ˆè®°ä¸º <code>out0</code> ï¼‰ä¾›åˆ«çš„ <code>goroutine</code> è¯»å–ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line"><span class="keyword">go</span> generate(ch)          <span class="comment">// ch &lt;- i</span></span><br></pre></td></tr></table></figure><p>è¿›å…¥ç¬¬ä¸€ä¸ª <code>for</code> å¾ªç¯ï¼Œä»ä¸Šé¢çš„é€šé“ä¸­å–å‡ºç¬¬ä¸€ä¸ªæ•°2ï¼Œæ¯«æ— ç–‘é—®ï¼Œ2ä¸ºç´ æ•°ï¼Œæ‰€ä»¥åˆ›å»ºä¸€ä¸ªé€šé“ <code>out1</code> ï¼Œå¹¶èµ·ä¸€ä¸ª <code>goroutine</code> ï¼Œè®°ä¸º <code>filter1</code> ï¼Œç”¨äºè¿‡æ»¤æ‰€æœ‰2çš„æ•´æ•°å€çš„æ•°ï¼Œæ­¤æ—¶é€šé“æ•°æ®æµçš„èµ°å‘ä¸º <code>G -&gt; out1</code> ï¼Œåªæœ‰é€šè¿‡ <code>filter1</code> ç­›é€‰çš„æ•°æ‰æœ‰èµ„æ ¼è¿›å…¥ <code>out1</code> ä¸­ï¼Œæ­¤æ—¶å°† <code>ch</code> è®¾ä¸º <code>out1</code> ï¼ˆ <code>ch</code> ç”¨äºè®°å½•è¯¥é“¾ä¸Šçš„æœ€åä¸€ä¸ªé€šé“ï¼‰ï¼Œç¬¬ä¸€ä¸ªå¾ªç¯ç»“æŸã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">prime := &lt;-ch             <span class="comment">// &lt;-ch</span></span><br><span class="line">fmt.Println(prime)        <span class="comment">// è¾“å‡º2 </span></span><br><span class="line">out := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)     <span class="comment">// è®°ä½œout1</span></span><br><span class="line"><span class="keyword">go</span> filter(ch, out, prime) <span class="comment">// ch -&gt; out1</span></span><br><span class="line">ch = out                  <span class="comment">// ch = out1</span></span><br><span class="line">        ^</span><br><span class="line">        |</span><br><span class="line">      +----+ </span><br><span class="line">G ---&gt;|out1|---&gt;</span><br><span class="line">      +----+    </span><br><span class="line">        %<span class="number">2</span></span><br><span class="line">        ^</span><br><span class="line">        |</span><br><span class="line">        ch</span><br></pre></td></tr></table></figure><p>è¿›å…¥ç¬¬äºŒä¸ª <code>for</code> å¾ªç¯ï¼Œå› ä¸ºæ­¤æ—¶ <code>ch</code> ä¸º <code>out1</code> ï¼Œå°è¯•å» <code>out1</code> ä¸­å–ï¼Œ3ç”± <code>G</code> äº§ç”Ÿï¼Œç„¶åç»è¿‡ <code>filter1</code> åæˆåŠŸè¿›å…¥ <code>out1</code> ï¼Œè¯´æ˜3æ˜¯ç´ æ•°ï¼Œæ­¤æ—¶æˆ‘ä»¬å†åˆ›å»ºä¸€ä¸ªé€šé“ <code>out2</code> ï¼Œå¹¶ä¸”å†èµ·ä¸€ä¸ª <code>goroutine</code> ï¼Œè®°ä¸º <code>filter2</code> ï¼Œè¯¥ <code>goroutine</code> ä¼šè¿‡æ»¤æ‰€æœ‰3çš„æ•´æ•°å€çš„æ•°ï¼Œæ­¤æ—¶é€šé“æ•°æ®æµçš„èµ°å‘ä¸º <code>G -&gt; out1 -&gt; out2</code> ï¼Œåªæœ‰æˆåŠŸç»è¿‡ <code>filter1,filter2</code> ç­›é€‰çš„æ•°æ‰èƒ½è¿›å…¥é€šé“ <code>out2</code> ä¸­ï¼Œå°† <code>ch</code> è®¾ä¸º <code>out2</code> ï¼Œç¬¬äºŒä¸ªå¾ªç¯ç»“æŸã€‚å½“<code>G</code> ä¸­äº§ç”Ÿ4ï¼Œå¹¶å°è¯•åœ¨è¿™ä¸ªé“¾ä¸Šç§»åŠ¨æ—¶ï¼Œå½“å®ƒç»è¿‡ <code>filter1</code> æ—¶ï¼Œç”±äº4æ˜¯2çš„æ•´æ•°å€ï¼Œè¯´æ˜ä¸æ˜¯ç´ æ•°ï¼Œä¸ç¬¦åˆè¦æ±‚ï¼Œ4å‡ºå±€ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">prime := &lt;-ch             <span class="comment">// &lt;-out1</span></span><br><span class="line">fmt.Println(prime)        <span class="comment">// è¾“å‡º3</span></span><br><span class="line">out := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)     <span class="comment">// è®°ä½œout2</span></span><br><span class="line"><span class="keyword">go</span> filter(ch, out, prime) <span class="comment">// out1 -&gt; out2</span></span><br><span class="line">ch = out                  <span class="comment">// ch = out2</span></span><br><span class="line"></span><br><span class="line">        ^         ^</span><br><span class="line">        |         |</span><br><span class="line">      +----+    +----+    </span><br><span class="line">G ---&gt;|out1|---&gt;|out2|---&gt;</span><br><span class="line">      +----+    +----+ </span><br><span class="line">        %<span class="number">2</span>        %<span class="number">3</span></span><br><span class="line">                   ^</span><br><span class="line">                   |</span><br><span class="line">                   ch</span><br></pre></td></tr></table></figure><p>è¿›å…¥ç¬¬ä¸‰ä¸ª <code>for</code> å¾ªç¯ï¼ŒåŒæ ·çš„ï¼Œæ­¤æ—¶ <code>ch</code> ä¸º <code>out2</code> ï¼Œå°è¯•å» <code>out2</code> ä¸­å–ï¼Œ5ç”± <code>G</code> äº§ç”Ÿï¼Œç»è¿‡ <code>filter1,filter2</code> åæˆåŠŸè¿›å…¥ <code>out2</code> ï¼Œè¯´æ˜5ä¸ºç´ æ•°ï¼Œæ­¤æ—¶æˆ‘ä»¬å†åˆ›å»ºä¸€ä¸ªé€šé“ <code>out3</code> ï¼Œå¹¶ä¸”å†èµ·ä¸€ä¸ª <code>goroutine</code> ï¼Œè®°ä¸º <code>filter3</code> ï¼Œè¯¥ <code>goroutine</code> ä¼šè¿‡æ»¤æ‰€æœ‰5çš„æ•´æ•°å€çš„æ•°ï¼Œæ­¤æ—¶é€šé“æ•°æ®æµçš„èµ°å‘ä¸º <code>G -&gt; out1 -&gt; out2 -&gt; out3</code> ï¼Œåªæœ‰æˆåŠŸç»è¿‡ <code>filter1,filter2,filter3</code> ç­›é€‰çš„æ•°æ‰èƒ½è¿›å…¥é€šé“ <code>out3</code> ä¸­ï¼Œå°† <code>ch</code> è®¾ä¸º <code>out3</code> ï¼Œç¬¬ä¸‰ä¸ªå¾ªç¯ç»“æŸã€‚å½“ <code>G</code> ä¸­äº§ç”Ÿ6ï¼Œå¹¶å°è¯•åœ¨è¿™ä¸ªé“¾ä¸Šç§»åŠ¨æ—¶ï¼Œç»è¿‡ <code>filter1</code> æ—¶ï¼Œç”±äº6æ˜¯2çš„æ•´æ•°å€ï¼Œè¯´æ˜ä¸æ˜¯ç´ æ•°ï¼Œä¸ç¬¦åˆè¦æ±‚ï¼ŒåŒæ ·å‡ºå±€ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">prime := &lt;-ch             <span class="comment">// &lt;-out2</span></span><br><span class="line">fmt.Println(prime)        <span class="comment">// è¾“å‡º5</span></span><br><span class="line">out := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)     <span class="comment">// è®°ä½œout3</span></span><br><span class="line"><span class="keyword">go</span> filter(ch, out, prime) <span class="comment">// out2 -&gt; out3</span></span><br><span class="line">ch = out                  <span class="comment">// ch=out3</span></span><br><span class="line"></span><br><span class="line">        ^         ^         ^</span><br><span class="line">        |         |         |</span><br><span class="line">      +----+    +----+    +----+    </span><br><span class="line">G ---&gt;|out1|---&gt;|out2|---&gt;|out3|---&gt;</span><br><span class="line">      +----+    +----+    +----+</span><br><span class="line">        %<span class="number">2</span>        %<span class="number">3</span>        %<span class="number">5</span>        </span><br><span class="line">                            ^</span><br><span class="line">                            |</span><br><span class="line">                            ch</span><br></pre></td></tr></table></figure><p>è¿›å…¥ç¬¬å››ä¸ª <code>for</code> å¾ªç¯ï¼Œæ­¤æ—¶ <code>ch</code> ä¸º <code>out3</code> ï¼Œå°è¯•å» <code>out3</code> ä¸­å–ï¼Œ7ç”± <code>G</code> äº§ç”Ÿï¼Œç„¶åç»è¿‡ <code>filter1,filter2,filter3</code> ç­›é€‰åæˆåŠŸè¿›å…¥ <code>out3</code> ï¼Œè¯´æ˜7æ˜¯ç´ æ•°ï¼Œæ­¤æ—¶æˆ‘ä»¬å†åˆ›å»ºä¸€ä¸ªé€šé“ <code>out4</code> ï¼Œå¹¶ä¸”å†èµ·ä¸€ä¸ª <code>goroutine</code> ï¼Œè®°ä¸º <code>filter4</code> ï¼Œè¯¥ <code>goroutine</code> ä¼šè¿‡æ»¤æ‰€æœ‰7çš„æ•´æ•°å€çš„æ•°ï¼Œæ­¤æ—¶é€šé“æ•°æ®æµçš„èµ°å‘ä¸º <code>G -&gt; out1 -&gt; out2 -&gt; out3 -&gt; out4</code> ï¼Œåªæœ‰æˆåŠŸç»è¿‡ <code>filter1,filter2,filter2,filter4</code> ç­›é€‰çš„æ•°æ‰èƒ½è¿›å…¥é€šé“ <code>out4</code> ä¸­ï¼Œå°† <code>ch</code> è®¾ä¸º <code>out4</code> ï¼Œç¬¬å››ä¸ªå¾ªç¯ç»“æŸã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">prime := &lt;-ch             <span class="comment">// &lt;-out3</span></span><br><span class="line">fmt.Println(prime)        <span class="comment">// è¾“å‡º7</span></span><br><span class="line">out := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)     <span class="comment">// è®°ä½œout4</span></span><br><span class="line"><span class="keyword">go</span> filter(ch, out, prime) <span class="comment">// out3 -&gt; out4</span></span><br><span class="line">ch = out                  <span class="comment">// ch=out4</span></span><br><span class="line"></span><br><span class="line">        ^         ^         ^         ^</span><br><span class="line">        |         |         |         |</span><br><span class="line">      +----+    +----+    +----+    +----+</span><br><span class="line">G ---&gt;|out1|---&gt;|out2|---&gt;|out3|---&gt;|out4|---&gt;</span><br><span class="line">      +----+    +----+    +----+    +----+</span><br><span class="line">        %<span class="number">2</span>        %<span class="number">3</span>        %<span class="number">5</span>        %<span class="number">7</span>            </span><br><span class="line">                                      ^</span><br><span class="line">                                      |</span><br><span class="line">                                      ch</span><br></pre></td></tr></table></figure><p>ä»¥æ­¤ç±»æ¨ï¼Œå¹¶å‘ç‰ˆæœ¬ç´ æ•°ç­›çš„æœ¬è´¨å°±æ˜¯æ„å»º <code>DaisyChain</code> ï¼Œæ¯ä¸ªæ•°ç»è¿‡ <code>DaisyChain</code> å±‚å±‚ç­›é€‰åï¼Œå¦‚æœæœ€ç»ˆä¿ç•™ï¼Œè¯´æ˜è¯¥æ•°ä¸ºç´ æ•°ï¼Œä½œä¸º <code>DaisyChain</code> çš„æœ€åä¸€å±‚åŠ å…¥ï¼Œå¦‚æ­¤å¾€å¤ï¼Œå°±å¯ä»¥è¾¾åˆ°å¿«é€Ÿç­›é€‰ç´ æ•°çš„ç›®çš„äº†ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Concurrent-Prime-Sieve&quot;&gt;&lt;a href=&quot;#Concurrent-Prime-Sieve&quot; class=&quot;headerlink&quot; title=&quot;Concurrent Prime Sieve&quot;&gt;&lt;/a&gt;Concurrent Prime Sie
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Single Flight</title>
    <link href="https://oceanoverflow.github.io/2018/05/24/SingleFlight/"/>
    <id>https://oceanoverflow.github.io/2018/05/24/SingleFlight/</id>
    <published>2018-05-24T05:46:36.000Z</published>
    <updated>2018-05-24T06:06:47.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Single-Flight"><a href="#Single-Flight" class="headerlink" title="Single Flight"></a>Single Flight</h1><h2 id="SingleFlight"><a href="#SingleFlight" class="headerlink" title="SingleFlight"></a>SingleFlight</h2><p>å¾ˆå¤šäººé—²æ¥æ— äº‹å°±å–œæ¬¢åˆ·ç¥¨åœˆé€›å¾®åšï¼Œæ‰€æœ‰çš„æ¶ˆæ¯çœ‹å®Œä¸€éä¹‹åï¼Œå°±å¼€å¯ç–¯ç‹‚ä¸‹æ‹‰åˆ·æ–°æ¨¡å¼ï¼Œå¸Œæœ›èƒ½ç¬¬ä¸€æ—¶é—´çœ‹åˆ°ä»€ä¹ˆåŠ²çˆ†çš„æ¶ˆæ¯ã€‚å¯¹äºåº”ç”¨çš„ä½¿ç”¨è€…ï¼Œè¿™å€’æ²¡ä»€ä¹ˆï¼Œä½†æ˜¯å¦‚æœè¿ç»­å¤šæ¬¡ä¸‹æ‹‰åˆ·æ–°æ“ä½œéƒ½åˆ†åˆ«å¯¹åº”ä¸€æ¬¡æœåŠ¡å™¨è¯·æ±‚çš„è¯ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä¼°è®¡å°±å¾—æ‰‘è¡—äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é™åˆ¶åœ¨ä¸€å®šæ—¶é—´å†…åŒä¸€ä¸ªè¯·æ±‚çš„æ•°é‡ï¼Œä»¥é¿å…æ— ç”¨çš„è¯·æ±‚ã€‚</p><p>æˆ‘ä»¬éœ€è¦å®ç°ä¸€ç§æœºåˆ¶ï¼Œå¯¹äºç‰¹å®šçš„è¯·æ±‚ï¼Œåœ¨è¯¥è¯·æ±‚è§¦å‘ä¹‹åä½†è¿˜æ²¡æœ‰è¿”å›ç»“æœä¹‹å‰ï¼Œå¯¹äºä¹‹åæ‰€æœ‰ç›¸åŒçš„è¯·æ±‚ï¼Œæ— è®ºå¤šå°‘ä¸ªï¼Œéƒ½ä¸ä¼šçœŸæ­£è§¦å‘ï¼Œè€Œæ˜¯ç­‰å¾…ç¬¬ä¸€ä¸ªè¯·æ±‚è¿”å›ï¼Œç„¶åå…±ç”¨ä¸€ä¸ªç»“æœã€‚</p><p><code>SingleFlight</code> å°±å¯ä»¥å¸®åŠ©æˆ‘ä»¬å®ç°ä¸Šè¿°çš„è¦æ±‚ï¼Œæˆ‘ä»¬ä½¿ç”¨ç»“æ„ä½“ <code>call</code> æ¥è¡¨ç¤ºç‰¹å®šè¯·æ±‚è¿”å›çš„ç»“æœï¼Œåœ¨ <code>SingleFlight</code> ç»“æ„ä½“ä¸­ä½¿ç”¨ä¸€ä¸ª <code>map</code> æ¥å­˜å‚¨ä¸åŒçš„è¯·æ±‚ç»“æœï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªè¯·æ±‚å¯¹åº”ä¸€ä¸ª<code>call</code>ï¼Œå¹¶ç”¨é”ä¿æŠ¤ <code>map</code> çš„è¯»å†™ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> SingleFlight <span class="keyword">struct</span> &#123;</span><br><span class="line">    sync.Mutex</span><br><span class="line">    m <span class="keyword">map</span>[<span class="keyword">string</span>]*call</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> call <span class="keyword">struct</span> &#123;</span><br><span class="line">    wg  sync.WaitGroup</span><br><span class="line">    val <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">    err error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬æ¥è¯´ï¼Œ<code>call</code> æ˜¯ä¸€äº›æ‰€éœ€æ—¶é—´é•¿ï¼Œæ¶ˆè€—èµ„æºå¤šçš„æ“ä½œçš„è¿”å›ç»“æœï¼ˆä¾‹å¦‚<code>HTTP</code> è¯·æ±‚ï¼‰ã€‚<code>Do</code> æ–¹æ³•å°±ä¿è¯å¯¹äºåŒä¸€ä¸ªè¯·æ±‚ï¼Œåœ¨ç»“æœæœªè¿”å›ä¹‹å‰ï¼Œåé¢ç›¸åŒçš„è¯·æ±‚éƒ½ä¸ä¼šçœŸæ­£è¿›è¡Œï¼Œè€Œæ˜¯ç­‰å¾…ç¬¬ä¸€ä¸ªè¯·æ±‚çš„ç»“æœã€‚åœ¨å‡½æ•°è¿è¡Œæ—¶éœ€è¦æ£€æµ‹å½“å‰ <code>map</code> æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™ <code>make</code> ä¸€ä¸ªï¼Œç„¶åæ£€æŸ¥æ˜¯å¦æœ‰ç›¸åŒçš„è¯·æ±‚æ­£åœ¨è¿›è¡Œï¼Œå¦‚æœæœ‰åˆ™ä½¿ç”¨ <code>c.wg.Wait</code> æ¥ç­‰å¾…æ‰§è¡Œç»“æœã€‚è¦æ˜¯è¿™ä¸ªè¯·æ±‚æ˜¯è¯¥æ—¶é—´æ®µå†…ç¬¬ä¸€ä¸ªè¯·æ±‚ï¼Œåˆ™å°†å®ƒåŠ å…¥ <code>map</code> ä¸­ï¼Œç„¶åé€šè¿‡ <code>c.wg.Add</code> æ¥å¢åŠ  <code>WaitGroup</code> åº”è¯¥ç­‰å¾…çš„ <code>goroutine</code> ä¸ªæ•°ï¼Œå½“å‡½æ•°æ‰§è¡Œå®Œæˆä¹‹åï¼Œé€šè¿‡ <code>c.wg.Done</code> æ¥å¹¿æ’­å‘ŠçŸ¥ä»–äººï¼Œæ­¤æ—¶ä»»ä½•è°ƒç”¨<code>c.wg.Wait</code> çš„åœ°æ–¹éƒ½ä¼šè§£é™¤é˜»å¡ï¼Œå¹¶è¿”å›è¯¥ç»“æœã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sf *SingleFlight)</span> <span class="title">Do</span><span class="params">(key <span class="keyword">string</span>, fn <span class="keyword">func</span>()</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span>) <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span></span> &#123;</span><br><span class="line">    sf.Lock()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> sf.m == <span class="literal">nil</span> &#123;</span><br><span class="line">        sf.m = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*call)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> c, ok := sf.m[key]; ok &#123;</span><br><span class="line">        sf.Unlock()</span><br><span class="line">        c.wg.Wait()</span><br><span class="line">        <span class="keyword">return</span> c.val, c.err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    c := <span class="built_in">new</span>(call)</span><br><span class="line">    c.wg.Add(<span class="number">1</span>)</span><br><span class="line">    sf.m[key] = c</span><br><span class="line">    sf.Unlock()</span><br><span class="line"></span><br><span class="line">    c.val, c.err = fn()</span><br><span class="line">    c.wg.Done()</span><br><span class="line">    </span><br><span class="line">    sf.Lock()</span><br><span class="line">    <span class="built_in">delete</span>(sf.m, key)</span><br><span class="line">    sf.Unlock()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> c.val, c.err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="WaitGroup"><a href="#WaitGroup" class="headerlink" title="WaitGroup"></a>WaitGroup</h2><p><code>SingleFlight</code> æœºåˆ¶ä¸»è¦æ˜¯é  <code>WaitGroup</code> å®ç°ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå› ä¸º<code>main routine</code> ä¸ä¼šç­‰å¾… <code>goroutine</code> æ‰§è¡Œå®Œæˆï¼Œæ‰€ä»¥éœ€è¦æŸç§æœºåˆ¶ç­‰å¾…æ‰€æœ‰çš„<code>goroutine</code> æ‰§è¡Œå®Œæˆï¼Œä½¿ç”¨ <code>WaitGroup</code> å°±å¯ä»¥å¸®åŠ©æˆ‘ä»¬è¾¾åˆ°è¿™æ ·çš„ç›®çš„ã€‚</p><p><code>WaitGroup</code> çš„æœ¬è´¨å°±æ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå½“æ¯èµ·ä¸€ä¸ªæ–°çš„ <code>goroutine</code> æ—¶ï¼Œæˆ‘ä»¬è°ƒç”¨ <code>wg.Add(1)</code> æ¥å¢åŠ è®¡æ•°å™¨çš„æ•°é‡ï¼Œå½“è¯¥ <code>goroutine</code> æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œåˆ©ç”¨ <code>wg.Done()</code> å¯ä»¥å°†è®¡æ•°å™¨å‡ä¸€ï¼Œè°ƒç”¨ <code>Wait()</code> æ–¹æ³•çš„åœ°æ–¹ä¼šä¸€ç›´é˜»å¡ <code>main routine</code> ï¼Œåªæœ‰å½“è®¡æ•°å™¨ä¸º0æ—¶ï¼Œ<code>wg</code> æ‰ä¼šè§£é™¤é˜»å¡ï¼Œæ­¤æ—¶ç¨‹åºæ‰å¯ä»¥ç»§ç»­æ‰§è¡Œä¸‹å»ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> WaitGroup <span class="keyword">struct</span> &#123;</span><br><span class="line">    noCopy noCopy</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 64-bit value: high 32 bits are counter, low 32 bits are waiter count.</span></span><br><span class="line">    <span class="comment">// 64-bit atomic operations require 64-bit alignment, but 32-bit</span></span><br><span class="line">    <span class="comment">// compilers do not ensure it. So we allocate 12 bytes and then use</span></span><br><span class="line">    <span class="comment">// the aligned 8 bytes in them as state.</span></span><br><span class="line">    state1 [<span class="number">12</span>]<span class="keyword">byte</span></span><br><span class="line">    sema   <span class="keyword">uint32</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(wg *WaitGroup)</span> <span class="title">Add</span><span class="params">(delta <span class="keyword">int</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="params">(wg *WaitGroup)</span> <span class="title">Done</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="params">(wg *WaitGroup)</span> <span class="title">Wait</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"><span class="keyword">var</span> urls = []<span class="keyword">string</span>&#123;</span><br><span class="line">    <span class="string">"http://www.golang.org/"</span>,</span><br><span class="line">    <span class="string">"http://www.google.com/"</span>,</span><br><span class="line">    <span class="string">"http://www.somestupidname.com/"</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> _, url := <span class="keyword">range</span> urls &#123;</span><br><span class="line">    <span class="comment">// Increment the WaitGroup counter.</span></span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">// Launch a goroutine to fetch the URL.</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(url <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// Decrement the counter when the goroutine completes</span></span><br><span class="line">    <span class="keyword">defer</span> wg.Done() </span><br><span class="line">    <span class="comment">// Fetch the URL.</span></span><br><span class="line">    http.Get(url)</span><br><span class="line">    &#125;(url)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Wait for all HTTP fetches to complete.</span></span><br><span class="line">wg.Wait()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Single-Flight&quot;&gt;&lt;a href=&quot;#Single-Flight&quot; class=&quot;headerlink&quot; title=&quot;Single Flight&quot;&gt;&lt;/a&gt;Single Flight&lt;/h1&gt;&lt;h2 id=&quot;SingleFlight&quot;&gt;&lt;a href
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>LRU</title>
    <link href="https://oceanoverflow.github.io/2018/05/24/LRU/"/>
    <id>https://oceanoverflow.github.io/2018/05/24/LRU/</id>
    <published>2018-05-23T16:23:40.000Z</published>
    <updated>2018-05-23T16:29:58.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Least-Recently-Used"><a href="#Least-Recently-Used" class="headerlink" title="Least Recently Used"></a>Least Recently Used</h1><p>æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼ˆ <code>Least Recently Used</code> ï¼‰ä¹Ÿå°±æ˜¯ <code>LRU</code> ç®—æ³•æ˜¯å†…å­˜é¡µé¢ç½®æ¢ç®—æ³•çš„ä¸€ç§ï¼Œä½¿ç”¨è¯¥ç®—æ³•å¯ä»¥åœ¨æœ‰é™çš„èµ„æºå†…æé«˜å†…å­˜è®¿é—®çš„é€Ÿåº¦ï¼Œå®ƒåˆ©ç”¨äº†è‘—åçš„å±€éƒ¨æ€§åŸç†ï¼Œæ›´å…·ä½“çš„è¯´æ˜¯æ—¶é—´å±€éƒ¨æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœä¸€ä¸ªä¿¡æ¯é¡¹æ­£åœ¨è¢«è®¿é—®ï¼Œé‚£ä¹ˆåœ¨è¿‘æœŸå®ƒå¾ˆå¯èƒ½è¿˜ä¼šè¢«å†æ¬¡è®¿é—®ã€‚</p><p>ä¾‹å¦‚æˆ‘ä»¬æœ‰3ä¸ªç‰©ç†å—ï¼Œè®¿é—®åºåˆ—ä¸º <code>7ï¼Œ0ï¼Œ1ï¼Œ2ï¼Œ0ï¼Œ3ï¼Œ0</code></p><ul><li>è®¿é—®7æ—¶ï¼ŒLRUç¼ºå¤±ï¼Œæ­¤æ—¶LRUæœªæ»¡ï¼Œæ”¾å…¥7ï¼Œæ­¤æ—¶æ·˜æ±°é¡ºåºä¸º7</li><li>è®¿é—®0æ—¶ï¼ŒLRUç¼ºå¤±ï¼Œæ­¤æ—¶LRUæœªæ»¡ï¼Œæ”¾å…¥0ï¼Œæ­¤æ—¶æ·˜æ±°é¡ºåºä¸º7ï¼Œ0</li><li>è®¿é—®1æ—¶ï¼ŒLRUç¼ºå¤±ï¼Œæ­¤æ—¶LRUæœªæ»¡ï¼Œæ”¾å…¥1ï¼Œæ­¤æ—¶æ·˜æ±°é¡ºåºä¸º7ï¼Œ0 ï¼Œ1</li><li>è®¿é—®2æ—¶ï¼ŒLRUç¼ºå¤±ï¼Œæ­¤æ—¶LRUå·²æ»¡ï¼Œé©±é€7ï¼Œæ”¾å…¥2ï¼Œæ­¤æ—¶æ·˜æ±°é¡ºåºä¸º0ï¼Œ1ï¼Œ2</li><li>è®¿é—®0æ—¶ï¼ŒLRUå‘½ä¸­ï¼Œæ›´æ–°æ·˜æ±°é¡ºåºï¼Œæ­¤æ—¶æ·˜æ±°å¾ªåºä¸º1ï¼Œ2ï¼Œ0</li><li>è®¿é—®3æ—¶ï¼ŒLRUç¼ºå¤±ï¼Œæ­¤æ—¶LRUå·²æ»¡ï¼Œé©±é€1ï¼Œæ”¾å…¥3ï¼Œæ­¤æ—¶æ·˜æ±°é¡ºåºä¸º2ï¼Œ0ï¼Œ3</li><li>è®¿é—®0æ—¶ï¼ŒLRUå‘½ä¸­ï¼Œæ›´æ–°æ·˜æ±°é¡ºåºï¼Œæ­¤æ—¶æ·˜æ±°é¡ºåºä¸º0ï¼Œ3ï¼Œ2</li></ul><p><img src="https://i.ytimg.com/vi/4wVp97-uqr0/maxresdefault.jpg" alt="LRU"></p><p>æˆ‘ä»¬åˆ©ç”¨é“¾è¡¨ï¼ˆ <code>*list.List</code> ï¼‰ç»´æŠ¤å…¶æ·˜æ±°é¡ºåºï¼Œåˆ©ç”¨ <code>map</code> ä½œä¸ºå…¶å­˜å‚¨å¼•æ“ï¼ˆä½œä¸ºç‰©è´¨åŸºç¡€ï¼‰ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;---------------------------------------------------------&gt;</span><br><span class="line">newest                                               oldest</span><br></pre></td></tr></table></figure><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Key <span class="keyword">interface</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> entry <span class="keyword">struct</span> &#123;</span><br><span class="line">    key Key</span><br><span class="line">    value <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Cache <span class="keyword">struct</span> &#123;</span><br><span class="line">    MaxEntries <span class="keyword">int</span></span><br><span class="line">    OnEvicted  <span class="function"><span class="keyword">func</span><span class="params">(key Key, value <span class="keyword">interface</span>&#123;&#125;)</span></span></span><br><span class="line"><span class="function">    </span></span><br><span class="line"><span class="function">    <span class="title">ll</span>         *<span class="title">list</span>.<span class="title">List</span></span></span><br><span class="line"><span class="function">    <span class="title">cache</span>      <span class="title">map</span>[<span class="title">interface</span></span>&#123;&#125;]*list.Element</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(maxEntries <span class="keyword">int</span>)</span> *<span class="title">Cache</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;Cache&#123;</span><br><span class="line">        MaxEntries: maxEntries,</span><br><span class="line">        ll:         list.New(),</span><br><span class="line">        cache:      <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]*list.Element),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºæˆ‘ä»¬ç»å¸¸éœ€è¦åˆ¤æ–­å½“å‰çš„ <code>LRU</code> ç¼“å­˜æ˜¯å¦å­˜æ»¡ï¼Œæ‰€ä»¥æˆ‘ä»¬æ„é€ ä¸€ä¸ª<code>helper function</code> æ¥è·å–å½“å‰ç¼“å­˜çš„å®¹é‡ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Cache)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> c.cache == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> c.ll.Len()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ·˜æ±°é¡ºåºåœ¨ä¸¤ç§æƒ…å†µä¸‹ä¼šæ›´æ–°ï¼Œä¸€æ˜¯æ–°å¢å…ƒç´ æ—¶ï¼Œå¦‚æœå…ƒç´ åœ¨ <code>LRU</code> ç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œåˆ™å°†å®ƒæ”¾åœ¨é“¾è¡¨çš„å¤´éƒ¨ï¼ˆ <code>PushFront</code> ï¼‰ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™ç›´æ¥å°†å…¶ç§»åˆ°é“¾è¡¨çš„å¤´éƒ¨ï¼ˆ <code>MoveToFront</code> ï¼‰ã€‚äºŒæ˜¯åœ¨è·å–å…ƒç´ æ—¶ï¼Œå¦‚æœå…ƒç´ å­˜åœ¨ï¼Œåˆ™ç›´æ¥å°†å…¶ç§»åˆ°é“¾è¡¨çš„å¤´éƒ¨ï¼ˆ <code>MoveToFront</code> ï¼‰ã€‚è¿™æ ·ä¸€æ¥æˆ‘ä»¬å°±èƒ½ç¡®ä¿æœ€æ–°çš„ä¸œè¥¿åœ¨é“¾è¡¨å¤´ï¼Œæœ€è€çš„ä¸œè¥¿åœ¨é“¾è¡¨å°¾ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Cache)</span> <span class="title">Add</span><span class="params">(key Key, value interfacfe&#123;&#125;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> c.cache == <span class="literal">nil</span> &#123;</span><br><span class="line">        c.cache = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;*list.Element])</span><br><span class="line">        c.ll = list.New()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ee, ok := c.cache[key]; ok &#123;</span><br><span class="line">        c.ll.MoveToFront(ee)</span><br><span class="line">        ee.Value.(*entry).value = value</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    ele := c.ll.PushFront(&amp;entry&#123;key, value&#125;)</span><br><span class="line">    c.cache[key] = ele</span><br><span class="line">    <span class="keyword">if</span> c.MaxEntries != <span class="number">0</span> &amp;&amp; c.ll.Len() &gt; c.MaxEntries &#123;</span><br><span class="line">        c.RemoveOldest()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Cache)</span> <span class="title">Get</span><span class="params">(key Key)</span> <span class="params">(value <span class="keyword">interface</span>&#123;&#125;, ok <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> c.cache == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ele, hit := c.cache[key]; hit &#123;</span><br><span class="line">        c.ll.MoveToFront(ele)</span><br><span class="line">        <span class="keyword">return</span> ele.Value.(*entry).value, <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>RemoveOldest</code> å°†æœ€è€çš„å…ƒç´ æ·˜æ±°ï¼Œä¹Ÿå°±æ˜¯è¯´å°†é“¾è¡¨ä¸­æœ€åä¸€é¡¹ç§»é™¤ï¼Œå¹¶å°†<code>map</code> ä¸­å¯¹åº”çš„å…ƒç´ åˆ é™¤ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Cache)</span> <span class="title">RemoveOldest</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> c.cache == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    ele := c.ll.Back()</span><br><span class="line">    <span class="keyword">if</span> ele != <span class="literal">nil</span> &#123;</span><br><span class="line">        c.removeElement(ele)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Cache)</span> <span class="title">removeElement</span><span class="params">(e *list.Element)</span></span> &#123;</span><br><span class="line">    c.ll.Remove(e)</span><br><span class="line">    kv := e.Value.(*entry)</span><br><span class="line">    <span class="built_in">delete</span>(c.cache, kv.key)</span><br><span class="line">    <span class="keyword">if</span> c.OnEvicted != <span class="literal">nil</span> &#123;</span><br><span class="line">        c.OnEvicted(kv.key, kv.value)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¸…é™¤ <code>LRU</code> ç¼“å­˜åªéœ€è¦å°†é“¾è¡¨å’Œ <code>map</code> è®¾ä¸º <code>nil</code> å°±å¯ä»¥äº†ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Cache)</span> <span class="title">Clear</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> c.OnEvicted != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> _, e := <span class="keyword">range</span> c.cache &#123;</span><br><span class="line">            kv := e.Value.(*entry)</span><br><span class="line">            c.OnEvicted(kv.key, kv.value)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    c.ll = <span class="literal">nil</span></span><br><span class="line">    c.cache = <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Least-Recently-Used&quot;&gt;&lt;a href=&quot;#Least-Recently-Used&quot; class=&quot;headerlink&quot; title=&quot;Least Recently Used&quot;&gt;&lt;/a&gt;Least Recently Used&lt;/h1&gt;&lt;p&gt;æœ€è¿‘
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Heartbeat</title>
    <link href="https://oceanoverflow.github.io/2018/05/23/Heartbeat/"/>
    <id>https://oceanoverflow.github.io/2018/05/23/Heartbeat/</id>
    <published>2018-05-23T09:52:18.000Z</published>
    <updated>2018-06-08T14:19:26.927Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Heartbeat"><a href="#Heartbeat" class="headerlink" title="Heartbeat"></a>Heartbeat</h1><p>åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼é›†ç¾¤ä¸­ï¼Œä¸ªåˆ«èŠ‚ç‚¹å‡ºç°å®•æœºçš„æƒ…å†µå¹¶ä¸å°‘è§ï¼Œä¾‹å¦‚åœ¨ä¸€ä¸ªåªæœ‰ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œå’Œå¤šä¸ªä»èŠ‚ç‚¹çš„é›†ç¾¤ä¸­ï¼Œä»èŠ‚ç‚¹å‘ç”Ÿå®•æœºå¯¹æ•´ä¸ªç³»ç»Ÿå½±å“å€’ä¸ç®—å¤ªå¤§ï¼Œå¦‚æœä¸»èŠ‚ç‚¹å®•æœºï¼Œç³»ç»Ÿå°†ä¸èƒ½æ­£å¸¸è¿è¡Œï¼Œæ‰€ä»¥å¿…é¡»æœ‰ä¸€ä¸ªæœºåˆ¶æ£€æµ‹å„ä¸ªèŠ‚ç‚¹æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚</p><p>å¿ƒè·³æœºåˆ¶æ˜¯è®¾è®¡é«˜å¯ç”¨æ€§åˆ†å¸ƒå¼ç³»ç»Ÿçš„é‡è¦æŠ€æœ¯ã€‚å¿ƒè·³æœºåˆ¶é€šè¿‡å‘¨æœŸæ€§åœ°å‘å…¶ä»–èŠ‚ç‚¹å‘é€å¿ƒè·³æ¶ˆæ¯å¹¶ç­‰å¾…ç¡®è®¤æ¥æ£€æµ‹é›†ç¾¤ä¸­çš„èŠ‚ç‚¹çŠ¶æ€ã€‚å½“èŠ‚ç‚¹çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šé€šçŸ¥å‘é€å¿ƒè·³æ£€æµ‹æ¶ˆæ¯çš„èŠ‚ç‚¹ã€‚å¦‚æœå‘é€å¿ƒè·³æ£€æµ‹æ¶ˆæ¯çš„èŠ‚ç‚¹åœ¨ä¸€æ®µæ—¶é—´å†…æœªæ”¶åˆ°ç¡®è®¤ï¼Œåˆ™è¯¥èŠ‚ç‚¹å°†è¢«è§†ä¸ºå¤±è´¥ã€‚è¿™æ˜¯å¿ƒè·³æœºåˆ¶çš„åŸºæœ¬åŸç†ã€‚</p><p>åœ¨è®¾è®¡å¿ƒè·³æ—¶ï¼Œéœ€è¦è€ƒè™‘å¿ƒè·³æ˜¯å•å‘ï¼Œè¿˜æ˜¯åŒå‘çš„ï¼Œå•å‘çš„å¿ƒè·³å¯ä»¥ä¿è¯å½“å‘é€æ–¹å‡ºç°é—®é¢˜æ—¶ï¼Œæ¥æ”¶æ–¹åœ¨ä¸€å®šçš„æ—¶é—´å†…å¯ä»¥æ£€æµ‹åˆ°ï¼Œè€ŒåŒå‘åˆ™å¯ä»¥ä¿è¯åŒæ–¹éƒ½å¯ä»¥æ£€æµ‹åˆ°å¯¹æ–¹æ˜¯å¦å‡ºç°é—®é¢˜ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªå•å‘çš„å¿ƒè·³æ£€æµ‹æœºåˆ¶ï¼Œè¿™é‡Œå­˜åœ¨ä¸€ä¸ªä¸»èŠ‚ç‚¹å’Œå¤šä¸ªä»èŠ‚ç‚¹ï¼Œä¸»èŠ‚ç‚¹ä¼šå‘è¿æ¥åˆ°è‡ªå·±çš„ä»èŠ‚ç‚¹å®šæœŸå‘é€å¿ƒè·³æ¶ˆæ¯ï¼Œå¦‚æœä»èŠ‚ç‚¹åœ¨è§„å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°æ¥è‡ªä¸»èŠ‚ç‚¹çš„å¿ƒè·³æ¶ˆæ¯ï¼Œåˆ™è®¤ä¸ºä¸»èŠ‚ç‚¹å‘ç”Ÿå¼‚å¸¸ï¼Œç„¶åè¿›è¡Œç›¸åº”çš„è¶…æ—¶å¤„ç†æµç¨‹ï¼ˆå¦‚è‡ªå·±å‚ä¸é€‰ä¸¾æˆä¸ºä¸»èŠ‚ç‚¹ç­‰ï¼‰ã€‚</p><h2 id="Master"><a href="#Master" class="headerlink" title="Master"></a>Master</h2><p>åœ¨ä¸»èŠ‚ç‚¹ä¸­æˆ‘ä»¬ç»´æŠ¤è¿æ¥åˆ°ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œä½¿ç”¨ç”¨ä¸€ä¸ªæ•°ç»„ä¿å­˜ï¼Œå½“èŠ‚ç‚¹åŠ å…¥æˆ–è€…é€€å‡ºç³»ç»Ÿæ—¶å€™ï¼Œåˆ†åˆ«è°ƒç”¨ <code>Add</code> å’Œ <code>Del</code> æ–¹æ³•è¿›è¡Œå¢åˆ ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Master <span class="keyword">struct</span> &#123;</span><br><span class="line">    sync.RWMutex</span><br><span class="line">    n      <span class="keyword">int</span></span><br><span class="line">    slaves []*Slave</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Master)</span> <span class="title">Add</span><span class="params">(s *Slave)</span></span> &#123;</span><br><span class="line">    s.Lock()</span><br><span class="line">    <span class="keyword">defer</span> s.Unlock()</span><br><span class="line">    s.n++</span><br><span class="line">    s.slaves = <span class="built_in">append</span>(s.slaves, s)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Master)</span> <span class="title">Del</span><span class="params">(s *Slave)</span></span> &#123;</span><br><span class="line">    s.Lock()</span><br><span class="line">    <span class="keyword">defer</span> s.Unlock()</span><br><span class="line">    n := <span class="built_in">make</span>([]*Slave, <span class="built_in">len</span>(s.slaves)<span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">for</span> _, x := <span class="keyword">range</span> m.slaves &#123;</span><br><span class="line">        <span class="keyword">if</span> x != s &#123;</span><br><span class="line">            n = <span class="built_in">append</span>(n, x)</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">    s.n--</span><br><span class="line">    s.slaves = n</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€æ—¦ä»èŠ‚ç‚¹ä¸ä¸»èŠ‚ç‚¹å»ºç«‹è¿æ¥ï¼Œä¸»èŠ‚ç‚¹ä¼šé€šè¿‡ <code>heartbeatLoop</code> å‘ä»èŠ‚ç‚¹å®šæ—¶å‘é€å¿ƒè·³æ¶ˆæ¯ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Master)</span> <span class="title">handleConn</span><span class="params">(conn net.Conn)</span></span> &#123;</span><br><span class="line">    s := &amp;slave&#123;</span><br><span class="line">        conn: conn,</span><br><span class="line">        connectTime: time.Now()</span><br><span class="line">    &#125;</span><br><span class="line">    m.Add(s)</span><br><span class="line">    log.Println(<span class="string">"Connected: "</span>, conn.RemoteAddr)</span><br><span class="line">    <span class="keyword">go</span> s.heartbeatLoop()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Slave"><a href="#Slave" class="headerlink" title="Slave"></a>Slave</h2><p><code>slave</code> æ˜¯ä¸»èŠ‚ç‚¹ç»´æŠ¤çš„ä»èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œ<code>connectTime</code> è¡¨ç¤ºä»èŠ‚ç‚¹ç¬¬ä¸€æ¬¡è¿æ¥çš„æ—¶é—´ï¼Œ<code>exit chan struct{}</code> ç”¨äºæ¥æ”¶é€€å‡ºä¿¡å·ï¼Œä¾‹å¦‚å½“ä»èŠ‚ç‚¹é€€å‡ºè¯¥é›†ç¾¤æ—¶æˆ–è€…ä»èŠ‚ç‚¹å‘ç”Ÿå®•æœºæ—¶ï¼Œé€šè¿‡è¯¥æœºåˆ¶åœæ­¢å‘ä»èŠ‚ç‚¹å‘é€å¿ƒè·³ä¿¡æ¯ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> slave <span class="keyword">struct</span> &#123;</span><br><span class="line">    sync.RWMutex</span><br><span class="line">    conn        net.Conn</span><br><span class="line">    connectTime time.Time</span><br><span class="line">    exit        <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>hearbeatLoop</code> æ–¹æ³•ä¸­ï¼Œé€šè¿‡ <code>time.NewTicker</code> æ¥è®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ï¼Œæ¯éš”ä¸€ç§’é’Ÿå‘ä»èŠ‚ç‚¹å‘é€å¿ƒè·³æ¶ˆæ¯ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *slave)</span> <span class="title">heartbeatLoop</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ticker := time.NewTicker(<span class="number">1</span> * time.Second)</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        s.conn.Close()</span><br><span class="line">        ticker.Stop()</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> t := &lt;-ticker.C:</span><br><span class="line">            s.Lock()</span><br><span class="line">            c.conn.Write([]<span class="keyword">byte</span>(fmt.Sprintf(<span class="string">"heartbeat %d"</span>, time.Now())))</span><br><span class="line">            s.Unlock()</span><br><span class="line">        <span class="keyword">case</span> &lt;-s.exit:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *slave)</span> <span class="title">stop</span><span class="params">()</span></span> &#123;</span><br><span class="line">    s.exit &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Main-Routine"><a href="#Main-Routine" class="headerlink" title="Main Routine"></a>Main Routine</h2><h2 id="master-main"><a href="#master-main" class="headerlink" title="master main"></a>master main</h2><p>ä¸»èŠ‚ç‚¹é€šè¿‡ç›‘å¬ç›¸åº”çš„ç«¯å£ï¼Œå¤„ç†ä¸è‡ªå·±è¿æ¥çš„è¯·æ±‚ï¼Œå¯¹äºæ¯ä¸ªè¿æ¥è¯·æ±‚ï¼Œéƒ½ä¼šèµ·ä¸€ä¸ªæ–°çš„ <code>goroutine</code> åˆ†åˆ«å¤„ç†ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    l, err := net.Listen(<span class="string">"tcp"</span>, <span class="string">":8080"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> l.Close()</span><br><span class="line">    m := &amp;Master&#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        conn, err := l.Accept()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            log.Fatal(err)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">go</span> m.handleConnection(conn)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="slave-main"><a href="#slave-main" class="headerlink" title="slave main"></a>slave main</h2><p>ä»èŠ‚ç‚¹ä¼šæ¥æ”¶æ¥è‡ªä¸»èŠ‚ç‚¹çš„å¿ƒè·³æ¶ˆæ¯ï¼Œå¹¶é€šè¿‡ <code>time.NewTimer</code> æ¥è®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ï¼Œå¦‚æœåœ¨è§„å®šçš„æ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°æ¥è‡ªä¸»èŠ‚ç‚¹çš„æ¶ˆæ¯ï¼Œåˆ™è¯´æ˜å¿ƒè·³è¶…æ—¶ï¼Œæ€€ç–‘ä¸»èŠ‚ç‚¹å‡ºç°å¼‚å¸¸ï¼Œå¦‚æœåœ¨è§„å®šçš„æ—¶é—´å†…æ”¶åˆ°å¿ƒè·³æ¶ˆæ¯ï¼Œåˆ™é€šè¿‡<code>timer.Reset</code> æ¥é‡ç½®å®šæ—¶å™¨ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¿ƒè·³è¶…æ—¶çš„æ—¶é—´æ˜¯å¿ƒè·³å‘é€å‘¨æœŸçš„3å€å·¦å³ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    conn, err := net.Dial(<span class="string">"tcp"</span>, <span class="string">"localhost:8080"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    timer := time.NewTimer(<span class="number">3</span> * time.Second)</span><br><span class="line"></span><br><span class="line">    msgChan := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(conn net.Conn)</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">            b := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">100</span>)</span><br><span class="line">            n, err := conn.Read(b)</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="built_in">panic</span>(err)</span><br><span class="line">            &#125;</span><br><span class="line">            msgChan &lt;- <span class="keyword">string</span>(b[:n])</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;(conn)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> m := &lt;-msgChan:</span><br><span class="line">            fmt.Println(m)</span><br><span class="line">        <span class="keyword">case</span> &lt;-timer.C:</span><br><span class="line">            fmt.Println(<span class="string">"Timed out"</span>)</span><br><span class="line">            <span class="comment">// do something here</span></span><br><span class="line">            &lt;-msgChan</span><br><span class="line">        &#125;</span><br><span class="line">        timer.Reset(<span class="number">3</span> * time.Second)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Randomized-Timeout"><a href="#Randomized-Timeout" class="headerlink" title="Randomized Timeout"></a>Randomized Timeout</h2><p>ä¸Šé¢ä½¿ç”¨çš„è®¡æ—¶å™¨çš„æ—¶é—´é—´éš”éƒ½æ˜¯ç›¸åŒçš„ï¼Œä½†æ˜¯åœ¨å¾ˆå¤šå·¥ç¨‹é¡¹ç›®ä¾‹å¦‚ <code>Raft</code> ä¸­ï¼Œå¸¸å¸¸ä½¿ç”¨ <code>Randomized Timeout</code> è¿™ç§å¥‡æŠ€æ·«å·§æ¥å‡å°‘ <code>split votes</code> æƒ…å†µçš„å‘ç”Ÿã€‚ä½¿ç”¨éšæœºè¶…æ—¶æˆ‘ä»¬éœ€è¦è‡ªå·±å®šä¹‰ä¸€ä¸ª <code>var timeout &lt;-chan time.Time</code> ï¼Œæ¯æ¬¡é‡ç½®è®¡æ—¶å™¨æ—¶ï¼ˆä¾‹å¦‚æ”¶åˆ°å¿ƒè·³æ¶ˆæ¯æˆ–è€…è®¡æ—¶å™¨è¶…æ—¶ï¼‰ï¼Œå…ˆå°†ç›¸åº”çš„ <code>timeout</code> è®¾ç½®ä¸º <code>nil</code> ï¼Œç„¶åè·å–ä¸€ä¸ªéšæœºçš„æ—¶é—´é—´éš”ï¼Œå¹¶ä½¿ç”¨ <code>time.After</code> æ¥è·å¾—ä¸€ä¸ªæ–°çš„è®¡æ—¶å™¨ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    rand.Seed(time.Now().UTC().UnixNano())</span><br><span class="line">    ticker := time.NewTicker(<span class="number">250</span> * time.Millisecond)</span><br><span class="line">    <span class="keyword">defer</span> ticker.Stop()</span><br><span class="line">    appendEntries := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="keyword">range</span> ticker.C &#123;</span><br><span class="line">            appendEntries &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> timeout &lt;-<span class="keyword">chan</span> time.Time</span><br><span class="line">    <span class="keyword">for</span> &#123;  </span><br><span class="line">        <span class="keyword">if</span> timeout == <span class="literal">nil</span> &#123;</span><br><span class="line">            timeout = time.After(time.Duration(r(<span class="number">150</span>, <span class="number">300</span>)) * time.Millisecond)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> m := &lt;-appendEntries:</span><br><span class="line">            timeout = <span class="literal">nil</span></span><br><span class="line">            fmt.Println(<span class="string">"received a message"</span>)</span><br><span class="line">            <span class="comment">// process(m)</span></span><br><span class="line">        <span class="keyword">case</span> &lt;-timeout:</span><br><span class="line">            timeout = <span class="literal">nil</span></span><br><span class="line">            fmt.Println(<span class="string">"convert to candidate"</span>)</span><br><span class="line">            <span class="comment">// do something such as election</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">r</span><span class="params">(min, max <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> rand.Intn(max-min) + min</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Heartbeat&quot;&gt;&lt;a href=&quot;#Heartbeat&quot; class=&quot;headerlink&quot; title=&quot;Heartbeat&quot;&gt;&lt;/a&gt;Heartbeat&lt;/h1&gt;&lt;p&gt;åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼é›†ç¾¤ä¸­ï¼Œä¸ªåˆ«èŠ‚ç‚¹å‡ºç°å®•æœºçš„æƒ…å†µå¹¶ä¸å°‘è§ï¼Œä¾‹å¦‚åœ¨ä¸€ä¸ªåªæœ‰ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œå’Œå¤šä¸ª
      
    
    </summary>
    
    
  </entry>
  
</feed>
